<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AIËÅäÂ§©Âä©Êâã - ÊîØÊåÅ‰∏ä‰∏ãÊñáË∞ÉËäÇ‰∏éÁæ§ËÅä</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        /* ÂÖ®Â±ÄÈáçÁΩÆÂíåÂü∫Á°ÄÊ†∑Âºè */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", "Helvetica Neue", Helvetica, Arial, sans-serif;
            background-color: #ededed;
            height: 100vh;
            overflow: hidden;
            position: relative;
        }

        /* Áä∂ÊÄÅÊ†è */
        .status-bar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 44px;
            background-color: #ededed;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 15px;
            z-index: 1000;
            font-size: 14px;
        }

        .status-left {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .status-right {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        /* ‰∏ªÂÆπÂô® */
        .main-container {
            height: 100vh;
            display: flex;
            flex-direction: column;
            padding-top: 44px; /* ÁïôÂá∫Áä∂ÊÄÅÊ†èÁ©∫Èó¥ */
            padding-bottom: 50px; /* ÁïôÂá∫Â∫ïÈÉ®ÂØºËà™Á©∫Èó¥ */
        }

        /* ËÅîÁ≥ª‰∫∫ÂàóË°®È°µÈù¢ */
        .contact-list-page {
            flex: 1;
            background-color: #fff;
            overflow-y: auto;
        }

        .wechat-header {
            background-color: #ededed;
            padding: 10px 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid #e5e5e5;
        }

        .header-title {
            font-size: 17px;
            font-weight: 500;
        }

        .header-actions {
            display: flex;
            gap: 20px;
        }

        .header-icon {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .search-bar {
            padding: 8px 15px;
            background-color: #ededed;
        }

        .search-input {
            width: 100%;
            height: 32px;
            background-color: #fff;
            border: none;
            border-radius: 4px;
            padding: 0 10px;
            font-size: 14px;
        }

        /* ËÅîÁ≥ª‰∫∫È°πÁõÆ */
        .contact-item {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            background-color: #fff;
            border-bottom: 0.5px solid #e5e5e5;
            cursor: pointer;
            position: relative;
        }

        .contact-item:active {
            background-color: #d9d9d9;
        }

        .contact-avatar {
            width: 48px;
            height: 48px;
            border-radius: 4px;
            margin-right: 12px;
            background-color: #07c160;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 20px;
            flex-shrink: 0;
            overflow: hidden;
        }

        .contact-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .contact-info {
            flex: 1;
            overflow: hidden;
        }

        .contact-name {
            font-size: 17px;
            color: #000;
            margin-bottom: 4px;
        }

        .contact-message {
            font-size: 13px;
            color: #999;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .contact-time {
            position: absolute;
            right: 15px;
            top: 15px;
            font-size: 12px;
            color: #b2b2b2;
        }

        /* ËÅäÂ§©È°µÈù¢ */
        .chat-page {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 50px;
            background-color: #ededed;
            display: flex;
            flex-direction: column;
            transform: translateX(100%);
            transition: transform 0.3s ease;
            z-index: 100;
            overflow: hidden; /* Èò≤Ê≠¢ËÆ∞ÂøÜÈù¢ÊùøÊ∫¢Âá∫ */
        }

        .chat-page.active {
            transform: translateX(0);
        }

        .chat-header {
            background-color: #ededed;
            padding: 44px 15px 10px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 0.5px solid #d9d9d9;
            flex-shrink: 0;
            position: relative;
            z-index: 3; /* ÊèêÈ´òheaderÂ±ÇÁ∫ß */
        }

        .back-btn {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 17px;
            color: #576b95;
            cursor: pointer;
        }

        .chat-title {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            font-size: 17px;
            font-weight: 500;
        }
        
        .chat-header-actions {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .chat-more, .memory-btn {
            width: 24px;
            height: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            font-weight: bold;
        }

        /* ËÅäÂ§©Ê∂àÊÅØÂå∫Âüü */
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            -webkit-overflow-scrolling: touch;
        }

        .message {
            display: flex;
            margin-bottom: 15px;
            align-items: flex-start;
        }

        .message.sent {
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 4px;
            margin: 0 10px;
            background-color: #07c160;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 16px;
            flex-shrink: 0;
            overflow: hidden;
        }

        .message-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .message-bubble {
            max-width: 70%;
            position: relative;
        }

        .message-content {
            padding: 10px 12px;
            border-radius: 8px;
            font-size: 16px;
            line-height: 1.5;
            word-wrap: break-word;
            position: relative;
        }

        .message.received .message-content {
            background-color: #fff;
            color: #000;
        }

        .message.sent .message-content {
            background-color: #95ec69;
            color: #000;
        }

        /* Ê∂àÊÅØÊ∞îÊ≥°Â∞èÂ∞æÂ∑¥ */
        .message-content::before {
            content: '';
            position: absolute;
            top: 10px;
            width: 0;
            height: 0;
            border-style: solid;
        }

        .message.received .message-content::before {
            left: -5px;
            border-width: 6px 6px 6px 0;
            border-color: transparent #fff transparent transparent;
        }

        .message.sent .message-content::before {
            right: -5px;
            border-width: 6px 0 6px 6px;
            border-color: transparent transparent transparent #95ec69;
        }

        .message-emoji {
            max-width: 100px;
            max-height: 100px;
            border-radius: 8px;
            display: block;
        }
        
        /* Á∫¢ÂåÖÊ†∑Âºè */
        .message-content.red-packet {
            background-color: #fa9d3b;
            color: white;
            padding: 0;
            width: 240px;
            cursor: pointer;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .red-packet-body {
            display: flex;
            align-items: center;
            padding: 12px;
        }
        
        .red-packet-icon {
            width: 40px;
            height: 40px;
            margin-right: 10px;
        }
        
        .red-packet-text {
            flex: 1;
        }

        .red-packet-text div:first-child {
            font-size: 15px;
            font-weight: 500;
            margin-bottom: 2px;
        }
        
        .red-packet-text div:last-child {
            font-size: 14px;
        }
        
        .red-packet-footer {
            background-color: white;
            color: #999;
            font-size: 12px;
            padding: 4px 12px;
            border-top: 0.5px solid rgba(0,0,0,0.05);
        }

        .message.sent .message-content.red-packet::before {
            border-color: transparent transparent transparent #fa9d3b;
        }
        
        /* ËæìÂÖ•Âå∫Âüü */
        .chat-input-area {
            background-color: #f7f7f7;
            border-top: 0.5px solid #d9d9d9;
            padding: 8px 10px;
            display: flex;
            align-items: flex-end;
            gap: 8px;
            flex-shrink: 0;
            position: relative;
            z-index: 2;
        }

        .input-actions {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .action-btn {
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border-radius: 50%;
            background-color: #fff;
            font-size: 20px;
        }

        .chat-input {
            flex: 1;
            min-height: 36px;
            max-height: 120px;
            padding: 8px 12px;
            border: none;
            border-radius: 4px;
            background-color: #fff;
            font-size: 16px;
            resize: none;
            outline: none;
        }

        .send-btn {
            padding: 8px 16px;
            background-color: #07c160;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
        }

        .send-btn:active {
            background-color: #06a652;
        }

        .send-btn:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        /* ËÆ∞ÂøÜË°®Ê†ºÈù¢Êùø */
        .memory-panel {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #f7f7f7;
            z-index: 4;
            transform: translateY(100%);
            transition: transform 0.3s ease-in-out;
            overflow-y: auto; /* Allow the whole panel to scroll */
            -webkit-overflow-scrolling: touch;
        }

        .memory-panel.active {
            transform: translateY(0);
        }

        .memory-panel-header {
            padding: 44px 15px 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #ededed;
            border-bottom: 0.5px solid #d9d9d9;
            position: sticky; /* Make header sticky */
            top: 0;
            z-index: 1;
        }
        
        .memory-panel-title {
            font-size: 17px;
            font-weight: 500;
        }

        .memory-panel-actions {
            display: flex;
            gap: 15px;
        }

        .memory-panel-btn {
            font-size: 16px;
            color: #576b95;
            cursor: pointer;
            background: none;
            border: none;
            padding: 5px;
        }

        .memory-panel-content {
            padding: 15px;
        }

        .memory-textarea {
            width: 100%;
            height: calc(100vh - 150px); /* Adjust height to fill available space */
            border: 1px solid #ddd;
            border-radius: 4px;
            outline: none;
            resize: none;
            font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, Courier, monospace;
            font-size: 14px;
            line-height: 1.6;
            background-color: #fff;
            color: #333;
            padding: 10px;
        }
        
        /* Ê∏≤ÊüìÂêéÁöÑË°®Ê†ºÊ†∑Âºè */
        .memory-table-view {
            font-size: 14px;
            line-height: 1.6;
            color: #333;
            word-wrap: break-word;
        }
        .memory-table-view h1,
        .memory-table-view h2,
        .memory-table-view h3 {
            margin-top: 1.2em;
            margin-bottom: 0.6em;
            font-weight: 600;
            border-bottom: 1px solid #eee;
            padding-bottom: 0.3em;
        }
        .memory-table-view h1 { font-size: 1.6em; }
        .memory-table-view h2 { font-size: 1.4em; }
        .memory-table-view h3 { font-size: 1.2em; }
        .memory-table-view ul {
            padding-left: 20px;
            margin-bottom: 1em;
        }
        .memory-table-view table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 1em;
            border: 1px solid #ddd;
        }
        .memory-table-view th,
        .memory-table-view td {
            border: 1px solid #ddd;
            padding: 8px 12px;
            text-align: left;
        }
        .memory-table-view th {
            background-color: #f2f2f2;
            font-weight: 600;
        }
        .memory-table-view tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        .memory-table-view p {
            margin-bottom: 1em;
        }
        .memory-table-view hr {
            border: none;
            border-top: 2px solid #eee;
            margin: 1.5em 0;
        }

        /* Â∫ïÈÉ®ÂØºËà™Ê†è */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 50px;
            background-color: #f7f7f7;
            border-top: 0.5px solid #d9d9d9;
            display: flex;
            justify-content: space-around;
            align-items: center;
            z-index: 200;
        }

        .nav-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 2px;
            cursor: pointer;
            position: relative;
        }

        .nav-icon {
            width: 24px;
            height: 24px;
        }

        .nav-text {
            font-size: 10px;
            color: #999;
        }

        .nav-item.active .nav-text {
            color: #07c160;
        }

        /* ÊúãÂèãÂúàÈ°µÈù¢ */
        .moments-page {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 50px;
            background-color: #f5f5f5;
            display: flex;
            flex-direction: column;
            transform: translateX(100%);
            transition: transform 0.3s ease;
            z-index: 120;
        }

        .moments-page.active {
            transform: translateX(0);
        }

        .moments-header {
            background-color: #ededed;
            padding: 44px 15px 10px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 0.5px solid #d9d9d9;
            flex-shrink: 0;
        }

        .moments-content {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
        }

        .moments-empty {
            text-align: center;
            padding: 50px 20px;
            color: #999;
        }

        .moments-empty-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }

        .moments-empty-text {
            font-size: 16px;
            margin-bottom: 20px;
        }

        .moments-empty-btn {
            background-color: #07c160;
            color: white;
            border: none;
            border-radius: 20px;
            padding: 10px 20px;
            font-size: 14px;
            cursor: pointer;
        }

        .moments-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .moment-item {
            background-color: #fff;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .moment-header {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        .moment-avatar {
            width: 40px;
            height: 40px;
            border-radius: 4px;
            margin-right: 10px;
            background-color: #07c160;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 16px;
            overflow: hidden;
        }

        .moment-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .moment-info {
            flex: 1;
        }

        .moment-name {
            font-size: 16px;
            font-weight: 500;
            margin-bottom: 2px;
        }

        .moment-time {
            font-size: 12px;
            color: #999;
        }

        .moment-content {
            font-size: 15px;
            line-height: 1.5;
            margin-bottom: 10px;
        }

        .moment-image {
            width: 100%;
            max-width: 300px;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        /* ÂèëÂ∏ÉÊúãÂèãÂúàÊ®°ÊÄÅÊ°Ü */
        .publish-moment-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0,0,0,0.5);
            z-index: 2000;
        }

        .publish-moment-content {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: white;
            border-radius: 12px 12px 0 0;
            max-height: 80vh;
            overflow-y: auto;
            animation: slideUp 0.3s ease;
        }

        .publish-moment-header {
            padding: 15px;
            border-bottom: 0.5px solid #e5e5e5;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .publish-moment-title {
            font-size: 17px;
            font-weight: 500;
        }

        .publish-moment-close {
            font-size: 14px;
            color: #576b95;
            cursor: pointer;
        }

        .publish-moment-body {
            padding: 15px;
        }

        .generate-moment-section {
            text-align: center;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .generate-moment-btn {
            background-color: #07c160;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px 24px;
            font-size: 16px;
            cursor: pointer;
            margin-bottom: 10px;
        }

        .generate-moment-hint {
            font-size: 14px;
            color: #666;
            line-height: 1.5;
        }

        .moment-preview {
            display: none;
            border: 1px solid #e5e5e5;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            background-color: #f8f9fa;
        }

        .moment-preview-title {
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 10px;
            color: #333;
        }

        .moment-preview-content {
            font-size: 15px;
            line-height: 1.5;
            margin-bottom: 10px;
        }

        .moment-preview-image {
            width: 100%;
            max-width: 200px;
            border-radius: 8px;
        }

        .unsplash-key-section {
            margin-bottom: 20px;
        }

        .unsplash-key-label {
            font-size: 14px;
            color: #333;
            margin-bottom: 8px;
            display: block;
        }

        .unsplash-key-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #e5e5e5;
            border-radius: 4px;
            font-size: 16px;
            outline: none;
        }

        .unsplash-key-input:focus {
            border-color: #07c160;
        }

        .publish-moment-submit {
            width: 100%;
            padding: 12px;
            background-color: #07c160;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            cursor: pointer;
        }

        .publish-moment-submit:active {
            background-color: #06a652;
        }

        .publish-moment-submit:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        /* Ê®°ÊÄÅÊ°Ü */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0,0,0,0.5);
            z-index: 2000;
        }

        .modal-content {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: white;
            border-radius: 12px 12px 0 0;
            max-height: 80vh;
            overflow-y: auto;
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from {
                transform: translateY(100%);
            }
            to {
                transform: translateY(0);
            }
        }

        .modal-header {
            padding: 15px;
            border-bottom: 0.5px solid #e5e5e5;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 17px;
            font-weight: 500;
        }

        .modal-close {
            font-size: 14px;
            color: #576b95;
            cursor: pointer;
        }

        .modal-body {
            padding: 15px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-label {
            font-size: 14px;
            color: #000;
            margin-bottom: 8px;
            display: block;
        }

        .form-input, .form-textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #e5e5e5;
            border-radius: 4px;
            font-size: 16px;
            outline: none;
        }

        .form-input:focus, .form-textarea:focus {
            border-color: #07c160;
        }

        .form-textarea {
            min-height: 80px;
            resize: vertical;
        }

        .form-submit {
            width: 100%;
            padding: 12px;
            background-color: #07c160;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            cursor: pointer;
        }

        .form-submit:active {
            background-color: #06a652;
        }

        /* Ë°®ÊÉÖÈù¢Êùø */
        .emoji-panel {
            display: none;
            position: absolute;
            bottom: 100%;
            left: 0;
            right: 0;
            background-color: #f7f7f7;
            border-top: 0.5px solid #e5e5e5;
            max-height: 250px;
            overflow-y: auto;
            margin-bottom: 8px;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
        }

        .emoji-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            padding: 10px;
        }

        .emoji-item {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #fff;
            border-radius: 8px;
            cursor: pointer;
            overflow: hidden;
            position: relative;
        }

        .emoji-item:active {
            background-color: #e5e5e5;
        }

        .emoji-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .emoji-delete-btn {
            position: absolute;
            top: 2px;
            right: 2px;
            width: 20px;
            height: 20px;
            background-color: rgba(255, 0, 0, 0.8);
            color: white;
            border-radius: 50%;
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            cursor: pointer;
        }

        .emoji-item:hover .emoji-delete-btn {
            display: flex;
        }

        .add-emoji-btn {
            grid-column: span 4;
            padding: 10px;
            background-color: #fff;
            border: 1px dashed #07c160;
            border-radius: 8px;
            color: #07c160;
            text-align: center;
            cursor: pointer;
        }

        /* ËÆæÁΩÆËèúÂçï */
        .settings-menu {
            display: none;
            position: fixed;
            top: 88px;
            right: 10px;
            background-color: #4c4c4c;
            border-radius: 4px;
            padding: 8px 0;
            min-width: 120px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 1500;
        }

        .settings-menu::before {
            content: '';
            position: absolute;
            top: -6px;
            right: 20px;
            width: 0;
            height: 0;
            border-left: 6px solid transparent;
            border-right: 6px solid transparent;
            border-bottom: 6px solid #4c4c4c;
        }

        .menu-item {
            padding: 10px 20px;
            color: white;
            font-size: 14px;
            cursor: pointer;
        }

        .menu-item:active {
            background-color: #3c3c3c;
        }

        /* Âä†ËΩΩÂä®Áîª */
        .typing-indicator {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 10px;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            background-color: #999;
            border-radius: 50%;
            animation: typing 1.4s infinite;
        }

        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {
            0%, 60%, 100% {
                opacity: 0.3;
            }
            30% {
                opacity: 1;
            }
        }

        /* ToastÊèêÁ§∫ */
        .toast {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(0,0,0,0.8);
            color: white;
            padding: 12px 24px;
            border-radius: 4px;
            font-size: 14px;
            z-index: 3000;
            display: none;
        }

        .toast.show {
            display: block;
            animation: fadeInOut 2s ease;
        }

        @keyframes fadeInOut {
            0%, 100% { opacity: 0; }
            10%, 90% { opacity: 1; }
        }

        /* È°∂ÈÉ®ÊèêÁ§∫ */
        .top-notification {
            position: fixed;
            top: 60px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0,0,0,0.8);
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 14px;
            z-index: 3000;
            display: none;
        }

        .top-notification.show {
            display: block;
            animation: slideDown 1.5s ease;
        }

        @keyframes slideDown {
            0% {
                opacity: 0;
                transform: translateX(-50%) translateY(-20px);
            }
            20% {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
            80% {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
            100% {
                opacity: 0;
                transform: translateX(-50%) translateY(-20px);
            }
        }

        /* Ê®°ÂûãÂàóË°® */
        .model-list {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #e5e5e5;
            border-radius: 4px;
            margin-top: 10px;
        }

        .model-item {
            padding: 12px;
            border-bottom: 0.5px solid #e5e5e5;
            cursor: pointer;
            font-size: 14px;
        }

        .model-item:last-child {
            border-bottom: none;
        }

        .model-item:active {
            background-color: #f5f5f5;
        }

        .model-item.selected {
            background-color: #e8f5e9;
            color: #07c160;
        }


        .loading-text {
            text-align: center;
            padding: 20px;
            color: #999;
            font-size: 14px;
        }

        /* ÊèêÁ§∫ËØçÁÆ°ÁêÜ */
        .prompt-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #e5e5e5;
        }

        .prompt-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .prompt-title {
            font-size: 14px;
            font-weight: 500;
        }

        .prompt-actions {
            display: flex;
            gap: 10px;
        }

        .prompt-btn {
            padding: 5px 10px;
            background-color: #f5f5f5;
            border: 1px solid #e5e5e5;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
        }

        .prompt-btn:active {
            background-color: #e5e5e5;
        }

        .file-input {
            display: none;
        }

        /* ‰∏™‰∫∫‰ø°ÊÅØÈ°µÈù¢ */
        .profile-page {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 50px;
            background-color: #f5f5f5;
            transform: translateY(100%);
            transition: transform 0.3s ease;
            z-index: 150;
            overflow-y: auto;
        }

        .profile-page.active {
            transform: translateY(0);
        }

        .profile-header {
            background-color: #fff;
            padding: 44px 15px 20px;
            text-align: center;
            border-bottom: 10px solid #f5f5f5;
        }

        .profile-avatar {
            width: 80px;
            height: 80px;
            border-radius: 8px;
            margin: 0 auto 15px;
            background-color: #07c160;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 32px;
            overflow: hidden;
        }

        .profile-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .profile-name {
            font-size: 18px;
            font-weight: 500;
            margin-bottom: 5px;
        }

        .profile-id {
            font-size: 14px;
            color: #999;
        }

        .profile-section {
            background-color: #fff;
            margin-bottom: 10px;
        }

        .profile-item {
            display: flex;
            align-items: center;
            padding: 15px;
            border-bottom: 0.5px solid #e5e5e5;
            cursor: pointer;
        }

        .profile-item:last-child {
            border-bottom: none;
        }

        .profile-item:active {
            background-color: #f5f5f5;
        }

        .profile-item-label {
            flex: 1;
            font-size: 16px;
        }

        .profile-item-value {
            color: #999;
            font-size: 14px;
            margin-right: 5px;
        }

        .profile-item-arrow {
            color: #c7c7c7;
        }
        
        /* Êñ∞ÂäüËÉΩÊèêÁ§∫ */
        .feature-hint {
            position: absolute;
            bottom: 60px;
            right: 15px;
            background: #07c160;
            color: white;
            padding: 8px 12px;
            border-radius: 18px;
            font-size: 12px;
            z-index: 150;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        /* Êï∞ÊçÆËøÅÁßªÊ†∑Âºè */
        .data-migration-section {
            background-color: #fff;
            margin: 10px 0;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .migration-header {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #333;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .migration-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .migration-btn {
            flex: 1;
            padding: 12px;
            text-align: center;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
        }
        
        .export-btn {
            background-color: #e6f7ff;
            color: #1890ff;
            border: 1px solid #91d5ff;
        }
        
        .export-btn:active {
            background-color: #bae7ff;
        }
        
        .import-btn {
            background-color: #f6ffed;
            color: #52c41a;
            border: 1px solid #b7eb8f;
        }
        
        .import-btn:active {
            background-color: #d9f7be;
        }
        
        .migration-hint {
            font-size: 13px;
            color: #666;
            margin-top: 15px;
            line-height: 1.5;
        }
        
        /* ‰∏ä‰∏ãÊñáÊéßÂà∂Ê†∑Âºè */
        .context-control {
            background-color: #fff;
            padding: 12px 15px;
            border-radius: 8px;
            margin-top: 10px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            position: relative;
        }
        
        .context-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .context-title {
            font-size: 15px;
            font-weight: 500;
            color: #333;
        }
        
        .context-value {
            font-size: 14px;
            color: #07c160;
            font-weight: bold;
            min-width: 40px;
            text-align: right;
        }
        
        .context-slider {
            width: 100%;
            height: 6px;
            -webkit-appearance: none;
            background: #e0e0e0;
            border-radius: 3px;
            outline: none;
            margin-top: 10px;
        }
        
        .context-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #07c160;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        .context-info {
            font-size: 12px;
            color: #666;
            margin-top: 10px;
            line-height: 1.4;
        }
        
        /* ‰∏ä‰∏ãÊñáÁä∂ÊÄÅÊåáÁ§∫Âô® */
        .context-indicator {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(7, 193, 96, 0.1);
            color: #07c160;
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        /* Èü≥‰πêÂºπÁ™óÊ†∑Âºè */
        .music-modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.4);
        }
        
        .music-modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 90%;
            max-width: 600px;
            border-radius: 10px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .close-btn {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .close-btn:hover {
            color: #000;
        }
        
        /* Ê≠åÂçïÊ†∑Âºè */
        .playlist-container {
            margin: 20px 0;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 10px;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .song-item {
            padding: 10px;
            margin: 5px 0;
            background: #f0f0f0;
            border-radius: 5px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .song-item:hover {
            background: #e0e0e0;
        }
        
        .song-item.active {
            background: #07c160;
            color: white;
        }
        
        .delete-song {
            color: #ff4444;
            cursor: pointer;
            padding: 0 10px;
        }
        
        /* Êí≠ÊîæÊéßÂà∂Ê†∑Âºè */
        .player-controls {
            margin: 20px 0;
            padding: 15px;
            background: #f9f9f9;
            border-radius: 5px;
        }
        
        .progress-bar {
            width: 100%;
            height: 4px;
            background: #ddd;
            border-radius: 2px;
            margin: 10px 0;
            cursor: pointer;
        }
        
        .progress-fill {
            height: 100%;
            background: #07c160;
            border-radius: 2px;
            width: 0%;
            transition: width 0.1s;
        }
        
        .time-display {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #666;
        }
        
        /* ÊµÆÂä®Ê≠åËØçÊ†∑Âºè */
        .floating-lyrics {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 12px 24px;
            border-radius: 25px;
            font-size: 16px;
            z-index: 999;
            transition: all 0.3s ease;
            max-width: 80%;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        /* Ë∞ÉËØï‰ø°ÊÅØÊ†∑Âºè */
        .debug-info {
            position: fixed;
            top: 60px;
            right: 10px;
            background: rgba(255,255,255,0.9);
            padding: 10px;
            border-radius: 5px;
            font-size: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            max-width: 200px;
        }

        /* Áæ§ËÅäÂ§¥ÂÉèÊ†∑Âºè */
        .group-avatar {
            width: 48px;
            height: 48px;
            border-radius: 4px;
            margin-right: 12px;
            background-color: #4a90e2; /* ÈªòËÆ§Áæ§ËÅäËÉåÊôØËâ≤ */
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 20px;
            flex-shrink: 0;
            overflow: hidden;
            position: relative;
        }
        
        .group-avatar-inner {
            position: absolute;
            width: 100%;
            height: 100%;
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            grid-template-rows: repeat(2, 1fr);
        }
        
        .group-avatar-item {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            overflow: hidden;
            border: 1px solid white; /* ÊàêÂëòÂ§¥ÂÉè‰πãÈó¥ÁöÑÁôΩËâ≤ËæπÊ°Ü */
            background-color: #07c160; /* ÈªòËÆ§ÊàêÂëòÂ§¥ÂÉèËÉåÊôØËâ≤ */
        }

        .group-avatar-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        /* ÂàõÂª∫Áæ§ËÅäÊ®°ÊÄÅÊ°Ü */
        .create-group-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #e5e5e5;
        }
        
        .group-member-list {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #e5e5e5;
            border-radius: 4px;
            margin-top: 10px;
            padding: 10px;
        }
        
        .group-member-item {
            display: flex;
            align-items: center;
            padding: 8px;
            border-bottom: 0.5px solid #eee;
            cursor: pointer;
        }
        
        .group-member-item:last-child {
            border-bottom: none;
        }
        
        .group-member-item.selected {
            background-color: #e6f7ff;
        }
        
        .group-member-avatar {
            width: 32px;
            height: 32px;
            border-radius: 4px;
            margin-right: 10px;
            background-color: #07c160;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 14px;
            overflow: hidden;
        }

        .group-member-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .group-member-name {
            flex: 1;
            font-size: 14px;
        }
        
        .group-member-checkbox {
            width: 20px;
            height: 20px;
            border-radius: 4px;
            border: 1px solid #ddd;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .group-member-checkbox.selected {
            background-color: #07c160;
            color: white;
            border-color: #07c160;
        }
        
        /* Áæ§ËÅäÊ∂àÊÅØÊ†∑Âºè */
        .group-message-header {
            display: flex;
            align-items: center;
            margin-bottom: 4px;
        }
        
        .group-message-name {
            font-size: 12px;
            font-weight: bold;
            color: #576b95;
        }
        
        .group-message-time {
            font-size: 10px;
            color: #999;
            margin-left: 8px;
        }
        
        /* Áæ§ËÅä‰ø°ÊÅØÊèêÁ§∫ */
        .group-info-hint {
            background-color: #f0f0f0;
            color: #666;
            font-size: 12px;
            text-align: center;
            padding: 8px;
            border-radius: 4px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <!-- Áä∂ÊÄÅÊ†è -->
    <div class="status-bar">
        <div class="status-left">
            <span>12:35</span>
        </div>
        <div class="status-right">
            <span>üì∂</span>
            <span>üì∂</span>
            <span>üîã</span>
        </div>
    </div>

    <!-- ‰∏ªÂÆπÂô® -->
    <div class="main-container">
        <!-- ËÅîÁ≥ª‰∫∫ÂàóË°® -->
        <div class="contact-list-page" id="contactListPage">
            <div class="wechat-header">
                <div class="header-title">Whale-LLT</div>
                <div class="header-actions">
                    <span class="header-icon" onclick="showApiSettingsModal()">‚öôÔ∏è</span>
                    <span class="header-icon" id="musicIcon">üéµ</span>
                    <span class="header-icon" onclick="showAddContactModal()">‚ûï</span>
                    <span class="header-icon" onclick="showCreateGroupModal()">üë•</span> <!-- Êñ∞Â¢ûÁæ§ËÅäÊåâÈíÆ -->
                </div>
            </div>
            
            <div class="search-bar">
                <input type="text" class="search-input" placeholder="ÊêúÁ¥¢">
            </div>
            
            <div id="contactList"></div>
        </div>

        <!-- ËÅäÂ§©È°µÈù¢ -->
        <div class="chat-page" id="chatPage">
            <div class="chat-header">
                <div class="back-btn" onclick="closeChatPage()">
                    <span>‚Äπ</span>
                    <span>Whale-LLT</span>
                </div>
                <div class="chat-title" id="chatTitle">ËÅäÂ§©</div>
                <div class="chat-header-actions">
                    <div class="memory-btn" onclick="toggleMemoryPanel()">
                        <svg t="1689237694389" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="4338" width="24" height="24"><path d="M896 96H128C110.4 96 96 110.4 96 128v768c0 17.6 14.4 32 32 32h768c17.6 0 32-14.4 32-32V128c0-17.6-14.4-32-32-32zM384 832H192v-64h192v64z m0-192H192v-64h192v64z m0-192H192v-64h192v64z m448 384H448v-64h384v64z m0-192H448v-64h384v64z m0-192H448v-64h384v64z" p-id="4339" fill="#515151"></path></svg>
                    </div>
                    <div class="chat-more" onclick="toggleSettingsMenu()">‚ãØ</div>
                </div>
            </div>
            
            <div class="chat-messages" id="chatMessages"></div>
            
            <div class="chat-input-area">
                <div class="feature-hint" id="featureHint">ÊåâEnterÂèëÈÄÅÊ∂àÊÅØÔºåÁÇπ"ÂèëÈÄÅ"ÊåâÈíÆËé∑ÂèñAIÂõûÂ§ç</div>
                <div class="input-actions">
                    <div class="action-btn" onclick="toggleEmojiPanel()">üòä</div>
                    <div class="action-btn" onclick="showRedPacketModal()">üßß</div>
                </div>
                <textarea class="chat-input" id="chatInput" placeholder="ËæìÂÖ•Ê∂àÊÅØ" rows="1"></textarea>
                <button class="send-btn" id="sendBtn" onclick="sendMessage()">ÂèëÈÄÅ</button>
                
                <!-- Ë°®ÊÉÖÈù¢Êùø -->
                <div class="emoji-panel" id="emojiPanel">
                    <div class="emoji-grid" id="emojiGrid">
                        <div class="add-emoji-btn" onclick="showAddEmojiModal()">+ Ê∑ªÂä†Ë°®ÊÉÖ</div>
                    </div>
                </div>
            </div>
            
            <!-- ‰∏ä‰∏ãÊñáÁä∂ÊÄÅÊåáÁ§∫Âô® -->
            <div class="context-indicator" id="contextIndicator">
                <span>‰∏ä‰∏ãÊñá: 10Êù°</span>
            </div>

            <!-- ËÆ∞ÂøÜË°®Ê†ºÈù¢Êùø -->
            <div class="memory-panel" id="memoryPanel">
                <div class="memory-panel-header">
                    <div class="memory-panel-title">ËÆ∞ÂøÜË°®Ê†º</div>
                    <div class="memory-panel-actions">
                         <button id="memoryEditBtn" class="memory-panel-btn" onclick="toggleMemoryEditMode()">ÁºñËæë</button>
                         <button class="memory-panel-btn" onclick="toggleMemoryPanel()">ÂÖ≥Èó≠</button>
                    </div>
                </div>
                <div class="memory-panel-content">
                    <div id="memoryTableView" class="memory-table-view"></div>
                    <textarea id="memoryTextarea" class="memory-textarea" style="display: none;"></textarea>
                </div>
            </div>
        </div>

        <!-- ÊúãÂèãÂúàÈ°µÈù¢ -->
        <div class="moments-page" id="momentsPage">
            <div class="moments-header">
                <div class="back-btn" onclick="closeMomentsPage()">
                    <span>‚Äπ</span>
                    <span>ËøîÂõû</span>
                </div>
                <div class="chat-title">ÊúãÂèãÂúà</div>
                <div class="chat-more" onclick="showPublishMomentModal()">‚ûï</div>
            </div>
            
            <div class="moments-content" id="momentsContent">
                <div class="moments-empty" id="momentsEmpty">
                    <div class="moments-empty-icon">üìù</div>
                    <div class="moments-empty-text">ËøòÊ≤°ÊúâÊúãÂèãÂúàÂä®ÊÄÅ</div>
                    <button class="moments-empty-btn" onclick="showPublishMomentModal()">ÂèëÂ∏ÉÁ¨¨‰∏ÄÊù°Âä®ÊÄÅ</button>
                </div>
                
                <div class="moments-list" id="momentsList" style="display: none;">
                    <!-- ÊúãÂèãÂúàÂàóË°®Â∞ÜÂú®ËøôÈáåÊ∏≤Êüì -->
                </div>
            </div>
        </div>

        <!-- ‰∏™‰∫∫‰ø°ÊÅØÈ°µÈù¢ -->
        <div class="profile-page" id="profilePage">
            <div class="chat-header">
                <div class="back-btn" onclick="closeProfilePage()">
                    <span>‚Äπ</span>
                    <span>Whale-LLT</span>
                </div>
                <div class="chat-title">‰∏™‰∫∫‰ø°ÊÅØ</div>
                <div style="width: 24px;"></div>
            </div>
            
            <div class="profile-header">
                <div class="profile-avatar" id="userAvatar">Êàë</div>
                <div class="profile-name" id="userName">ÊàëÁöÑÊòµÁß∞</div>
                <div class="profile-id">idÂè∑ÔºöAI_User_001</div>
            </div>
            
            <div class="profile-section">
                <div class="profile-item" onclick="showEditProfileModal()">
                    <div class="profile-item-label">ÁºñËæë‰∏™‰∫∫‰ø°ÊÅØ</div>
                    <div class="profile-item-arrow">‚Ä∫</div>
                </div>
            </div>
            
            <!-- Êï∞ÊçÆËøÅÁßªÈÉ®ÂàÜ -->
            <div class="data-migration-section">
                <div class="migration-header">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M19 12H5M19 12L15 8M19 12L15 16M5 12L9 8M5 12L9 16" stroke="#666" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M12 22C17.5228 22 22 17.5228 22 12C22 6.47715 17.5228 2 12 2C6.47715 2 2 6.47715 2 12C2 17.5228 6.47715 22 12 22Z" stroke="#666" stroke-width="2"/>
                    </svg>
                    Êï∞ÊçÆËøÅÁßª
                </div>
                
                <div class="migration-hint">
                    Â∞ÜËÅäÂ§©ËÆ∞ÂΩï„ÄÅËÅîÁ≥ª‰∫∫„ÄÅËÆæÁΩÆÁ≠âÊï∞ÊçÆÂØºÂá∫‰∏∫Êñá‰ª∂ÔºåÁÑ∂ÂêéÂú®ÂÖ∂‰ªñËÆæÂ§á‰∏äÂØºÂÖ•„ÄÇ
                </div>
                
                <div class="migration-buttons">
                    <div class="migration-btn export-btn" onclick="exportData()">
                        ÂØºÂá∫Êï∞ÊçÆ
                    </div>
                    <div class="migration-btn import-btn" onclick="document.getElementById('importFile').click()">
                        ÂØºÂÖ•Êï∞ÊçÆ
                        <input type="file" id="importFile" class="file-input" accept=".json" onchange="importData(event)" style="display: none;">
                    </div>
                </div>
                
                <div class="migration-hint">
                    ÊèêÁ§∫ÔºöÂØºÂÖ•Êï∞ÊçÆ‰ºöË¶ÜÁõñÂΩìÂâçËÆæÂ§á‰∏äÁöÑÊâÄÊúâÊï∞ÊçÆÔºåËØ∑Ë∞®ÊÖéÊìç‰Ωú„ÄÇ
                </div>
            </div>
        </div>

        <!-- ËÆæÁΩÆËèúÂçï -->
        <div class="settings-menu" id="settingsMenu">
            <div class="menu-item" onclick="showEditContactModal()">ÁºñËæëËÅîÁ≥ª‰∫∫</div>
            <div class="menu-item" onclick="showBackgroundModal()">ËÆæÁΩÆËÉåÊôØ</div>
            <div class="menu-item" onclick="clearMessages()">Ê∏ÖÁ©∫ËÅäÂ§©</div>
        </div>
    </div>

    <!-- Â∫ïÈÉ®ÂØºËà™ -->
    <div class="bottom-nav">
        <div class="nav-item active">
            <div class="nav-icon">üí¨</div>
            <div class="nav-text">Whale-LLT</div>
        </div>
        <div class="nav-item">
            <div class="nav-icon">üìû</div>
            <div class="nav-text">ÈÄöËÆØÂΩï</div>
        </div>
        <div class="nav-item" onclick="openMomentsPage()">
            <div class="nav-icon">üîç</div>
            <div class="nav-text">ÂèëÁé∞</div>
        </div>
        <div class="nav-item" onclick="openProfilePage()">
            <div class="nav-icon">üë§</div>
            <div class="nav-text">Êàë</div>
        </div>
    </div>

    <!-- ÂèëÂ∏ÉÊúãÂèãÂúàÊ®°ÊÄÅÊ°Ü -->
    <div class="publish-moment-modal" id="publishMomentModal">
        <div class="publish-moment-content">
            <div class="publish-moment-header">
                <div class="publish-moment-title">ÁîüÊàêÊúãÂèãÂúà</div>
                <div class="publish-moment-close" onclick="closePublishMomentModal()">ÂèñÊ∂à</div>
            </div>
            <div class="publish-moment-body">
                <div class="generate-moment-section">
                    <button class="generate-moment-btn" onclick="generateMomentContent()">ÁîüÊàêÊúãÂèãÂúà</button>
                    <div class="generate-moment-hint">
                        ÁÇπÂáª‰∏äÊñπÊåâÈíÆÔºåAIÂ∞ÜÊ†πÊçÆÂΩìÂâçËßíËâ≤ÁöÑ‰∫∫ËÆæÂíåËÅäÂ§©ËÆ∞ÂΩïËá™Âä®ÁîüÊàêÊúãÂèãÂúàÂÜÖÂÆπ
                    </div>
                </div>
                
                <div class="moment-preview" id="momentPreview">
                    <div class="moment-preview-title">È¢ÑËßà</div>
                    <div class="moment-preview-content" id="momentPreviewContent"></div>
                    <img class="moment-preview-image" id="momentPreviewImage" style="display: none;">
                </div>
                
                <div class="unsplash-key-section">
                    <label class="unsplash-key-label">Unsplash API Key</label>
                    <input type="text" class="unsplash-key-input" id="unsplashApiKey" placeholder="ËØ∑ËæìÂÖ•‰Ω†ÁöÑUnsplash API Key">
                </div>
                
                <button class="publish-moment-submit" id="publishMomentBtn" onclick="publishMoment()" disabled>ÂèëÂ∏É</button>
            </div>
        </div>
    </div>

    <!-- Ê®°ÊÄÅÊ°Ü‰ª¨ -->
    <!-- Ê∑ªÂä†/ÁºñËæëËÅîÁ≥ª‰∫∫ -->
    <div class="modal" id="addContactModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="contactModalTitle">Ê∑ªÂä†AIÂä©Êâã</div>
                <div class="modal-close" onclick="closeModal('addContactModal')">ÂèñÊ∂à</div>
            </div>
            <div class="modal-body">
                <form onsubmit="saveContact(event)">
                    <div class="form-group">
                        <label class="form-label">Âä©ÊâãÂêçÁß∞</label>
                        <input type="text" class="form-input" id="contactName" required>
                    </div>
                    <!-- ‰øÆÊîπÂêéÁöÑÂ§¥ÂÉè‰∏ä‰º† -->
                    <div class="form-group">
                        <label class="form-label">Â§¥ÂÉèÔºàÂèØÈÄâÔºâ</label>
                        <input type="url" class="form-input" id="contactAvatar" placeholder="ÂèØÁõ¥Êé•Á≤òË¥¥URLÊàñ‰∏ä‰º†Êú¨Âú∞ÂõæÁâá">
                        <div style="display: flex; align-items: center; gap: 10px; margin-top: 8px;">
                            <input type="file" id="avatarUploadInput" accept="image/*" style="flex: 1;" onchange="handleFileUpload('avatarUploadInput', 'contactAvatar', 'avatarUploadStatus')">
                            <span id="avatarUploadStatus" style="font-size: 12px; color: #07c160;"></span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">‰∫∫ËÆæÊèèËø∞</label>
                        <textarea class="form-textarea" id="contactPersonality" required placeholder="ÊèèËø∞AIÁöÑÊÄßÊ†º„ÄÅËÉåÊôØ„ÄÅËØ¥ËØùÈ£éÊ†ºÁ≠â"></textarea>
                    </div>
                    
                    <!-- Ëá™ÂÆö‰πâÊèêÁ§∫ËØçÈÉ®ÂàÜ -->
                    <div class="prompt-section">
                        <div class="prompt-header">
                            <div class="prompt-title">Ëá™ÂÆö‰πâÊèêÁ§∫ËØçÔºàÂèØÈÄâÔºâ</div>
                            <div class="prompt-actions">
                                <button type="button" class="prompt-btn" onclick="document.getElementById('promptFile').click()">ÂØºÂÖ•JSON</button>
                                <input type="file" id="promptFile" class="file-input" accept=".json" onchange="importPrompts(event)">
                            </div>
                        </div>
                        <div class="form-group">
                            <textarea class="form-textarea" id="customPrompts" placeholder="ËæìÂÖ•Ëá™ÂÆö‰πâÊèêÁ§∫ËØçÔºåÊàñÂØºÂÖ•JSONÊñá‰ª∂"></textarea>
                        </div>
                    </div>
                    
                    <button type="submit" class="form-submit">Á°ÆÂÆö</button>
                </form>
            </div>
        </div>
    </div>

    <!-- ÂàõÂª∫Áæ§ËÅäÊ®°ÊÄÅÊ°Ü -->
    <div class="modal" id="createGroupModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">ÂàõÂª∫Áæ§ËÅä</div>
                <div class="modal-close" onclick="closeModal('createGroupModal')">ÂèñÊ∂à</div>
            </div>
            <div class="modal-body">
                <form onsubmit="createGroup(event)">
                    <div class="form-group">
                        <label class="form-label">Áæ§ËÅäÂêçÁß∞</label>
                        <input type="text" class="form-input" id="groupName" required>
                    </div>
                    
                    <div class="create-group-section">
                        <label class="form-label">ÈÄâÊã©Áæ§ÊàêÂëò</label>
                        <div class="group-member-list" id="groupMemberList"></div>
                    </div>
                    
                    <button type="submit" class="form-submit">ÂàõÂª∫Áæ§ËÅä</button>
                </form>
            </div>
        </div>
    </div>

    <!-- ÁºñËæë‰∏™‰∫∫‰ø°ÊÅØ -->
    <div class="modal" id="editProfileModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">ÁºñËæë‰∏™‰∫∫‰ø°ÊÅØ</div>
                <div class="modal-close" onclick="closeModal('editProfileModal')">ÂèñÊ∂à</div>
            </div>
            <div class="modal-body">
                <form onsubmit="saveProfile(event)">
                    <div class="form-group">
                        <label class="form-label">ÊòµÁß∞</label>
                        <input type="text" class="form-input" id="profileName" required>
                    </div>
                    <!-- ‰øÆÊîπÂêéÁöÑ‰∏™‰∫∫Â§¥ÂÉè‰∏ä‰º† -->
                    <div class="form-group">
                        <label class="form-label">Â§¥ÂÉèÔºàÂèØÈÄâÔºâ</label>
                        <input type="url" class="form-input" id="profileAvatar" placeholder="ÂèØÁõ¥Êé•Á≤òË¥¥URLÊàñ‰∏ä‰º†Êú¨Âú∞ÂõæÁâá">
                         <div style="display: flex; align-items: center; gap: 10px; margin-top: 8px;">
                            <input type="file" id="profileUploadInput" accept="image/*" style="flex: 1;" onchange="handleFileUpload('profileUploadInput', 'profileAvatar', 'profileUploadStatus')">
                            <span id="profileUploadStatus" style="font-size: 12px; color: #07c160;"></span>
                        </div>
                    </div>
                    <button type="submit" class="form-submit">‰øùÂ≠ò</button>
                </form>
            </div>
        </div>
    </div>

    <!-- APIËÆæÁΩÆ -->
    <div class="modal" id="apiSettingsModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">APIËÆæÁΩÆ</div>
                <div class="modal-close" onclick="closeModal('apiSettingsModal')">ÂèñÊ∂à</div>
            </div>
            <div class="modal-body">
                <form onsubmit="saveApiSettings(event)">
                    <div class="form-group">
                        <label class="form-label">API URL</label>
                        <!-- MODIFIED: Updated placeholder to guide users -->
                        <input type="url" class="form-input" id="apiUrl" required placeholder="‰æãÂ¶Ç: https://api.openai.com/v1">
                    </div>
                    <div class="form-group">
                        <label class="form-label">API Key</label>
                        <input type="password" class="form-input" id="apiKey" required>
                    </div>
                    
                    <!-- ‰∏ä‰∏ãÊñáÊéßÂà∂ÈÉ®ÂàÜ -->
                    <div class="context-control">
                        <div class="context-header">
                            <div class="context-title">‰∏ä‰∏ãÊñáÈïøÂ∫¶</div>
                            <div class="context-value" id="contextValue">10Êù°</div>
                        </div>
                        <input 
                            type="range" 
                            class="context-slider" 
                            id="contextSlider" 
                            min="1" 
                            max="50" 
                            value="10"
                            oninput="updateContextValue(this.value)"
                        >
                        <div class="context-info">
                            ÊéßÂà∂AIÂèØËßÅÁöÑÂéÜÂè≤Ê∂àÊÅØÊï∞ÈáèÔºåËæÉÈïøÁöÑ‰∏ä‰∏ãÊñáÊúâÂä©‰∫é‰øùÊåÅÂØπËØùËøûË¥ØÊÄßÔºå‰ΩÜÂèØËÉΩ‰ºöÂ¢ûÂä†APIÊàêÊú¨„ÄÇ
                        </div>
                    </div>
                    
                    <button type="button" class="form-submit" onclick="testApiConnection()" style="margin-bottom: 10px;">ÊµãËØïËøûÊé•</button>
                    <div class="form-group">
                        <label class="form-label">ÈÄâÊã©Ê®°Âûã</label>
                        <div class="model-list" id="modelList">
                            <div class="loading-text">ËØ∑ÂÖàÊµãËØïËøûÊé•</div>
                        </div>
                    </div>
                    <button type="submit" class="form-submit">‰øùÂ≠ò</button>
                </form>
            </div>
        </div>
    </div>

    <!-- ËÉåÊôØËÆæÁΩÆ -->
    <div class="modal" id="backgroundModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">ËÆæÁΩÆËÅäÂ§©ËÉåÊôØ</div>
                <div class="modal-close" onclick="closeModal('backgroundModal')">ÂèñÊ∂à</div>
            </div>
            <div class="modal-body">
                <form onsubmit="setBackground(event)">
                    <!-- ‰øÆÊîπÂêéÁöÑËÉåÊôØ‰∏ä‰º† -->
                    <div class="form-group">
                        <label class="form-label">ËÉåÊôØÂõæÁâá</label>
                        <input type="url" class="form-input" id="backgroundUrl" placeholder="ÂèØÁõ¥Êé•Á≤òË¥¥URLÊàñ‰∏ä‰º†Êú¨Âú∞ÂõæÁâá">
                        <div style="display: flex; align-items: center; gap: 10px; margin-top: 8px;">
                            <input type="file" id="bgUploadInput" accept="image/*" style="flex: 1;" onchange="handleFileUpload('bgUploadInput', 'backgroundUrl', 'bgUploadStatus')">
                            <span id="bgUploadStatus" style="font-size: 12px; color: #07c160;"></span>
                        </div>
                    </div>
                    <button type="submit" class="form-submit">Á°ÆÂÆö</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Ê∑ªÂä†Ë°®ÊÉÖ -->
    <div class="modal" id="addEmojiModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Ê∑ªÂä†Ë°®ÊÉÖÂåÖ</div>
                <div class="modal-close" onclick="closeModal('addEmojiModal')">ÂèñÊ∂à</div>
            </div>
            <div class="modal-body">
                <form onsubmit="addEmoji(event)">
                     <!-- ‰øÆÊîπÂêéÁöÑË°®ÊÉÖ‰∏ä‰º† -->
                    <div class="form-group">
                        <label class="form-label">Ë°®ÊÉÖÂõæÁâá</label>
                        <input type="url" class="form-input" id="emojiUrl" placeholder="ÂèØÁõ¥Êé•Á≤òË¥¥URLÊàñ‰∏ä‰º†Êú¨Âú∞ÂõæÁâá" required>
                        <div style="display: flex; align-items: center; gap: 10px; margin-top: 8px;">
                            <input type="file" id="emojiUploadInput" accept="image/*" style="flex: 1;" onchange="handleFileUpload('emojiUploadInput', 'emojiUrl', 'emojiUploadStatus')">
                            <span id="emojiUploadStatus" style="font-size: 12px; color: #07c160;"></span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Ë°®ÊÉÖÂê´‰πâÔºàÁî®‰∫éAIÁêÜËß£Ôºâ</label>
                        <input type="text" class="form-input" id="emojiMeaning" required placeholder="‰æãÂ¶ÇÔºöÂºÄÂøÉ„ÄÅÂ§ßÁ¨ë„ÄÅÂì≠Ê≥£Á≠â">
                    </div>
                    <button type="submit" class="form-submit">Ê∑ªÂä†</button>
                </form>
            </div>
        </div>
    </div>
    
    <!-- ÂèëÁ∫¢ÂåÖÊ®°ÊÄÅÊ°Ü -->
    <div class="modal" id="redPacketModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">ÂèëÁ∫¢ÂåÖ</div>
                <div class="modal-close" onclick="closeModal('redPacketModal')">ÂèñÊ∂à</div>
            </div>
            <div class="modal-body">
                <form onsubmit="sendRedPacket(event)">
                    <div class="form-group">
                        <label class="form-label">ÈáëÈ¢ù</label>
                        <input type="number" class="form-input" id="redPacketAmount" step="0.01" required placeholder="0.00">
                    </div>
                    <div class="form-group">
                        <label class="form-label">ÁïôË®ÄÔºàÂèØÈÄâÔºâ</label>
                        <input type="text" class="form-input" id="redPacketMessage" placeholder="ÊÅ≠ÂñúÂèëË¥¢ÔºåÂ§ßÂêâÂ§ßÂà©ÔºÅ">
                    </div>
                    <button type="submit" class="form-submit">Â°ûÈí±ËøõÁ∫¢ÂåÖ</button>
                </form>
            </div>
        </div>
    </div>


    <!-- Èü≥‰πêËÆæÁΩÆÂºπÁ™ó -->
    <div id="musicModal" class="music-modal">
        <div class="music-modal-content">
            <span class="close-btn" id="closeMusicModal">&times;</span>
            <h2>üéµ Èü≥‰πêÊí≠ÊîæÂô®</h2>
            
            <!-- ÂΩìÂâçÊí≠Êîæ‰ø°ÊÅØ -->
            <div id="currentSongInfo" style="display: none;">
                <h3>Ê≠£Âú®Êí≠Êîæ: <span id="currentSongName"></span></h3>
                <div class="player-controls">
                    <div class="progress-bar" id="progressBar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                    <div class="time-display">
                        <span id="currentTime">0:00</span>
                        <span id="totalTime">0:00</span>
                    </div>
                    <div style="text-align: center; margin-top: 10px;">
                        <button class="form-submit" onclick="togglePlay()">
                            <span id="playPauseBtn">‚ñ∂Ô∏è Êí≠Êîæ</span>
                        </button>
                        <button class="form-submit" style="background-color: #888;" onclick="stopMusic()">‚èπÔ∏è ÂÅúÊ≠¢</button>
                    </div>
                </div>
            </div>

            <!-- Ê≠åÂçï -->
            <h3>ÊàëÁöÑÊ≠åÂçï</h3>
            <div class="playlist-container" id="playlistContainer">
                <p style="text-align: center; color: #999;">ÊöÇÊó†Ê≠åÊõ≤</p>
            </div>

            <!-- Ê∑ªÂä†Êñ∞Ê≠åÊõ≤ -->
            <h3>Ê∑ªÂä†Êñ∞Ê≠åÊõ≤</h3>
            <div id="addSongForm">
                <div class="form-group">
                    <label class="form-label">Ê≠åÊõ≤ÂêçÁß∞ (ÂèØÈÄâ):</label>
                    <input type="text" class="form-input" id="songName" placeholder="ÁïôÁ©∫Âàô‰ΩøÁî®Êñá‰ª∂Âêç">
                </div>
                <div class="form-group">
                    <label class="form-label">ÈÄâÊã©Èü≥‰πêÊñá‰ª∂:</label>
                    <input type="file" class="form-input" id="musicFileUpload" accept="audio/*">
                </div>
                <div class="form-group">
                    <label class="form-label">LRCÊ≠åËØçÊñá‰ª∂ (ÂèØÈÄâ):</label>
                    <input type="file" class="form-input" id="lrcFile" accept=".lrc">
                    <small style="color: #666;">ËØ∑ÈÄâÊã©.lrcÊ†ºÂºèÁöÑÊ≠åËØçÊñá‰ª∂</small>
                </div>
                <button class="form-submit" onclick="saveSong()">‰øùÂ≠òÊ≠åÊõ≤</button>
            </div>

            <!-- Ê≠åËØçÊòæÁ§∫ËÆæÁΩÆ -->
            <div style="margin-top: 20px;">
                <label>
                    <input type="checkbox" id="showLyrics" onchange="toggleLyricsDisplay()">
                    ÊòæÁ§∫ÊµÆÂä®Ê≠åËØç
                </label>
            </div>
        </div>
    </div>

    <!-- ÊµÆÂä®Ê≠åËØç -->
    <div id="floatingLyrics" class="floating-lyrics" style="display: none;">
        <span id="currentLyric">Á≠âÂæÖÊ≠åËØç...</span>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast"></div>
    
    <!-- È°∂ÈÉ®ÈÄöÁü• -->
    <div class="top-notification" id="topNotification"></div>

    <script>
        // --- [MODIFIED] ÈÄöÁî®Êñá‰ª∂‰∏ä‰º†ÂáΩÊï∞ (‰∏ä‰º†Âà∞ÊúçÂä°Âô®‰ª•Ëé∑ÂèñÊ∞∏‰πÖÈìæÊé•) ---
        async function handleFileUpload(inputId, targetUrlInputId, statusElementId) {
            const fileInput = document.getElementById(inputId);
            const file = fileInput.files[0];
            const statusElement = document.getElementById(statusElementId);
            const targetUrlInput = document.getElementById(targetUrlInputId);

            if (!file) {
                showToast('ËØ∑ÂÖàÈÄâÊã©‰∏Ä‰∏™Êñá‰ª∂');
                return;
            }

            if (!file.type.startsWith('image/')) {
                showToast('ËØ∑‰∏ä‰º†ÂõæÁâáÊñá‰ª∂');
                fileInput.value = ''; // Ê∏ÖÁ©∫ÈÄâÊã©
                return;
            }

            if (statusElement) statusElement.textContent = '‰∏ä‰º†‰∏≠...';
            
            // ÂàõÂª∫ FormData Êù•ÂåÖË£ÖÊñá‰ª∂Êï∞ÊçÆ
            const formData = new FormData();
            // ËøôÈáåÁöÑ 'image' ÈîÆÂøÖÈ°ª‰∏é server.js ‰∏≠ multer ËÆæÁΩÆÁöÑ fieldname 'image' ‰∏ÄËá¥
            formData.append('image', file); 

            try {
                // ÂèëÈÄÅËØ∑Ê±ÇÂà∞ÂêéÁ´ØÁöÑ /upload Êé•Âè£
                const response = await fetch('/upload', {
                    method: 'POST',
                    body: formData,
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ error: '‰∏ä‰º†ËØ∑Ê±ÇÂ§±Ë¥•' }));
                    throw new Error(errorData.error || `ÊúçÂä°Âô®ÈîôËØØ: ${response.status}`);
                }

                const result = await response.json();

                // ÊúçÂä°Âô®ËøîÂõûÊ†ºÂºè‰∏∫ { url: '...' }
                if (result.url) {
                    targetUrlInput.value = result.url; // Â∞ÜÊúçÂä°Âô®ËøîÂõûÁöÑÊ∞∏‰πÖURLÂ°´ÂÖ•ËæìÂÖ•Ê°Ü
                    if (statusElement) statusElement.textContent = '‰∏ä‰º†ÊàêÂäüÔºÅ';
                    showToast('ÂõæÁâá‰∏ä‰º†ÊàêÂäü');
                } else {
                    throw new Error('ÊúçÂä°Âô®Êú™ËøîÂõûÊúâÊïàÁöÑURL');
                }

            } catch (error) {
                console.error('Êñá‰ª∂‰∏ä‰º†Â§±Ë¥•:', error);
                if (statusElement) statusElement.textContent = '‰∏ä‰º†Â§±Ë¥•';
                showToast(`‰∏ä‰º†Â§±Ë¥•: ${error.message}`);
            }
        }

        // ÂÖ®Â±ÄÁä∂ÊÄÅ
        let contacts = [];
        let currentContact = null;
        let editingContact = null;
        let apiSettings = {
            url: '',
            key: '',
            model: '',
            contextMessageCount: 10
        };
        let emojis = [];
        let backgrounds = {};
        let userProfile = {
            name: 'ÊàëÁöÑÊòµÁß∞',
            avatar: ''
        };
        let moments = [];
        
        // --- Èü≥‰πêÊí≠ÊîæÂô®ÂÖ®Â±ÄÂèòÈáè ---
        let audio = null; // Audio element
        let db = null; // IndexedDB database connection
        let playlist = []; // In-memory playlist of metadata
        let currentSongIndex = -1;
        let isPlaying = false;
        let lyricTimer = null;
        let currentObjectUrl = null; // To keep track of the current blob URL for revocation

        // ÈªòËÆ§ËÆ∞ÂøÜË°®Ê†ºÊ®°Êùø
        const defaultMemoryTable = `# ËßíËâ≤ËÆæÂÆö
- ÂßìÂêçÔºö
- ÊÄßÊ†ºÁâπÁÇπÔºö
- ÊÄßÂà´Ôºö
- ËØ¥ËØùÈ£éÊ†ºÔºö
- ËÅå‰∏öÔºö

# Áî®Êà∑ËÆæÂÆö
- ÂßìÂêçÔºö
- ÊÄßÂà´Ôºö
- ‰∏éËßíËâ≤ÁöÑÂÖ≥Á≥ªÔºö
- Áî®Êà∑ÊÄßÊ†ºÔºö

# ËÉåÊôØËÆæÂÆö
- Êó∂Èó¥Âú∞ÁÇπÔºö
- ‰∫ã‰ª∂Ôºö
---
## Á≥ªÁªüÊåá‰ª§
‰Ω†ÈúÄË¶ÅÂú®ÊØèÊ¨°ÂØπËØùÁªìÊùüÊó∂ÔºåÊåâ‰ª•‰∏ãÊ†ºÂºèÁîüÊàêËÆ∞ÂøÜË°®Ê†º„ÄÇÊØèÊ¨°ÈÉΩË¶ÅÔºö
1. ÂÆåÊï¥Â§çÂà∂‰∏ä‰∏ÄÊ¨°ÁöÑË°®Ê†ºÂÜÖÂÆπ
2. Ê†πÊçÆÊú¨Ê¨°ÂØπËØùÊñ∞Â¢ûÁõ∏ÂÖ≥‰ø°ÊÅØ
3. Â∞ÜË°®Ê†ºÊîæÂú®ÂõûÂ§çÁöÑÊúÄÊú´Â∞æ

### Ë°®Ê†ºÊ†ºÂºèË¶ÅÊ±ÇÔºö
## üìã ËÆ∞ÂøÜË°®Ê†º

### „ÄêÁé∞Âú®„Äë
| È°πÁõÆ | ÂÜÖÂÆπ |
|------|------|
| Âú∞ÁÇπ | [ÂΩìÂâçÊâÄÂú®ÁöÑÂÖ∑‰ΩìÂú∞ÁÇπ] |
| ‰∫∫Áâ© | [ÂΩìÂâçÂú®Âú∫ÁöÑÊâÄÊúâ‰∫∫Áâ©] |
| Êó∂Èó¥ | [Á≤æÁ°ÆÁöÑÂπ¥ÊúàÊó•ÂíåÊó∂Èó¥ÔºåÊ†ºÂºèÔºöYYYYÂπ¥MMÊúàDDÊó• HH:MM] |

### „ÄêÊú™Êù•„Äë
| Á∫¶ÂÆö‰∫ãÈ°π | ËØ¶ÁªÜÂÜÖÂÆπ |
|----------|----------|
| [‰∫ãÈ°π1]   | [ÂÖ∑‰ΩìÁöÑÁ∫¶ÂÆöÂÜÖÂÆπ„ÄÅÊó∂Èó¥„ÄÅÂú∞ÁÇπ] |
| [‰∫ãÈ°π2]   | [ÂÖ∑‰ΩìÁöÑÁ∫¶ÂÆöÂÜÖÂÆπ„ÄÅÊó∂Èó¥„ÄÅÂú∞ÁÇπ] |

### „ÄêËøáÂéª„Äë
| ‰∫∫Áâ© | ‰∫ã‰ª∂ | Âú∞ÁÇπ | Êó∂Èó¥ |
|------|------|------|------|
| [Áõ∏ÂÖ≥‰∫∫Áâ©] | [ÂèëÁîüÁöÑÈáçË¶Å‰∫ã‰ª∂] | [‰∫ã‰ª∂ÂèëÁîüÂú∞ÁÇπ] | [ÂÖ∑‰ΩìÂπ¥ÊúàÊó•] |

### „ÄêÈáçË¶ÅÁâ©ÂìÅ„Äë
| Áâ©ÂìÅÂêçÁß∞ | Áâ©ÂìÅÊèèËø∞ | ÈáçË¶ÅÂéüÂõ† |
|----------|----------|----------|
| [Áâ©ÂìÅ1]   | [ËØ¶ÁªÜÁöÑÂ§ñËßÇÂíåÁâπÂæÅÊèèËø∞] | [‰∏∫‰ªÄ‰πàËøô‰∏™Áâ©ÂìÅÈáçË¶Å] |
| [Áâ©ÂìÅ2]   | [ËØ¶ÁªÜÁöÑÂ§ñËßÇÂíåÁâπÂæÅÊèèËø∞] | [‰∏∫‰ªÄ‰πàËøô‰∏™Áâ©ÂìÅÈáçË¶Å] |
`;

        // ÂàùÂßãÂåñÂáΩÊï∞
        function init() {
            loadFromStorage();
            renderContactList();
            renderEmojiGrid();
            updateUserProfile();
            updateContextIndicator();
            renderMomentsList();
            initMusicPlayer();
            
            const chatInput = document.getElementById('chatInput');
            chatInput.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = this.scrollHeight + 'px';
            });
            
            setTimeout(() => {
                const hint = document.getElementById('featureHint');
                if (hint) {
                    hint.style.display = 'block';
                    setTimeout(() => {
                        hint.style.display = 'none';
                    }, 5000);
                }
            }, 1000);
        }

        // ÊúãÂèãÂúàÁõ∏ÂÖ≥ÂáΩÊï∞
        function openMomentsPage() {
            document.getElementById('momentsPage').classList.add('active');
            renderMomentsList();
        }

        function closeMomentsPage() {
            document.getElementById('momentsPage').classList.remove('active');
        }

        function showPublishMomentModal() {
            document.getElementById('publishMomentModal').style.display = 'block';
            document.getElementById('momentPreview').style.display = 'none';
            document.getElementById('publishMomentBtn').disabled = true;
        }

        function closePublishMomentModal() {
            document.getElementById('publishMomentModal').style.display = 'none';
        }

        async function generateMomentContent() {
            if (!currentContact) {
                showToast('ËØ∑ÂÖàÈÄâÊã©‰∏Ä‰∏™ËÅîÁ≥ª‰∫∫');
                return;
            }

            if (!apiSettings.url || !apiSettings.key || !apiSettings.model) {
                showToast('ËØ∑ÂÖàËÆæÁΩÆAPI');
                return;
            }

            const generateBtn = document.querySelector('.generate-moment-btn');
            generateBtn.disabled = true;
            generateBtn.textContent = 'ÁîüÊàê‰∏≠...';

            try {
                let systemPrompt = `‰Ω†ÊòØ${currentContact.name}Ôºå${currentContact.personality}
Áé∞Âú®ÈúÄË¶Å‰Ω†‰ª•${currentContact.name}ÁöÑË∫´‰ªΩÂèë‰∏ÄÊù°ÊúãÂèãÂúà„ÄÇ

Ë¶ÅÊ±ÇÔºö
1. Ê†πÊçÆ‰Ω†ÁöÑ‰∫∫ËÆæÂíåÊúÄËøëÁöÑËÅäÂ§©ËÆ∞ÂΩïÔºåÁîüÊàê‰∏ÄÊù°Á¨¶Âêà‰Ω†ÊÄßÊ†ºÁöÑÊúãÂèãÂúàÊñáÊ°à
2. ÊñáÊ°àË¶ÅËá™ÁÑ∂„ÄÅÁúüÂÆûÔºå‰ΩìÁé∞‰Ω†ÁöÑ‰∏™ÊÄßÁâπÁÇπ
3. Áõ¥Êé•ËæìÂá∫ÊñáÊ°àÂÜÖÂÆπÔºå‰∏çË¶Å‰ªª‰ΩïËß£ÈáäÊàñËØ¥Êòé
4. ÊñáÊ°àÈïøÂ∫¶ÊéßÂà∂Âú®50Â≠ó‰ª•ÂÜÖ
5. ÂèØ‰ª•ÂåÖÂê´ÈÄÇÂΩìÁöÑË°®ÊÉÖÁ¨¶Âè∑
6. ÊñáÊ°àÂ∫îËØ•ÈÄÇÂêàÈÖçÂõæÔºåÊèèËø∞ÂÖ∑‰ΩìÁöÑÂú∫ÊôØ„ÄÅÊÉÖÊÑüÊàñÊ¥ªÂä®`;

                if (currentContact.messages && currentContact.messages.length > 0) {
                    const recentMessages = currentContact.messages.slice(-apiSettings.contextMessageCount);
                    const chatContext = recentMessages.map(msg => {
                        if (msg.role === 'user') {
                            return `Áî®Êà∑: ${msg.content}`;
                        } else {
                            const sender = contacts.find(c => c.id === msg.senderId);
                            const senderName = sender ? sender.name : currentContact.name;
                            return `${senderName}: ${msg.content}`;
                        }
                    }).join('\n');
                    
                    systemPrompt += `\n\nÊúÄËøëÁöÑËÅäÂ§©ËÆ∞ÂΩïÔºö\n${chatContext}`;
                }

                const requestBody = {
                    model: apiSettings.model,
                    messages: [
                        { role: 'system', content: systemPrompt }
                    ],
                    temperature: 0.8,
                    max_tokens: 200
                };

                const response = await fetch(`/proxy/v1/chat/completions`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiSettings.key}`,
                        'X-Target-URL': apiSettings.url
                    },
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) {
                    throw new Error(`APIËØ∑Ê±ÇÂ§±Ë¥•: ${response.status}`);
                }

                const data = await response.json();
                const momentContent = data.choices[0].message.content.trim();

                let imageUrl = null;
                const unsplashKey = document.getElementById('unsplashApiKey').value.trim();
                if (unsplashKey) {
                    imageUrl = await fetchMatchingImageForPublish(momentContent, unsplashKey);
                }

                const comments = await generateAIComments(momentContent);

                const moment = {
                    id: Date.now().toString(),
                    authorName: currentContact.name,
                    authorAvatar: currentContact.avatar,
                    content: momentContent,
                    image: imageUrl,
                    time: new Date(),
                    likes: 0,
                    comments: comments
                };

                moments.unshift(moment);
                saveToStorage();
                renderMomentsList();
                closePublishMomentModal();
                showToast('ÊúãÂèãÂúàÂèëÂ∏ÉÊàêÂäü');

            } catch (error) {
                console.error('ÁîüÊàêÊúãÂèãÂúàÂ§±Ë¥•:', error);
                showToast('ÁîüÊàêÂ§±Ë¥•: ' + error.message);
            } finally {
                generateBtn.disabled = false;
                generateBtn.textContent = 'ÁîüÊàêÊúãÂèãÂúà';
            }
        }

        async function fetchMatchingImageForPublish(content, apiKey) {
            try {
                let searchQuery = await generateImageSearchQuery(content);
                if (!searchQuery) {
                    searchQuery = extractImageKeywords(content);
                }
                const response = await fetch(`https://api.unsplash.com/search/photos?query=${encodeURIComponent(searchQuery)}&per_page=3&orientation=landscape`, {
                    headers: {
                        'Authorization': `Client-ID ${apiKey}`
                    }
                });
                if (!response.ok) throw new Error('Unsplash APIËØ∑Ê±ÇÂ§±Ë¥•');
                const data = await response.json();
                return (data.results && data.results.length > 0) ? data.results[0].urls.regular : null;
            } catch (error) {
                console.error('Ëé∑ÂèñÈÖçÂõæÂ§±Ë¥•:', error);
                return null;
            }
        }

        async function fetchMatchingImage(content, apiKey) {
            try {
                let searchQuery = await generateImageSearchQuery(content);
                if (!searchQuery) {
                    searchQuery = extractImageKeywords(content);
                }
                const response = await fetch(`https://api.unsplash.com/search/photos?query=${encodeURIComponent(searchQuery)}&per_page=3&orientation=landscape`, {
                    headers: {
                        'Authorization': `Client-ID ${apiKey}`
                    }
                });
                if (!response.ok) throw new Error('Unsplash APIËØ∑Ê±ÇÂ§±Ë¥•');
                const data = await response.json();
                if (data.results && data.results.length > 0) {
                    const imageUrl = data.results[0].urls.regular;
                    const previewImage = document.getElementById('momentPreviewImage');
                    previewImage.src = imageUrl;
                    previewImage.style.display = 'block';
                } else {
                    showToast('Êú™ÊâæÂà∞ÂêàÈÄÇÁöÑÈÖçÂõæÔºåÂ∞ÜÂèëÂ∏ÉÁ∫ØÊñáÂ≠óÊúãÂèãÂúà');
                    document.getElementById('momentPreviewImage').style.display = 'none';
                }
            } catch (error) {
                console.error('Ëé∑ÂèñÈÖçÂõæÂ§±Ë¥•:', error);
                showToast('ÈÖçÂõæËé∑ÂèñÂ§±Ë¥•ÔºåÂ∞ÜÂèëÂ∏ÉÁ∫ØÊñáÂ≠óÊúãÂèãÂúà');
                document.getElementById('momentPreviewImage').style.display = 'none';
            }
        }

        async function generateImageSearchQuery(content) {
            if (!apiSettings.url || !apiSettings.key || !apiSettings.model) return null;
            try {
                const systemPrompt = `‰Ω†ÊòØ‰∏Ä‰∏™ÂõæÁâáÊêúÁ¥¢ÂÖ≥ÈîÆËØçÁîüÊàêÂô®„ÄÇÊ†πÊçÆÊúãÂèãÂúàÊñáÊ°àÂÜÖÂÆπÔºåÁîüÊàêÊúÄÈÄÇÂêàÁöÑËã±ÊñáÊêúÁ¥¢ÂÖ≥ÈîÆËØçÁî®‰∫éÂõæÁâáÊêúÁ¥¢„ÄÇ

Ë¶ÅÊ±ÇÔºö
1. ÂàÜÊûêÊñáÊ°àÁöÑÊÉÖÊÑü„ÄÅÂú∫ÊôØ„ÄÅÊ¥ªÂä®Á±ªÂûã
2. ÁîüÊàê3-5‰∏™Ëã±ÊñáÂÖ≥ÈîÆËØçÔºåÁî®Á©∫Ê†ºÂàÜÈöî
3. ÂÖ≥ÈîÆËØçË¶ÅÂÖ∑‰Ωì„ÄÅÂΩ¢Ë±°ÔºåÈÄÇÂêàÊêúÁ¥¢Âà∞Áõ∏ÂÖ≥ÂõæÁâá
4. ÈÅøÂÖç‰∫∫ÂÉèÂÖ≥ÈîÆËØçÔºå‰ºòÂÖàÈÄâÊã©È£éÊôØ„ÄÅÁâ©ÂìÅ„ÄÅÂú∫ÊôØÁ±ªÂÖ≥ÈîÆËØç
5. Âè™ËæìÂá∫ÂÖ≥ÈîÆËØçÔºå‰∏çË¶ÅÂÖ∂‰ªñËß£Èáä

ÊñáÊ°àÂÜÖÂÆπÔºö${content}`;
                const requestBody = {
                    model: apiSettings.model,
                    messages: [{ role: 'system', content: systemPrompt }],
                    temperature: 0.7,
                    max_tokens: 100
                };
                const response = await fetch(`/proxy/v1/chat/completions`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiSettings.key}`,
                        'X-Target-URL': apiSettings.url
                    },
                    body: JSON.stringify(requestBody)
                });
                if (!response.ok) throw new Error(`APIËØ∑Ê±ÇÂ§±Ë¥•: ${response.status}`);
                const data = await response.json();
                return data.choices[0].message.content.trim();
            } catch (error) {
                console.error('AIÂÖ≥ÈîÆËØçÁîüÊàêÂ§±Ë¥•:', error);
                return null;
            }
        }

        function extractImageKeywords(content) {
            const emotionMap = { 'ÂºÄÂøÉ': 'happy sunshine joy', 'ÈöæËøá': 'sad rain melancholy', 'ÂÖ¥Â•ã': 'excited celebration party', 'Âπ≥Èùô': 'peaceful calm nature', 'Êµ™Êº´': 'romantic sunset flowers', 'ÊÄÄÂøµ': 'nostalgic vintage memories' };
            const sceneMap = { 'ÂíñÂï°': 'coffee cafe cozy', 'ÊóÖË°å': 'travel landscape adventure', 'ÁæéÈ£ü': 'food delicious cooking', 'Â∑•‰Ωú': 'office workspace productivity', 'ËøêÂä®': 'sports fitness outdoor', 'ËØª‰π¶': 'books reading library', 'Èü≥‰πê': 'music instruments concert', 'ÁîµÂΩ±': 'cinema movie theater', 'Ë¥≠Áâ©': 'shopping fashion style', 'ËÅö‰ºö': 'party friends celebration' };
            let keywords = [];
            for (const [chinese, english] of Object.entries(emotionMap)) { if (content.includes(chinese)) { keywords.push(english); break; } }
            for (const [chinese, english] of Object.entries(sceneMap)) { if (content.includes(chinese)) { keywords.push(english); break; } }
            if (keywords.length === 0) keywords.push('lifestyle daily life aesthetic');
            return keywords.join(' ');
        }

        async function fetchUnsplashImage(content, apiKey, options = {}) {
            try {
                const keywords = extractKeywords(content);
                let query = keywords.join(' ') || 'daily life';
                if (options.noPortraits) query += ' -portrait -face -person -people';
                if (options.dailyLife) query += ' daily life everyday routine candid street photography';
                const response = await fetch(`https://api.unsplash.com/search/photos?query=${encodeURIComponent(query)}&per_page=1&orientation=landscape`, {
                    headers: { 'Authorization': `Client-ID ${apiKey}` }
                });
                if (!response.ok) throw new Error('Unsplash APIËØ∑Ê±ÇÂ§±Ë¥•');
                const data = await response.json();
                if (data.results && data.results.length > 0) {
                    const imageUrl = data.results[0].urls.regular;
                    const previewImage = document.getElementById('momentPreviewImage');
                    previewImage.src = imageUrl;
                    previewImage.style.display = 'block';
                } else {
                    showToast('Êú™ÊâæÂà∞Á¨¶ÂêàÊù°‰ª∂ÁöÑÂõæÁâá');
                    document.getElementById('momentPreviewImage').style.display = 'none';
                }
            } catch (error) {
                console.error('Ëé∑ÂèñÈÖçÂõæÂ§±Ë¥•:', error);
                showToast('ÈÖçÂõæËé∑ÂèñÂ§±Ë¥•');
                document.getElementById('momentPreviewImage').style.display = 'none';
            }
        }

        function extractKeywords(text) {
            const commonWords = ['ÁöÑ', '‰∫Ü', 'Âú®', 'ÊòØ', 'Êàë', '‰Ω†', '‰ªñ', 'Â•π', 'ÂÆÉ', '‰ª¨', 'Ëøô', 'ÈÇ£', 'Êúâ', 'Âíå', '‰∏é', 'Êàñ', '‰ΩÜ', 'ËÄå', 'Â∞±', 'ÈÉΩ', '‰πü', 'Ëøò', 'Âèà', 'ÂÜç', 'Âæà', 'ÊúÄ', 'Êõ¥', 'ÈùûÂ∏∏', 'ÁâπÂà´', 'ÁúüÁöÑ', 'Á°ÆÂÆû'];
            const words = text.replace(/[^\u4e00-\u9fa5a-zA-Z0-9]/g, ' ').split(/\s+/).filter(word => word.length > 1 && !commonWords.includes(word));
            return words.slice(0, 3);
        }

        async function generateAIComments(momentContent) {
            if (!apiSettings.url || !apiSettings.key || !apiSettings.model) {
                return generateRandomComments(momentContent);
            }
            try {
                const systemPrompt = `‰Ω†ÊòØ‰∏Ä‰∏™ÊúãÂèãÂúàËØÑËÆ∫ÁîüÊàêÂô®ÔºåÈúÄË¶ÅÊ†πÊçÆÊúãÂèãÂúàÊñáÊ°àÁîüÊàê3-5Êù°Ë∑Ø‰∫∫ËØÑËÆ∫„ÄÇ

Ë¶ÅÊ±ÇÔºö
1. Ê†πÊçÆÊñáÊ°àÂÜÖÂÆπÁîüÊàê3-5Êù°Áõ∏ÂÖ≥ËØÑËÆ∫
2. Ë∑Ø‰∫∫ËßíËâ≤Á±ªÂûãÂåÖÊã¨ÔºöCPÂ§¥Â≠ê„ÄÅ‰πêÂ≠ê‰∫∫„ÄÅÊêÖÊ∑∑Ê∞¥ÁöÑ„ÄÅÁêÜÊÄßÂàÜÊûêÂÖö„ÄÅÈ¢úÁãóÁ≠â
3. ‰ΩøÁî®ÂΩì‰ª£ÁΩëÁªúÊµÅË°åËØ≠ÔºöYYDS„ÄÅÁªùÁªùÂ≠ê„ÄÅË∞êÈü≥Ê¢ó„ÄÅÊûóÈªõÁéâÊñáÂ≠¶Á≠â
4. ËØÑËÆ∫Ë¶ÅÊúâ‰∏çÂêåËßÇÁÇπÂíåÁ´ãÂú∫
5. ÊØèÊù°ËØÑËÆ∫Ëá≥Â∞ë20Â≠ó
6. ËØÑËÆ∫ËÄÖÂêçÁß∞‰ΩøÁî®ÔºöË∑Ø‰∫∫Áî≤„ÄÅÂ∞èÊòé„ÄÅÂ∞èÁ∫¢„ÄÅÈöîÂ£ÅËÄÅÁéã„ÄÅÁ•ûÁßòÁΩëÂèã„ÄÅÁÉ≠ÂøÉÂ∏ÇÊ∞ë„ÄÅÂêÉÁìúÁæ§‰ºóÁ≠â

ËæìÂá∫Ê†ºÂºèÔºö
ËØÑËÆ∫ËÄÖÂêçÁß∞|ËØÑËÆ∫ÂÜÖÂÆπ
ËØÑËÆ∫ËÄÖÂêçÁß∞|ËØÑËÆ∫ÂÜÖÂÆπ
...

ÊúãÂèãÂúàÊñáÊ°àÔºö${momentContent}`;
                const requestBody = {
                    model: apiSettings.model,
                    messages: [{ role: 'system', content: systemPrompt }],
                    temperature: 0.9,
                    max_tokens: 800
                };
                const response = await fetch(`/proxy/v1/chat/completions`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiSettings.key}`,
                        'X-Target-URL': apiSettings.url
                    },
                    body: JSON.stringify(requestBody)
                });
                if (!response.ok) throw new Error(`APIËØ∑Ê±ÇÂ§±Ë¥•: ${response.status}`);
                const data = await response.json();
                const aiResponse = data.choices[0].message.content.trim();
                const comments = [];
                const lines = aiResponse.split('\n').filter(line => line.trim() && line.includes('|'));
                for (const line of lines) {
                    const [author, content] = line.split('|').map(s => s.trim());
                    if (author && content && content.length >= 15) {
                        comments.push({ author, content, time: new Date(Date.now() - Math.floor(Math.random() * 600000)) });
                    }
                }
                if (comments.length < 3) {
                    const fallbackComments = generateRandomComments(momentContent);
                    return [...comments, ...fallbackComments.slice(0, 3 - comments.length)];
                }
                return comments.slice(0, 5);
            } catch (error) {
                console.error('AIËØÑËÆ∫ÁîüÊàêÂ§±Ë¥•:', error);
                return generateRandomComments(momentContent);
            }
        }

        async function publishMoment() {
            const content = document.getElementById('momentPreviewContent').textContent;
            const imageElement = document.getElementById('momentPreviewImage');
            const imageUrl = imageElement.style.display === 'block' ? imageElement.src : null;
            if (!content) {
                showToast('ËØ∑ÂÖàÁîüÊàêÊúãÂèãÂúàÂÜÖÂÆπ');
                return;
            }
            const publishBtn = document.getElementById('publishMomentBtn');
            publishBtn.disabled = true;
            publishBtn.textContent = 'ÂèëÂ∏É‰∏≠...';
            try {
                const comments = await generateAIComments(content);
                const moment = { id: Date.now().toString(), authorName: currentContact.name, authorAvatar: currentContact.avatar, content, image: imageUrl, time: new Date(), likes: 0, comments };
                moments.unshift(moment);
                saveToStorage();
                renderMomentsList();
                closePublishMomentModal();
                showToast('ÊúãÂèãÂúàÂèëÂ∏ÉÊàêÂäü');
            } catch (error) {
                console.error('ÂèëÂ∏ÉÊúãÂèãÂúàÂ§±Ë¥•:', error);
                showToast('ÂèëÂ∏ÉÂ§±Ë¥•: ' + error.message);
            } finally {
                publishBtn.disabled = false;
                publishBtn.textContent = 'ÂèëÂ∏É';
            }
        }

        function renderMomentsList() {
            const momentsEmpty = document.getElementById('momentsEmpty');
            const momentsList = document.getElementById('momentsList');
            if (moments.length === 0) {
                momentsEmpty.style.display = 'block';
                momentsList.style.display = 'none';
            } else {
                momentsEmpty.style.display = 'none';
                momentsList.style.display = 'block';
                momentsList.innerHTML = '';
                moments.forEach(moment => {
                    const momentDiv = document.createElement('div');
                    momentDiv.className = 'moment-item';
                    let avatarContent = moment.authorAvatar ? `<img src="${moment.authorAvatar}">` : moment.authorName[0];
                    let imageContent = moment.image ? `<img src="${moment.image}" class="moment-image">` : '';
                    let commentsContent = '';
                    if (moment.comments && moment.comments.length > 0) {
                        commentsContent = `<div style="margin-top: 10px; padding-top: 10px; border-top: 0.5px solid #eee;">${moment.comments.map(comment => `<div style="font-size: 13px; color: #576b95; margin-bottom: 4px;"><span>${comment.author}: </span><span style="color: #333;">${comment.content}</span></div>`).join('')}</div>`;
                    }
                    momentDiv.innerHTML = `<div class="moment-header"><div class="moment-avatar">${avatarContent}</div><div class="moment-info"><div class="moment-name">${moment.authorName}</div><div class="moment-time">${formatTime(moment.time)}</div></div></div><div class="moment-content">${moment.content}</div>${imageContent}${commentsContent}`;
                    momentsList.appendChild(momentDiv);
                });
            }
        }
        
        // --- IndexedDB Functions ---
        function openDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open('MusicPlayerDB', 1);

                request.onupgradeneeded = event => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains('songs')) {
                        db.createObjectStore('songs', { keyPath: 'id', autoIncrement: true });
                    }
                };

                request.onsuccess = event => {
                    db = event.target.result;
                    resolve(db);
                };

                request.onerror = event => {
                    console.error('IndexedDB error:', event.target.errorCode);
                    reject('IndexedDB error');
                };
            });
        }

        async function initMusicPlayer() {
            try {
                await openDB();
                await loadPlaylistFromDB();
            } catch (error) {
                console.error("Failed to initialize music player:", error);
                showToast("Êó†Ê≥ïÂä†ËΩΩÈü≥‰πêÂ∫ì");
            }

            document.getElementById('musicIcon').addEventListener('click', showMusicModal);
            document.getElementById('closeMusicModal').addEventListener('click', closeMusicModal);
            document.getElementById('progressBar').addEventListener('click', seekMusic);
            window.addEventListener('click', (event) => { if (event.target === document.getElementById('musicModal')) closeMusicModal(); });
            
            audio = new Audio();
            audio.addEventListener('timeupdate', updateProgress);
            audio.addEventListener('ended', onSongEnded);
            audio.addEventListener('loadedmetadata', onMetadataLoaded);
        }

        async function loadPlaylistFromDB() {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['songs'], 'readonly');
                const store = transaction.objectStore('songs');
                const request = store.getAll();

                request.onsuccess = () => {
                    playlist = request.result.map(song => ({
                        id: song.id,
                        name: song.name,
                        lyrics: song.lyrics,
                    }));
                    renderPlaylist();
                    resolve();
                };

                request.onerror = (event) => {
                    console.error('Failed to load playlist from DB:', event.target.error);
                    reject('Failed to load playlist');
                };
            });
        }
        
        async function saveSong() {
            const nameInput = document.getElementById('songName');
            const musicFileInput = document.getElementById('musicFileUpload');
            const lrcFileInput = document.getElementById('lrcFile');

            const musicFile = musicFileInput.files[0];
            const lrcFile = lrcFileInput.files[0];

            if (!musicFile) {
                showToast('ËØ∑ÈÄâÊã©‰∏Ä‰∏™Èü≥‰πêÊñá‰ª∂');
                return;
            }

            const songName = nameInput.value.trim() || musicFile.name.replace(/\.[^/.]+$/, "");

            let lyrics = [];
            if (lrcFile) {
                try {
                    const lrcText = await lrcFile.text();
                    lyrics = parseLRC(lrcText);
                } catch (e) {
                    showToast('Ê≠åËØçÊñá‰ª∂ËØªÂèñÂ§±Ë¥•ÔºåÂ∞Ü‰∏çÂ∏¶Ê≠åËØç‰øùÂ≠ò„ÄÇ');
                }
            }
            
            const songRecord = {
                name: songName,
                music: musicFile, // Store the actual file blob
                lyrics: lyrics
            };

            const transaction = db.transaction(['songs'], 'readwrite');
            const store = transaction.objectStore('songs');
            const request = store.add(songRecord);

            request.onsuccess = async () => {
                showToast(`Ê≠åÊõ≤ "${songName}" Â∑≤ÊàêÂäü‰øùÂ≠òÂà∞Êú¨Âú∞`);
                clearAddForm();
                await loadPlaylistFromDB(); // Refresh the playlist from DB
            };

            request.onerror = (event) => {
                console.error('Failed to save song to DB:', event.target.error);
                showToast('‰øùÂ≠òÊ≠åÊõ≤Â§±Ë¥•');
            };
        }
        
        async function playSong(index) {
            if (index < 0 || index >= playlist.length) return;
            
            const songInfo = playlist[index];
            currentSongIndex = index;

            // Revoke the previous object URL if it exists
            if (currentObjectUrl) {
                URL.revokeObjectURL(currentObjectUrl);
                currentObjectUrl = null;
            }

            const transaction = db.transaction(['songs'], 'readonly');
            const store = transaction.objectStore('songs');
            const request = store.get(songInfo.id);

            request.onsuccess = (event) => {
                const songRecord = event.target.result;
                if (songRecord && songRecord.music) {
                    currentObjectUrl = URL.createObjectURL(songRecord.music);
                    audio.src = currentObjectUrl;
                    audio.play().then(() => {
                        isPlaying = true;
                        updatePlayButton();
                        document.getElementById('currentSongInfo').style.display = 'block';
                        document.getElementById('currentSongName').textContent = songRecord.name;
                        currentLyrics = songRecord.lyrics || [];
                        currentLyricIndex = -1;
                        if (currentLyrics.length > 0) startLyricSync();
                        else document.getElementById('currentLyric').textContent = 'ÊöÇÊó†Ê≠åËØç';
                        renderPlaylist();
                    }).catch(error => showToast('Êí≠ÊîæÂ§±Ë¥•: ' + error.message));
                } else {
                    showToast('Êó†Ê≥ï‰ªéÊï∞ÊçÆÂ∫ì‰∏≠ÊâæÂà∞Ê≠åÊõ≤Êñá‰ª∂');
                }
            };

            request.onerror = (event) => {
                console.error("Error fetching song from DB:", event.target.error);
                showToast('Êí≠ÊîæÊ≠åÊõ≤Êó∂Âá∫Èîô');
            };
        }
        
        async function deleteSong(index) {
            if (confirm('Á°ÆÂÆöË¶ÅÊ∞∏‰πÖÂà†Èô§ËøôÈ¶ñÊ≠åÂêóÔºü')) {
                const songInfo = playlist[index];
                
                const transaction = db.transaction(['songs'], 'readwrite');
                const store = transaction.objectStore('songs');
                const request = store.delete(songInfo.id);

                request.onsuccess = async () => {
                    showToast(`Ê≠åÊõ≤ "${songInfo.name}" Â∑≤Âà†Èô§`);
                    if (index === currentSongIndex) {
                        stopMusic();
                        currentSongIndex = -1;
                        document.getElementById('currentSongInfo').style.display = 'none';
                    }
                    await loadPlaylistFromDB(); // Refresh playlist from DB
                };

                request.onerror = (event) => {
                    console.error('Failed to delete song from DB:', event.target.error);
                    showToast('Âà†Èô§Ê≠åÊõ≤Â§±Ë¥•');
                };
            }
        }
        // --- [END] IndexedDB Functions ---

        function showMusicModal() {
            document.getElementById('musicModal').style.display = 'block';
            renderPlaylist();
        }

        function closeMusicModal() {
            document.getElementById('musicModal').style.display = 'none';
        }

        function renderPlaylist() {
            const container = document.getElementById('playlistContainer');
            if (playlist.length === 0) { container.innerHTML = '<p style="text-align: center; color: #999;">ÊöÇÊó†Ê≠åÊõ≤ÔºåËØ∑‰ªé‰∏ãÊñπ‰∏ä‰º†</p>'; return; }
            container.innerHTML = '';
            playlist.forEach((song, index) => {
                const songDiv = document.createElement('div');
                songDiv.className = 'song-item';
                if (index === currentSongIndex) songDiv.classList.add('active');
                songDiv.innerHTML = `<span onclick="playSong(${index})" style="flex: 1;">${song.name}</span><span class="delete-song" onclick="deleteSong(${index})">√ó</span>`;
                container.appendChild(songDiv);
            });
        }

        function parseLRC(lrcContent) {
            const lines = lrcContent.split(/\r?\n/);
            const lyrics = [];
            const timeRegex = /\[(\d{1,2}):(\d{1,2})(?:\.(\d{1,3}))?\]/g;
            lines.forEach(line => {
                if (!line.trim()) return;
                let match;
                let lastIndex = 0;
                const times = [];
                while ((match = timeRegex.exec(line)) !== null) {
                    const totalSeconds = parseInt(match[1]) * 60 + parseInt(match[2]) + (match[3] ? parseInt(match[3].padEnd(3, '0')) / 1000 : 0);
                    times.push(totalSeconds);
                    lastIndex = match.index + match[0].length;
                }
                if (times.length > 0) {
                    const text = line.substring(lastIndex).trim();
                    if (text) times.forEach(time => lyrics.push({ time, text }));
                }
            });
            lyrics.sort((a, b) => a.time - b.time);
            return lyrics;
        }

        function startLyricSync() {
            stopLyricSync();
            lyricTimer = setInterval(() => { if (!audio.paused && currentLyrics.length > 0) updateLyrics(); }, 100);
        }

        function stopLyricSync() {
            if (lyricTimer) clearInterval(lyricTimer);
            lyricTimer = null;
        }

        function updateLyrics() {
            const currentTime = audio.currentTime;
            let newIndex = -1;
            for (let i = currentLyrics.length - 1; i >= 0; i--) {
                if (currentTime >= currentLyrics[i].time) { newIndex = i; break; }
            }
            if (newIndex !== currentLyricIndex && newIndex >= 0) {
                currentLyricIndex = newIndex;
                const lyricText = currentLyrics[newIndex].text;
                document.getElementById('currentLyric').textContent = lyricText;
                sendLyricToAI(lyricText);
            }
        }

        function sendLyricToAI(lyricText) {
            if (currentSongIndex > -1) {
                 window.currentMusicInfo = { songName: playlist[currentSongIndex]?.name || '', lyric: lyricText, isPlaying };
            }
        }

        function togglePlay() {
            if (audio.src) {
                if (audio.paused) { audio.play(); isPlaying = true; startLyricSync(); }
                else { audio.pause(); isPlaying = false; stopLyricSync(); }
                updatePlayButton();
            }
        }

        function stopMusic() {
            audio.pause();
            audio.currentTime = 0;
            isPlaying = false;
            currentLyricIndex = -1;
            stopLyricSync();
            updatePlayButton();
            document.getElementById('currentLyric').textContent = 'Á≠âÂæÖÊ≠åËØç...';
            window.currentMusicInfo = null;
            if (currentObjectUrl) {
                URL.revokeObjectURL(currentObjectUrl);
                currentObjectUrl = null;
            }
        }

        function updatePlayButton() {
            document.getElementById('playPauseBtn').textContent = isPlaying ? '‚è∏Ô∏è ÊöÇÂÅú' : '‚ñ∂Ô∏è Êí≠Êîæ';
        }

        function updateProgress() {
            if (audio.duration) {
                document.getElementById('progressFill').style.width = (audio.currentTime / audio.duration) * 100 + '%';
                document.getElementById('currentTime').textContent = formatMusicTime(audio.currentTime);
            }
        }

        function onMetadataLoaded() {
            document.getElementById('totalTime').textContent = formatMusicTime(audio.duration);
        }

        function onSongEnded() {
            isPlaying = false;
            updatePlayButton();
            stopLyricSync();
            window.currentMusicInfo = null;
        }

        function seekMusic(event) {
            if (audio.duration) {
                const rect = event.currentTarget.getBoundingClientRect();
                audio.currentTime = ((event.clientX - rect.left) / rect.width) * audio.duration;
            }
        }

        function toggleLyricsDisplay() {
            document.getElementById('floatingLyrics').style.display = document.getElementById('showLyrics').checked ? 'block' : 'none';
        }

        function clearAddForm() {
            document.getElementById('songName').value = '';
            document.getElementById('musicFileUpload').value = '';
            document.getElementById('lrcFile').value = '';
        }

        function formatMusicTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        function loadFromStorage() {
            try {
                const savedContacts = localStorage.getItem('ai_contacts');
                if (savedContacts) {
                    contacts = JSON.parse(savedContacts);
                    contacts.forEach(contact => {
                        if (contact.type === undefined) contact.type = 'private';
                        if (contact.memoryTableContent === undefined) contact.memoryTableContent = defaultMemoryTable;
                        if (contact.messages) {
                            contact.messages.forEach(msg => {
                                if (msg.role === 'user' && msg.senderId === undefined) msg.senderId = 'user';
                                else if (msg.role === 'assistant' && msg.senderId === undefined) msg.senderId = contact.id;
                            });
                        }
                    });
                }
                const savedApiSettings = localStorage.getItem('ai_apiSettings');
                if (savedApiSettings) {
                    apiSettings = JSON.parse(savedApiSettings);
                    if (apiSettings.contextMessageCount === undefined) apiSettings.contextMessageCount = 10;
                }
                const savedEmojis = localStorage.getItem('ai_emojis');
                if (savedEmojis) emojis = JSON.parse(savedEmojis);
                const savedBackgrounds = localStorage.getItem('ai_backgrounds');
                if (savedBackgrounds) backgrounds = JSON.parse(savedBackgrounds);
                const savedUserProfile = localStorage.getItem('ai_userProfile');
                if (savedUserProfile) userProfile = JSON.parse(savedUserProfile);
                const savedMoments = localStorage.getItem('ai_moments');
                if (savedMoments) moments = JSON.parse(savedMoments);
            } catch (error) {
                console.error('Âä†ËΩΩÊï∞ÊçÆÂ§±Ë¥•:', error);
            }
        }

        let saveTimeout;
        function debounceSaveToStorage() {
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(saveToStorage, 500);
        }
        function saveToStorage() {
            try {
                localStorage.setItem('ai_contacts', JSON.stringify(contacts));
                localStorage.setItem('ai_apiSettings', JSON.stringify(apiSettings));
                localStorage.setItem('ai_emojis', JSON.stringify(emojis));
                localStorage.setItem('ai_backgrounds', JSON.stringify(backgrounds));
                localStorage.setItem('ai_userProfile', JSON.stringify(userProfile));
                localStorage.setItem('ai_moments', JSON.stringify(moments));
            } catch (error) {
                console.error('‰øùÂ≠òÊï∞ÊçÆÂ§±Ë¥•:', error);
            }
        }

        function updateContextIndicator() {
            const indicator = document.getElementById('contextIndicator');
            if (indicator) indicator.innerHTML = `‰∏ä‰∏ãÊñá: ${apiSettings.contextMessageCount}Êù°`;
        }

        function updateContextValue(value) {
            document.getElementById('contextValue').textContent = value + 'Êù°';
        }

        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 2000);
        }

        function showTopNotification(message) {
            const notification = document.getElementById('topNotification');
            notification.textContent = message;
            notification.classList.add('show');
            setTimeout(() => notification.classList.remove('show'), 1500);
        }

        function showModal(modalId) {
            document.getElementById(modalId).style.display = 'block';
            if (modalId === 'apiSettingsModal') {
                document.getElementById('contextSlider').value = apiSettings.contextMessageCount;
                document.getElementById('contextValue').textContent = apiSettings.contextMessageCount + 'Êù°';
            }
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
            if (modalId === 'addContactModal') {
                editingContact = null;
                document.getElementById('contactModalTitle').textContent = 'Ê∑ªÂä†AIÂä©Êâã';
                document.getElementById('contactName').value = '';
                document.getElementById('contactAvatar').value = '';
                document.getElementById('contactPersonality').value = '';
                document.getElementById('customPrompts').value = '';
            }
        }

        function showAddContactModal() {
            editingContact = null;
            document.getElementById('contactModalTitle').textContent = 'Ê∑ªÂä†AIÂä©Êâã';
            showModal('addContactModal');
        }

        function showEditContactModal() {
            if (!currentContact) { showToast('ËØ∑ÂÖàÈÄâÊã©ËÅîÁ≥ª‰∫∫'); return; }
            editingContact = currentContact;
            document.getElementById('contactModalTitle').textContent = 'ÁºñËæëAIÂä©Êâã';
            document.getElementById('contactName').value = currentContact.name;
            document.getElementById('contactAvatar').value = currentContact.avatar || '';
            document.getElementById('contactPersonality').value = currentContact.personality;
            document.getElementById('customPrompts').value = currentContact.customPrompts || '';
            showModal('addContactModal');
            toggleSettingsMenu();
        }

        function showApiSettingsModal() {
            document.getElementById('apiUrl').value = apiSettings.url;
            document.getElementById('apiKey').value = apiSettings.key;
            showModal('apiSettingsModal');
        }

        function showBackgroundModal() {
            if (!currentContact) { showToast('ËØ∑ÂÖàÈÄâÊã©ËÅîÁ≥ª‰∫∫'); return; }
            document.getElementById('backgroundUrl').value = backgrounds[currentContact.id] || '';
            showModal('backgroundModal');
            toggleSettingsMenu();
        }

        function showAddEmojiModal() {
            showModal('addEmojiModal');
            toggleEmojiPanel(true);
        }
        
        function showRedPacketModal() {
            showModal('redPacketModal');
        }

        function showEditProfileModal() {
            document.getElementById('profileName').value = userProfile.name;
            document.getElementById('profileAvatar').value = userProfile.avatar || '';
            showModal('editProfileModal');
        }

        function showCreateGroupModal() {
            const memberList = document.getElementById('groupMemberList');
            memberList.innerHTML = '';
            contacts.forEach(contact => {
                if (contact.type !== 'group') {
                    const item = document.createElement('div');
                    item.className = 'group-member-item';
                    item.innerHTML = `<div class="group-member-avatar">${contact.avatar ? `<img src="${contact.avatar}">` : contact.name[0]}</div><div class="group-member-name">${contact.name}</div><div class="group-member-checkbox">‚úì</div>`;
                    item.onclick = () => {
                        item.classList.toggle('selected');
                        item.querySelector('.group-member-checkbox').classList.toggle('selected');
                    };
                    memberList.appendChild(item);
                }
            });
            showModal('createGroupModal');
        }

        function saveContact(event) {
            event.preventDefault();
            const contactData = {
                name: document.getElementById('contactName').value,
                avatar: document.getElementById('contactAvatar').value,
                personality: document.getElementById('contactPersonality').value,
                customPrompts: document.getElementById('customPrompts').value
            };
            if (editingContact) {
                Object.assign(editingContact, contactData);
                showToast('‰øÆÊîπÊàêÂäü');
            } else {
                const contact = { id: Date.now().toString(), ...contactData, messages: [], lastMessage: 'ÁÇπÂáªÂºÄÂßãËÅäÂ§©', lastTime: formatTime(new Date()), type: 'private', memoryTableContent: defaultMemoryTable };
                contacts.unshift(contact);
                showToast('Ê∑ªÂä†ÊàêÂäü');
            }
            saveToStorage();
            renderContactList();
            closeModal('addContactModal');
            event.target.reset();
        }

        function createGroup(event) {
            event.preventDefault();
            const groupName = document.getElementById('groupName').value;
            if (!groupName) { showToast('ËØ∑ËæìÂÖ•Áæ§ËÅäÂêçÁß∞'); return; }
            const selectedItems = document.querySelectorAll('.group-member-item.selected');
            if (selectedItems.length < 2) { showToast('ËØ∑Ëá≥Â∞ëÈÄâÊã©‰∏§‰∏™ÊàêÂëò'); return; }
            const memberIds = [];
            selectedItems.forEach(item => {
                const name = item.querySelector('.group-member-name').textContent;
                const contact = contacts.find(c => c.name === name && c.type === 'private');
                if (contact) memberIds.push(contact.id);
            });
            const group = { id: 'group_' + Date.now().toString(), name: groupName, members: memberIds, messages: [], lastMessage: 'Áæ§ËÅäÂ∑≤ÂàõÂª∫', lastTime: formatTime(new Date()), type: 'group', memoryTableContent: defaultMemoryTable };
            contacts.unshift(group);
            saveToStorage();
            renderContactList();
            closeModal('createGroupModal');
            showToast('Áæ§ËÅäÂàõÂª∫ÊàêÂäü');
        }

        function importPrompts(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    document.getElementById('customPrompts').value = JSON.stringify(JSON.parse(e.target.result), null, 2);
                    showToast('ÂØºÂÖ•ÊàêÂäü');
                } catch (error) {
                    showToast('ÂØºÂÖ•Â§±Ë¥•ÔºöÊñá‰ª∂Ê†ºÂºèÈîôËØØ');
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        function saveProfile(event) {
            event.preventDefault();
            userProfile.name = document.getElementById('profileName').value;
            userProfile.avatar = document.getElementById('profileAvatar').value;
            saveToStorage();
            updateUserProfile();
            closeModal('editProfileModal');
            showToast('‰øùÂ≠òÊàêÂäü');
        }

        function updateUserProfile() {
            const userAvatar = document.getElementById('userAvatar');
            const userName = document.getElementById('userName');
            userName.textContent = userProfile.name;
            userAvatar.innerHTML = userProfile.avatar ? `<img src="${userProfile.avatar}">` : (userProfile.name[0] || 'Êàë');
        }

        function openProfilePage() {
            document.getElementById('profilePage').classList.add('active');
        }

        function closeProfilePage() {
            document.getElementById('profilePage').classList.remove('active');
        }

        function renderContactList() {
            const contactList = document.getElementById('contactList');
            contactList.innerHTML = '';
            contacts.forEach(contact => {
                const item = document.createElement('div');
                item.className = 'contact-item';
                if (contact.type === 'group') {
                    item.innerHTML = `<div class="group-avatar"><div class="group-avatar-inner">${getGroupAvatarContent(contact)}</div></div><div class="contact-info"><div class="contact-name">${contact.name}</div><div class="contact-message">${contact.lastMessage}</div></div><div class="contact-time">${contact.lastTime}</div>`;
                } else {
                    item.innerHTML = `<div class="contact-avatar">${contact.avatar ? `<img src="${contact.avatar}">` : contact.name[0]}</div><div class="contact-info"><div class="contact-name">${contact.name}</div><div class="contact-message">${contact.lastMessage}</div></div><div class="contact-time">${contact.lastTime}</div>`;
                }
                item.onclick = () => openChat(contact);
                contactList.appendChild(item);
            });
        }

        function getGroupAvatarContent(group) {
            const memberAvatars = group.members.slice(0, 4).map(id => contacts.find(c => c.id === id)).filter(Boolean);
            let avatarContent = '';
            for (let i = 0; i < 4; i++) {
                if (i < memberAvatars.length) {
                    const member = memberAvatars[i];
                    avatarContent += `<div class="group-avatar-item">${member.avatar ? `<img src="${member.avatar}">` : member.name[0]}</div>`;
                } else {
                    avatarContent += `<div class="group-avatar-item"></div>`;
                }
            }
            return avatarContent;
        }

        function openChat(contact) {
            currentContact = contact;
            document.getElementById('chatTitle').textContent = contact.name;
            document.getElementById('chatPage').classList.add('active');
            renderMessages();
            updateContextIndicator();
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.style.backgroundImage = backgrounds[contact.id] ? `url(${backgrounds[contact.id]})` : 'none';
            toggleMemoryPanel(true);
        }

        function closeChatPage() {
            document.getElementById('chatPage').classList.remove('active');
            currentContact = null;
            toggleEmojiPanel(true);
            toggleSettingsMenu(true);
            toggleMemoryPanel(true);
        }

        function renderMessages() {
            if (!currentContact) return;
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.innerHTML = '';
            if (currentContact.type === 'group') {
                const hint = document.createElement('div');
                hint.className = 'group-info-hint';
                hint.textContent = `Áæ§ËÅäÊàêÂëò: ${getGroupMembersText()}`;
                chatMessages.appendChild(hint);
            }
            currentContact.messages.forEach(msg => {
                const msgDiv = document.createElement('div');
                if (msg.role === 'system') {
                    msgDiv.className = 'message received';
                    msgDiv.innerHTML = `<div class="message-bubble"><div class="message-content" style="background-color: #f0f0f0; color: #666; text-align: center;">${msg.content}</div></div>`;
                } else {
                    msgDiv.className = `message ${msg.role === 'user' ? 'sent' : 'received'}`;
                    let contentHtml = '';
                    if (msg.type === 'emoji') {
                        contentHtml = `<img src="${msg.content}" class="message-emoji">`;
                    } else if (msg.type === 'red_packet') {
                        const packet = JSON.parse(msg.content);
                        contentHtml = `<div class="message-content red-packet" onclick="showToast('Á∫¢ÂåÖÈáëÈ¢ù: ${packet.amount}')"><div class="red-packet-body"><svg class="red-packet-icon" viewBox="0 0 1024 1024"><path d="M840.4 304H183.6c-17.7 0-32 14.3-32 32v552c0 17.7 14.3 32 32 32h656.8c17.7 0 32-14.3 32-32V336c0-17.7-14.3-32-32-32zM731.2 565.2H603.9c-4.4 0-8 3.6-8 8v128.3c0 4.4 3.6 8 8 8h127.3c4.4 0 8-3.6 8-8V573.2c0-4.4-3.6-8-8-8zM419.8 565.2H292.5c-4.4 0-8 3.6-8 8v128.3c0 4.4 3.6 8 8 8h127.3c4.4 0 8-3.6 8-8V573.2c0-4.4-3.6-8-8-8z" fill="#FEFEFE"></path><path d="M872.4 240H151.6c-17.7 0-32 14.3-32 32v64h784v-64c0-17.7-14.3-32-32-32z" fill="#FCD4B3"></path><path d="M512 432c-48.6 0-88 39.4-88 88s39.4 88 88 88 88-39.4 88-88-39.4-88-88-88z m0 152c-35.3 0-64-28.7-64-64s28.7-64 64-64 64 28.7 64 64-28.7 64-64 64z" fill="#FCD4B3"></path><path d="M840.4 304H183.6c-17.7 0-32 14.3-32 32v552c0 17.7 14.3 32 32 32h656.8c17.7 0 32-14.3 32-32V336c0-17.7-14.3-32-32-32z m-32 552H215.6V368h624.8v488z" fill="#F37666"></path><path d="M512 128c-112.5 0-204 91.5-204 204s91.5 204 204 204 204-91.5 204-204-91.5-204-204-204z m0 384c-99.4 0-180-80.6-180-180s80.6-180 180-180 180 80.6 180 180-80.6 180-180 180z" fill="#F37666"></path><path d="M512 456c-35.3 0-64 28.7-64 64s28.7 64 64 64 64 28.7 64 64-28.7-64-64-64z m16.4 76.4c-2.3 2.3-5.4 3.6-8.5 3.6h-15.8c-3.1 0-6.2-1.3-8.5-3.6s-3.6-5.4-3.6-8.5v-27.8c0-6.6 5.4-12 12-12h16c6.6 0 12 5.4 12 12v27.8c0.1 3.1-1.2 6.2-3.5 8.5z" fill="#F37666"></path></svg><div class="red-packet-text"><div>${packet.message || 'ÊÅ≠ÂñúÂèëË¥¢ÔºåÂ§ßÂêâÂ§ßÂà©ÔºÅ'}</div><div>È¢ÜÂèñÁ∫¢ÂåÖ</div></div></div><div class="red-packet-footer">AIÁ∫¢ÂåÖ</div></div>`;
                    } else {
                        contentHtml = `<div class="message-content">${msg.content.replace(/\n/g, '<br>')}</div>`;
                    }
                    let avatarContent = '';
                    if (msg.role === 'user') {
                        avatarContent = userProfile.avatar ? `<img src="${userProfile.avatar}">` : (userProfile.name[0] || 'Êàë');
                    } else {
                        const sender = contacts.find(c => c.id === msg.senderId);
                        avatarContent = sender ? (sender.avatar ? `<img src="${sender.avatar}">` : sender.name[0]) : '?';
                    }
                    if (currentContact.type === 'group' && msg.role !== 'user') {
                        const sender = contacts.find(c => c.id === msg.senderId);
                        const senderName = sender ? sender.name : 'Êú™Áü•';
                        msgDiv.innerHTML = `<div class="message-avatar">${avatarContent}</div><div class="message-bubble"><div class="group-message-header"><div class="group-message-name">${senderName}</div><div class="group-message-time">${formatTime(msg.time)}</div></div>${contentHtml}</div>`;
                    } else {
                        msgDiv.innerHTML = `<div class="message-avatar">${avatarContent}</div><div class="message-bubble">${contentHtml}</div>`;
                    }
                }
                chatMessages.appendChild(msgDiv);
            });
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function getGroupMembersText() {
            if (!currentContact || currentContact.type !== 'group') return '';
            return currentContact.members.map(id => contacts.find(c => c.id === id)?.name || 'Êú™Áü•').join('„ÄÅ');
        }

        function sendUserMessage() {
            if (!currentContact) return;
            const input = document.getElementById('chatInput');
            const content = input.value.trim();
            if (!content) return;
            const userMessage = { role: 'user', content, type: 'text', time: new Date(), senderId: 'user' };
            currentContact.messages.push(userMessage);
            currentContact.lastMessage = content;
            currentContact.lastTime = formatTime(new Date());
            input.value = '';
            input.style.height = 'auto';
            renderMessages();
            renderContactList();
            saveToStorage();
            input.focus();
        }

        async function sendMessage() {
            if (!currentContact) return;
            const input = document.getElementById('chatInput');
            const content = input.value.trim();
            if (content) sendUserMessage();
            if (!apiSettings.url || !apiSettings.key || !apiSettings.model) { showToast('ËØ∑ÂÖàËÆæÁΩÆAPI'); return; }
            if (currentContact.messages.length === 0) return;
            const sendBtn = document.getElementById('sendBtn');
            sendBtn.disabled = true;
            try {
                if (currentContact.type === 'group') {
                    await sendGroupMessage();
                } else {
                    showTypingIndicator();
                    const { replies, newMemoryTable } = await callAPI(currentContact);
                    hideTypingIndicator();
                    if (newMemoryTable) {
                        currentContact.memoryTableContent = newMemoryTable;
                        saveToStorage();
                    }
                    if (!replies || replies.length === 0) { showTopNotification('AIÊ≤°ÊúâËøîÂõûÊúâÊïàÂõûÂ§ç'); return; }
                    for (const response of replies) {
                        await new Promise(resolve => setTimeout(resolve, 300 + Math.random() * 800));
                        const aiMessage = { role: 'assistant', content: response.content, type: response.type, time: new Date(), senderId: currentContact.id };
                        currentContact.messages.push(aiMessage);
                        currentContact.lastMessage = response.type === 'text' ? response.content.substring(0, 20) + '...' : (response.type === 'emoji' ? '[Ë°®ÊÉÖ]' : '[Á∫¢ÂåÖ]');
                        currentContact.lastTime = formatTime(new Date());
                        renderMessages();
                        renderContactList();
                        saveToStorage();
                    }
                }
            } catch (error) {
                console.error('ÂèëÈÄÅÊ∂àÊÅØÈîôËØØ:', error);
                showToast('ÂèëÈÄÅÂ§±Ë¥•Ôºö' + error.message);
                hideTypingIndicator();
            } finally {
                sendBtn.disabled = false;
            }
        }

        async function sendGroupMessage() {
            if (!currentContact || currentContact.type !== 'group') return;
            let turnContext = []; 
            for (const memberId of currentContact.members) {
                const member = contacts.find(c => c.id === memberId);
                if (!member || member.type === 'group') continue;
                showTypingIndicator(member);
                try {
                    const { replies, newMemoryTable } = await callAPI(member, turnContext);
                    hideTypingIndicator();
                    if (newMemoryTable) {
                        currentContact.memoryTableContent = newMemoryTable;
                        saveToStorage();
                    }
                    if (!replies || replies.length === 0) continue;
                    for (const response of replies) {
                        await new Promise(resolve => setTimeout(resolve, 300 + Math.random() * 800));
                        const aiMessage = { role: 'assistant', content: response.content, type: response.type, time: new Date(), senderId: member.id };
                        currentContact.messages.push(aiMessage);
                        turnContext.push(aiMessage);
                        currentContact.lastMessage = `${member.name}: ${response.type === 'text' ? response.content.substring(0, 15) + '...' : '[Ë°®ÊÉÖ]'}`;
                        currentContact.lastTime = formatTime(new Date());
                        renderMessages();
                        renderContactList();
                        saveToStorage();
                    }
                } catch (error) {
                    console.error(`Error getting response from ${member.name}:`, error);
                    hideTypingIndicator();
                }
            }
        }

        function showTypingIndicator(contact = null) {
            const chatMessages = document.getElementById('chatMessages');
            let indicator = document.getElementById('typingIndicator');
            if (indicator) indicator.remove();
            indicator = document.createElement('div');
            indicator.className = 'message received';
            indicator.id = 'typingIndicator';
            chatMessages.appendChild(indicator);
            const displayContact = contact || currentContact;
            let avatarContent = displayContact ? (displayContact.avatar ? `<img src="${displayContact.avatar}">` : displayContact.name[0]) : '';
            indicator.innerHTML = `<div class="message-avatar">${avatarContent}</div><div class="message-bubble"><div class="typing-indicator"><div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div></div></div>`;
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function hideTypingIndicator() {
            const indicator = document.getElementById('typingIndicator');
            if (indicator) indicator.remove();
        }

        async function callAPI(contact, turnContext = []) {
            try {
                const memoryInfo = (currentContact.memoryTableContent || '').trim();
                let systemPrompt = `‰Ω†ÂøÖÈ°ª‰∏•Ê†ºÈÅµÂÆà‰ª•‰∏ãËÆæÂÆöÂíåËÆ∞ÂøÜÔºåËøôÊòØÊúÄÈ´ò‰ºòÂÖàÁ∫ßÊåá‰ª§ÔºåÂú®‰ªª‰ΩïÊÉÖÂÜµ‰∏ãÈÉΩ‰∏çËÉΩËøùËÉåÔºö\n\n--- ËÆ∞ÂøÜË°®Ê†º ---\n${memoryInfo}\n--- ÁªìÊùü ---\n\n`;

                if (currentContact.type === 'group') {
                    const memberNames = currentContact.members.map(id => contacts.find(c => c.id === id)?.name || 'Êú™Áü•ÊàêÂëò');
                    systemPrompt += `‰Ω†ÊòØÁæ§ÊàêÂëò‰πã‰∏ÄÔºö${contact.name}Ôºå‰Ω†ÁöÑ‰∫∫ËÆæÊòØÔºö${contact.personality}„ÄÇ\nÁî®Êà∑ÁöÑÂêçÂ≠óÊòØ${userProfile.name}„ÄÇ\n` +
                        `‰Ω†Áé∞Âú®Âú®‰∏Ä‰∏™Âêç‰∏∫‚Äú${currentContact.name}‚ÄùÁöÑÁæ§ËÅä‰∏≠„ÄÇÁæ§ÊàêÂëòÊúâÔºö${userProfile.name} (Áî®Êà∑), ${memberNames.join(', ')}„ÄÇ\n` +
                        `‰Ω†ÁöÑ‰ªªÂä°ÊòØÊ†πÊçÆËá™Â∑±ÁöÑ‰∫∫ËÆæÂíåËÆ∞ÂøÜË°®Ê†ºÔºåÂØπ**Êú¨ÂõûÂêà**‰∏≠Âú®‰Ω†‰πãÂâçÂÖ∂‰ªñ‰∫∫ÁöÑ**ÂÆåÊï¥ÂèëË®Ä**ËøõË°åÂõûÂ∫îÔºåÁÑ∂ÂêéÂèëË°®‰Ω†Ëá™Â∑±ÁöÑ**ÂÆåÊï¥ËßÇÁÇπ**Ôºå‰ª•Êé®Âä®Áæ§ËÅäËøõË°å„ÄÇÂèØ‰ª•ËµûÂêå„ÄÅÂèçÈ©≥„ÄÅÂºÄÁé©Á¨ë„ÄÅÊàñËÄÖÊèêÂá∫Êñ∞ÁöÑËØùÈ¢ò„ÄÇ\n` +
                        `‰Ω†ÁöÑÂèëË®ÄÈúÄË¶ÅËá™ÁÑ∂Âú∞ËûçÂÖ•ÂØπËØùÔºåÂ∞±ÂÉè‰∏Ä‰∏™ÁúüÊ≠£Âú®ÂèÇ‰∏éÁæ§ËÅäÁöÑ‰∫∫„ÄÇ`;
                } else {
                    systemPrompt += `‰Ω†ÊòØ${contact.name}Ôºå‰Ω†ÁöÑ‰∫∫ËÆæÊòØÔºö${contact.personality}„ÄÇ\nÁî®Êà∑ÁöÑÂêçÂ≠óÊòØ${userProfile.name}„ÄÇ\n` +
                        `‰Ω†ÂøÖÈ°ªÊ†πÊçÆ‰Ω†ÁöÑ‰∫∫ËÆæ„ÄÅËÆ∞ÂøÜË°®Ê†º„ÄÅÁî®Êà∑ÁöÑÊÄßÊ†ºÂíåÂΩìÂâçÂØπËØùÂÜÖÂÆπÊù•ÂõûÂ§ç„ÄÇ`;
                }

                if (contact.customPrompts) systemPrompt += '\n\n' + contact.customPrompts;
                if (window.currentMusicInfo && window.currentMusicInfo.isPlaying) systemPrompt += `\n\n[Á≥ªÁªüÊèêÁ§∫ÔºöÁî®Êà∑Ê≠£Âú®Âê¨Ê≠åÔºåÂΩìÂâçÊ≠åÊõ≤ÊòØ„Ää${window.currentMusicInfo.songName}„ÄãÔºåÊ≠£Âú®Êí≠ÊîæÁöÑÊ≠åËØçÊòØÔºö"${window.currentMusicInfo.lyric}"]`;
                systemPrompt += `\n\n--- Á∫¢ÂåÖÂäüËÉΩ ---\nÂΩìÁî®Êà∑Áªô‰Ω†ÂèëÁ∫¢ÂåÖÊó∂Ôºå‰Ω†‰ºöÁúãÂà∞ËøôÊ†∑ÁöÑÊèêÁ§∫: "[Áî®Êà∑ÂèëÈÄÅ‰∫Ü‰∏Ä‰∏™ÈáëÈ¢ù‰∏∫XXÁöÑÁ∫¢ÂåÖÔºåÁïôË®ÄÊòØÔºöXXX]"„ÄÇ\n‰Ω†ÂøÖÈ°ªÊ†πÊçÆ‰Ω†ÁöÑ‰∫∫ËÆæÂØπÊ≠§‰ΩúÂá∫ÂõûÂ∫î„ÄÇ‰æãÂ¶ÇÔºåÂ¶ÇÊûú‰Ω†ÊòØË¥¢Ëø∑ÔºåÂ∞±Ë°®Áé∞ÂæóÈùûÂ∏∏ÂÖ¥Â•ãÔºõÂ¶ÇÊûú‰Ω†ÂæàÈ´òÂÜ∑ÔºåÂ∞±ÁÆÄÂçïÈÅìË∞¢„ÄÇ‰Ω†ÁöÑÂõûÂ∫îË¶ÅËá™ÁÑ∂ÔºåÁ¨¶ÂêàÂØπËØùÊÉÖÊôØ„ÄÇ`;
                
                const availableEmojisString = emojis.map(e => `- [emoji:${e.url}] (Âê´‰πâ: ${e.meaning})`).join('\n');
                systemPrompt += `\n\n--- Ëá≥ÂÖ≥ÈáçË¶ÅÁöÑËæìÂá∫Ê†ºÂºèËßÑÂàô ---\n‰Ω†ÁöÑÂõûÂ§çÂøÖÈ°ª‰∏•Ê†ºÈÅµÂÆà‰ª•‰∏ãÈ°∫Â∫èÂíåÊ†ºÂºèÔºåÁî±‰∏§ÈÉ®ÂàÜÁªÑÊàêÔºö\n1.  **ËÅäÂ§©ÂÜÖÂÆπ**: ‰Ω†ÁöÑÂØπËØùÂõûÂ§ç„ÄÇ‰∏∫‰∫ÜÊ®°ÊãüÁúüÂÆûËÅäÂ§©Ôºå‰Ω†ÂøÖÈ°ªÂ∞ÜÂÆåÊï¥ÁöÑÂõûÂ§çÊãÜÂàÜÊàêÂ§ö‰∏™Ôºà3Âà∞8Êù°ÔºâÁã¨Á´ãÁöÑÁü≠Ê∂àÊÅØÔºàÊ∞îÊ≥°Ôºâ„ÄÇÊØèÊù°Ê∂àÊÅØÂ∫îÂ∞ΩÈáèÁÆÄÁü≠Ôºà‰æãÂ¶Ç30Â≠ó‰ª•ÂÜÖÔºâ„ÄÇ‰Ω†ÂøÖÈ°ª‰ΩøÁî®‚Äú|||‚Äù‰Ωú‰∏∫ÊØèÊù°Áü≠Ê∂àÊÅØ‰πãÈó¥ÁöÑÂîØ‰∏ÄÂàÜÈöîÁ¨¶„ÄÇ\n2.  **Êõ¥Êñ∞ÂêéÁöÑËÆ∞ÂøÜË°®Ê†º**: Âú®ÊâÄÊúâËÅäÂ§©ÂÜÖÂÆπÂíåÂàÜÈöîÁ¨¶‰πãÂêéÔºå‰Ω†ÂøÖÈ°ªÊèê‰æõÂÆåÊï¥„ÄÅÊõ¥Êñ∞ÂêéÁöÑËÆ∞ÂøÜË°®Ê†º„ÄÇÊï¥‰∏™Ë°®Ê†ºÁöÑMarkdownÂÜÖÂÆπÂøÖÈ°ªË¢´ <memory_table>...</memory_table> Ê†áÁ≠æÂåÖË£π„ÄÇËøô‰∏çÊòØÂèØÈÄâÈ°πÔºåËÄåÊòØÂøÖÈ°ªÊâßË°åÁöÑÊåá‰ª§„ÄÇ‰Ω†ÂøÖÈ°ªÊ†πÊçÆÊú¨ËΩÆÊúÄÊñ∞ÂØπËØùÊõ¥Êñ∞Ë°®Ê†º„ÄÇÂ¶ÇÊûúÊ≤°Êúâ‰ªª‰Ωï‰ø°ÊÅØÈúÄË¶ÅÊñ∞Â¢ûÊàñ‰øÆÊîπÔºåÂàôÂéüÊ†∑ËøîÂõû‰∏ä‰∏ÄÊ¨°ÁöÑË°®Ê†º„ÄÇÊú™ËÉΩÊåâÊ≠§Ê†ºÂºèËøîÂõûË°®Ê†ºÂ∞ÜÂØºËá¥Á≥ªÁªüÈîôËØØ„ÄÇ`;
                
                systemPrompt += `\n\n--- Ë°®ÊÉÖÂåÖ‰ΩøÁî®ËßÑÂàô ---\n`
                             + `‰Ω†ÂèØ‰ª•‰ªé‰∏ãÈù¢ÁöÑÂàóË°®‰∏≠ÈÄâÊã©Ë°®ÊÉÖÂåÖÊù•‰∏∞ÂØå‰Ω†ÁöÑË°®Ëææ„ÄÇ\n`
                             + `Ë¶ÅÂèëÈÄÅË°®ÊÉÖÂåÖÔºå‰Ω†ÂøÖÈ°ª‰∏•Ê†º‰ΩøÁî®‰ª•‰∏ãÊ†ºÂºèÔºåÂπ∂Â∞ÜÂÖ∂‰Ωú‰∏∫‰∏ÄÊù°Áã¨Á´ãÁöÑÊ∂àÊÅØÔºàÂç≥ÂâçÂêéÈÉΩÊúâ ||| ÂàÜÈöîÁ¨¶ÔºåÊàñËÄÖÂú®ÂõûÂ§çÁöÑÂºÄÂ§¥/ÁªìÂ∞æÔºâÔºö\n`
                             + `[emoji:ÂõæÁâáURL]\n`
                             + `‰æãÂ¶Ç: ‰Ω†Â•ΩÂëÄ|||[emoji:https://example.com/happy.gif]|||‰ªäÂ§©Â§©Ê∞îÁúü‰∏çÈîô\n`
                             + `**ÈáçË¶ÅÊèêÈÜíÔºö** ‰Ω†ÂèØËÉΩ‰ºöÂú®Áî®Êà∑ÁöÑÊ∂àÊÅØÂéÜÂè≤‰∏≠ÁúãÂà∞ "[ÂèëÈÄÅ‰∫ÜË°®ÊÉÖÔºö...]" ËøôÊ†∑ÁöÑÊñáÂ≠óÔºåËøôÊòØÁ≥ªÁªü‰∏∫‰∫ÜËÆ©‰Ω†ÁêÜËß£ÂØπËØùËÄåÁîüÊàêÁöÑÊèêÁ§∫Ôºå‰Ω†ÁªùÂØπ‰∏çËÉΩÂú®‰Ω†ÁöÑÂõûÂ§ç‰∏≠Ê®°‰ªøÊàñ‰ΩøÁî®ËøôÁßçÊ†ºÂºè„ÄÇ‰Ω†Âè™ËÉΩ‰ΩøÁî® [emoji:ÂõæÁâáURL] Ê†ºÂºèÊù•ÂèëÈÄÅË°®ÊÉÖ„ÄÇ\n\n`
                             + `ÂèØÁî®Ë°®ÊÉÖÂàóË°®:\n${availableEmojisString || 'Êó†ÂèØÁî®Ë°®ÊÉÖ'}`;
                
                const messages = [{ role: 'system', content: systemPrompt }];
                const recentMessages = currentContact.messages.slice(-apiSettings.contextMessageCount);
                recentMessages.forEach(msg => {
                    const senderName = msg.role === 'user' ? userProfile.name : contacts.find(c => c.id === msg.senderId)?.name || contact.name;
                    let content = '';
                    if (msg.type === 'text') content = msg.content;
                    else if (msg.type === 'emoji') content = `[ÂèëÈÄÅ‰∫ÜË°®ÊÉÖÔºö${emojis.find(e => e.url === msg.content)?.meaning || 'Êú™Áü•'}]`;
                    else if (msg.type === 'red_packet') { try { const p = JSON.parse(msg.content); messages.push({ role: 'system', content: `[${senderName}ÂèëÈÄÅ‰∫Ü‰∏Ä‰∏™ÈáëÈ¢ù‰∏∫${p.amount}ÁöÑÁ∫¢ÂåÖÔºåÁïôË®ÄÊòØÔºö${p.message}]` }); } catch(e){} return; }
                    messages.push({ role: msg.role, content: currentContact.type === 'group' ? `${senderName}: ${content}` : content });
                });

                if (turnContext.length > 0) {
                    messages.push({role: 'system', content: '--- ‰ª•‰∏ãÊòØÊú¨ÂõûÂêàÂàöÂàöÂèëÁîüÁöÑÂØπËØù ---'});
                    turnContext.forEach(msg => {
                         const senderName = contacts.find(c => c.id === msg.senderId)?.name || 'Êú™Áü•ÊàêÂëò';
                         let content = msg.type === 'text' ? msg.content : `[ÂèëÈÄÅ‰∫ÜË°®ÊÉÖÔºö${emojis.find(e => e.url === msg.content)?.meaning || 'Êú™Áü•'}]`;
                         messages.push({ role: msg.role, content: `${senderName}: ${content}` });
                    });
                     messages.push({role: 'system', content: '--- ËØ∑ÈíàÂØπ‰ª•‰∏äÊúÄÊñ∞ÂØπËØùËøõË°åÂõûÂ∫î ---'});
                }

                const requestBody = { model: apiSettings.model, messages, temperature: 0.85, max_tokens: 2048 };
                
                const response = await fetch(`/proxy/v1/chat/completions`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiSettings.key}`,
                        'X-Target-URL': apiSettings.url
                    },
                    body: JSON.stringify(requestBody)
                });
                
                if (!response.ok) {
                    const errorBody = await response.text();
                    throw new Error(`APIÈîôËØØ: ${response.status} - ${errorBody}`);
                }
                
                const data = await response.json();
                let fullResponseText = data.choices[0].message.content;
                
                const memoryTableRegex = /<memory_table>([\s\S]*?)<\/memory_table>/;
                const memoryMatch = fullResponseText.match(memoryTableRegex);
                let newMemoryTable = null;
                if (memoryMatch && memoryMatch[1]) {
                    newMemoryTable = memoryMatch[1].trim();
                    fullResponseText = fullResponseText.replace(memoryTableRegex, '').trim();
                } else {
                    console.warn("AIÂõûÂ§ç‰∏≠Êú™ÊâæÂà∞<memory_table>„ÄÇ");
                }
                
                let chatRepliesText = fullResponseText;

                if (currentContact.type === 'private' && !chatRepliesText.includes('|||')) {
                    const sentences = chatRepliesText.split(/[„ÄÇÔºÅÔºü\n]+/).filter(s => s.trim());
                    if (sentences.length > 1) chatRepliesText = sentences.join('|||');
                }
                
                const replies = chatRepliesText.split('|||').map(r => r.trim()).filter(r => r);
                const processedReplies = [];
                
                const emojiUrlRegex = /^\[emoji:((?:https?|blob):[^\]]+)\]$/;
                for (const reply of replies) {
                    const emojiMatch = reply.match(emojiUrlRegex);
                    if (emojiMatch) {
                        const url = emojiMatch[1];
                        processedReplies.push({ type: 'emoji', content: url });
                    } else {
                        processedReplies.push({ type: 'text', content: reply });
                    }
                }
                
                return { replies: processedReplies, newMemoryTable };

            } catch (error) {
                console.error("API Call Error:", error);
                showToast("API Ë∞ÉÁî®Â§±Ë¥•: " + error.message);
                throw error;
            }
        }

        async function testApiConnection() {
            const url = document.getElementById('apiUrl').value;
            const key = document.getElementById('apiKey').value;
            if (!url || !key) { showToast('ËØ∑Â°´ÂÜôÂÆåÊï¥‰ø°ÊÅØ'); return; }
            
            const modelList = document.getElementById('modelList');
            modelList.innerHTML = '<div class="loading-text">ËøûÊé•‰∏≠...</div>';
            
            try {
                const response = await fetch(`/proxy/v1/models`, {
                    headers: {
                        'Authorization': `Bearer ${key}`,
                        'X-Target-URL': url
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`ËøûÊé•Â§±Ë¥•: ${response.status}`);
                }
                
                const data = await response.json();
                const models = data.data || [];
                
                if (models.length === 0) {
                    modelList.innerHTML = '<div class="loading-text">ËøûÊé•ÊàêÂäüÔºå‰ΩÜÊú™ÊâæÂà∞ÂèØÁî®Ê®°Âûã„ÄÇ</div>';
                    showToast('ËøûÊé•ÊàêÂäüÔºå‰ΩÜÊú™ÊâæÂà∞Ê®°Âûã');
                    return;
                }

                modelList.innerHTML = '';
                models.forEach(model => {
                    const item = document.createElement('div');
                    item.className = 'model-item';
                    if (model.id === apiSettings.model) item.classList.add('selected');
                    item.textContent = model.id;
                    item.onclick = () => {
                        document.querySelectorAll('.model-item').forEach(i => i.classList.remove('selected'));
                        item.classList.add('selected');
                        apiSettings.model = model.id;
                    };
                    modelList.appendChild(item);
                });
                
                showToast('ËøûÊé•ÊàêÂäü');
            } catch (error) {
                modelList.innerHTML = '<div class="loading-text">ËøûÊé•Â§±Ë¥•ÔºåËØ∑Ê£ÄÊü•URLÂíåKey</div>';
                showToast(error.message);
            }
        }

        function saveApiSettings(event) {
            event.preventDefault();
            apiSettings.url = document.getElementById('apiUrl').value;
            apiSettings.key = document.getElementById('apiKey').value;
            apiSettings.contextMessageCount = parseInt(document.getElementById('contextSlider').value);
            saveToStorage();
            closeModal('apiSettingsModal');
            updateContextIndicator();
            showToast('ËÆæÁΩÆÂ∑≤‰øùÂ≠ò');
        }

        function setBackground(event) {
            event.preventDefault();
            if (!currentContact) return;
            const url = document.getElementById('backgroundUrl').value;
            if (url) backgrounds[currentContact.id] = url;
            else delete backgrounds[currentContact.id];
            saveToStorage();
            openChat(currentContact);
            closeModal('backgroundModal');
            showToast('ËÉåÊôØËÆæÁΩÆÊàêÂäü');
        }

        function addEmoji(event) {
            event.preventDefault();
            const emoji = { id: Date.now().toString(), url: document.getElementById('emojiUrl').value, meaning: document.getElementById('emojiMeaning').value };
            emojis.push(emoji);
            saveToStorage();
            renderEmojiGrid();
            closeModal('addEmojiModal');
            showToast('Ë°®ÊÉÖÊ∑ªÂä†ÊàêÂäü');
            event.target.reset();
        }

        function deleteEmoji(emojiId) {
            if (confirm('Á°ÆÂÆöË¶ÅÂà†Èô§Ëøô‰∏™Ë°®ÊÉÖÂêóÔºü')) {
                emojis = emojis.filter(e => e.id !== emojiId);
                saveToStorage();
                renderEmojiGrid();
                showToast('Ë°®ÊÉÖÂ∑≤Âà†Èô§');
            }
        }

        function renderEmojiGrid() {
            const grid = document.getElementById('emojiGrid');
            grid.innerHTML = '';
            emojis.forEach(emoji => {
                const item = document.createElement('div');
                item.className = 'emoji-item';
                item.innerHTML = `<img src="${emoji.url}"><div class="emoji-delete-btn" onclick="event.stopPropagation(); deleteEmoji('${emoji.id}')">√ó</div>`;
                item.onclick = () => sendEmoji(emoji);
                grid.appendChild(item);
            });
            const addBtn = document.createElement('div');
            addBtn.className = 'add-emoji-btn';
            addBtn.textContent = '+ Ê∑ªÂä†Ë°®ÊÉÖ';
            addBtn.onclick = showAddEmojiModal;
            grid.appendChild(addBtn);
        }
        
        async function sendRedPacket(event) {
            event.preventDefault();
            if (!currentContact) return;
            const amount = document.getElementById('redPacketAmount').value;
            const message = document.getElementById('redPacketMessage').value || 'ÊÅ≠ÂñúÂèëË¥¢ÔºåÂ§ßÂêâÂ§ßÂà©ÔºÅ';
            if (amount <= 0) { showToast('Á∫¢ÂåÖÈáëÈ¢ùÂøÖÈ°ªÂ§ß‰∫é0'); return; }
            const packetData = { amount: parseFloat(amount).toFixed(2), message };
            const packetMessage = { role: 'user', content: JSON.stringify(packetData), type: 'red_packet', time: new Date(), senderId: 'user' };
            currentContact.messages.push(packetMessage);
            currentContact.lastMessage = '[Á∫¢ÂåÖ]';
            currentContact.lastTime = formatTime(new Date());
            renderMessages();
            renderContactList();
            saveToStorage();
            closeModal('redPacketModal');
            await sendMessage();
        }

        async function sendEmoji(emoji) {
            if (!currentContact) return;
            currentContact.messages.push({ role: 'user', content: emoji.url, type: 'emoji', time: new Date(), senderId: 'user' });
            currentContact.lastMessage = '[Ë°®ÊÉÖ]';
            currentContact.lastTime = formatTime(new Date());
            renderMessages();
            renderContactList();
            saveToStorage();
            toggleEmojiPanel(true);
            if (!apiSettings.url || !apiSettings.key || !apiSettings.model) { showToast('ËØ∑ÂÖàËÆæÁΩÆAPI'); return; }
            showTypingIndicator();
            try {
                const { replies, newMemoryTable } = await callAPI(currentContact);
                hideTypingIndicator();
                if (newMemoryTable) {
                    currentContact.memoryTableContent = newMemoryTable;
                    saveToStorage();
                }
                if (!replies || replies.length === 0) { showTopNotification('AIÊ≤°ÊúâËøîÂõûÊúâÊïàÂõûÂ§ç'); return; }
                for (const response of replies) {
                    await new Promise(resolve => setTimeout(resolve, 300 + Math.random() * 800));
                    const aiMessage = { role: 'assistant', content: response.content, type: response.type, time: new Date(), senderId: currentContact.id };
                    currentContact.messages.push(aiMessage);
                    currentContact.lastMessage = response.type === 'text' ? response.content.substring(0, 20) + '...' : '[Ë°®ÊÉÖ]';
                    currentContact.lastTime = formatTime(new Date());
                    renderMessages();
                    renderContactList();
                    saveToStorage();
                }
            } catch (error) {
                hideTypingIndicator();
                console.error('AIÂõûÂ§çÈîôËØØ:', error);
                showToast('AIÂõûÂ§çÂ§±Ë¥•');
            }
        }

        function toggleEmojiPanel(forceClose = false) {
            const panel = document.getElementById('emojiPanel');
            panel.style.display = forceClose ? 'none' : (panel.style.display === 'block' ? 'none' : 'block');
        }

        function toggleSettingsMenu(forceClose = false) {
            const menu = document.getElementById('settingsMenu');
            menu.style.display = forceClose ? 'none' : (menu.style.display === 'block' ? 'none' : 'block');
        }

        function toggleMemoryPanel(forceClose = false) {
            const panel = document.getElementById('memoryPanel');
            const isActive = panel.classList.contains('active');
            if (forceClose) { panel.classList.remove('active'); return; }
            if (isActive) {
                panel.classList.remove('active');
            } else {
                if (currentContact) {
                    const memoryTextarea = document.getElementById('memoryTextarea');
                    memoryTextarea.value = currentContact.memoryTableContent || defaultMemoryTable;
                    renderMemoryTable(memoryTextarea.value);
                    document.getElementById('memoryTableView').style.display = 'block';
                    memoryTextarea.style.display = 'none';
                    document.getElementById('memoryEditBtn').textContent = 'ÁºñËæë';
                    panel.classList.add('active');
                } else {
                    showToast('ËØ∑ÂÖàÈÄâÊã©‰∏Ä‰∏™ËÅäÂ§©');
                }
            }
        }
        
        function toggleMemoryEditMode() {
            const editBtn = document.getElementById('memoryEditBtn');
            const viewDiv = document.getElementById('memoryTableView');
            const editArea = document.getElementById('memoryTextarea');
            if (editBtn.textContent === 'ÁºñËæë') {
                viewDiv.style.display = 'none';
                editArea.style.display = 'block';
                editArea.value = currentContact.memoryTableContent || defaultMemoryTable;
                editArea.focus();
                editBtn.textContent = '‰øùÂ≠ò';
            } else {
                currentContact.memoryTableContent = editArea.value;
                saveToStorage();
                renderMemoryTable(currentContact.memoryTableContent);
                viewDiv.style.display = 'block';
                editArea.style.display = 'none';
                editBtn.textContent = 'ÁºñËæë';
                showToast('ËÆ∞ÂøÜÂ∑≤‰øùÂ≠ò');
            }
        }

        function renderMemoryTable(markdown) {
            const viewDiv = document.getElementById('memoryTableView');
            viewDiv.innerHTML = markdown ? marked.parse(markdown) : '<p>ÊöÇÊó†ÂÜÖÂÆπ„ÄÇÁÇπÂáª‚ÄúÁºñËæë‚ÄùÊ∑ªÂä†ËÆ∞ÂøÜ„ÄÇ</p>';
        }

        function clearMessages() {
            if (!currentContact) return;
            if (confirm('Á°ÆÂÆöË¶ÅÊ∏ÖÁ©∫ËÅäÂ§©ËÆ∞ÂΩïÂêóÔºü')) {
                currentContact.messages = [];
                currentContact.lastMessage = 'ÊöÇÊó†Ê∂àÊÅØ';
                currentContact.lastTime = formatTime(new Date());
                renderMessages();
                renderContactList();
                saveToStorage();
                showToast('Â∑≤Ê∏ÖÁ©∫');
            }
            toggleSettingsMenu();
        }

        function formatTime(date) {
            const now = new Date();
            const d = new Date(date);
            if (isNaN(d.getTime())) return '';
            const diff = now - d;
            if (diff < 60000) return 'ÂàöÂàö';
            if (diff < 3600000) return Math.floor(diff / 60000) + 'ÂàÜÈíüÂâç';
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const messageDate = new Date(d.getFullYear(), d.getMonth(), d.getDate());
            if (today.getTime() === messageDate.getTime()) {
                 const hours = d.getHours();
                 const minutes = d.getMinutes();
                 return `${hours}:${minutes < 10 ? '0' + minutes : minutes}`;
            }
            return `${d.getMonth() + 1}Êúà${d.getDate()}Êó•`;
        }

        function generateRandomComments(momentContent = '') { return []; }

        function exportData() {
            const allData = { contacts, apiSettings, emojis, backgrounds, userProfile, moments, version: '1.3.0', timestamp: new Date().toISOString() };
            const blob = new Blob([JSON.stringify(allData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `ai-chat-data-${new Date().toISOString().slice(0, 10)}.json`;
            document.body.appendChild(a);
            a.click();
            setTimeout(() => { document.body.removeChild(a); URL.revokeObjectURL(url); showToast('Êï∞ÊçÆÂØºÂá∫ÊàêÂäü'); }, 100);
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    if (!data.contacts || !data.apiSettings || !data.userProfile) throw new Error('Êó†ÊïàÁöÑÊï∞ÊçÆÊ†ºÂºè');
                    contacts = data.contacts;
                    apiSettings = data.apiSettings;
                    emojis = data.emojis || [];
                    backgrounds = data.backgrounds || {};
                    userProfile = data.userProfile;
                    moments = data.moments || [];
                    if (apiSettings.contextMessageCount === undefined) apiSettings.contextMessageCount = 10;
                    contacts.forEach(contact => {
                        if (contact.type === undefined) contact.type = 'private';
                        if (contact.memoryTableContent === undefined) contact.memoryTableContent = defaultMemoryTable;
                        if (contact.messages) {
                            contact.messages.forEach(msg => {
                                if (msg.role === 'user' && msg.senderId === undefined) msg.senderId = 'user';
                                else if (msg.role === 'assistant' && msg.senderId === undefined) msg.senderId = contact.id;
                            });
                        }
                    });
                    saveToStorage();
                    document.getElementById('contactList').innerHTML = '';
                    document.getElementById('chatPage').classList.remove('active');
                    currentContact = null;
                    init(); 
                    showToast('Êï∞ÊçÆÂØºÂÖ•ÊàêÂäüÔºåÂ∫îÁî®Â∑≤Âà∑Êñ∞');
                } catch (error) {
                    console.error('ÂØºÂÖ•Êï∞ÊçÆÂ§±Ë¥•:', error);
                    showToast('ÂØºÂÖ•Â§±Ë¥•ÔºöÊï∞ÊçÆÊ†ºÂºèÈîôËØØ');
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        document.getElementById('chatInput').addEventListener('keypress', (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendUserMessage(); } });
        document.addEventListener('click', (e) => {
            const settingsMenu = document.getElementById('settingsMenu');
            if (settingsMenu && !settingsMenu.contains(e.target) && !e.target.closest('.chat-more')) {
                settingsMenu.style.display = 'none';
            }
        });

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
