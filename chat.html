<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI聊天助手 - 支持上下文调节与群聊</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        /* 全局重置和基础样式 */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", "Helvetica Neue", Helvetica, Arial, sans-serif;
            background-color: #ededed;
            height: 100vh;
            overflow: hidden;
            position: relative;
        }

        /* 状态栏 */
        .status-bar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 44px;
            background-color: #ededed;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 15px;
            z-index: 1000;
            font-size: 14px;
        }

        .status-left {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .status-right {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        /* 主容器 */
        .main-container {
            height: 100vh;
            display: flex;
            flex-direction: column;
            padding-top: 44px; /* 留出状态栏空间 */
            padding-bottom: 50px; /* 留出底部导航空间 */
        }

        /* 联系人列表页面 */
        .contact-list-page {
            flex: 1;
            background-color: #fff;
            overflow-y: auto;
        }

        .wechat-header {
            background-color: #ededed;
            padding: 10px 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid #e5e5e5;
        }

        .header-title {
            font-size: 17px;
            font-weight: 500;
        }

        .header-actions {
            display: flex;
            gap: 20px;
        }

        .header-icon {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .search-bar {
            padding: 8px 15px;
            background-color: #ededed;
        }

        .search-input {
            width: 100%;
            height: 32px;
            background-color: #fff;
            border: none;
            border-radius: 4px;
            padding: 0 10px;
            font-size: 14px;
        }

        /* 联系人项目 */
        .contact-item {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            background-color: #fff;
            border-bottom: 0.5px solid #e5e5e5;
            cursor: pointer;
            position: relative;
        }

        .contact-item:active {
            background-color: #d9d9d9;
        }

        .contact-avatar {
            width: 48px;
            height: 48px;
            border-radius: 4px;
            margin-right: 12px;
            background-color: #07c160;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 20px;
            flex-shrink: 0;
            overflow: hidden;
        }

        .contact-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .contact-info {
            flex: 1;
            overflow: hidden;
        }

        .contact-name {
            font-size: 17px;
            color: #000;
            margin-bottom: 4px;
        }

        .contact-message {
            font-size: 13px;
            color: #999;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .contact-time {
            position: absolute;
            right: 15px;
            top: 15px;
            font-size: 12px;
            color: #b2b2b2;
        }

        /* 聊天页面 */
        .chat-page {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 50px;
            background-color: #ededed;
            display: flex;
            flex-direction: column;
            transform: translateX(100%);
            transition: transform 0.3s ease;
            z-index: 100;
            overflow: hidden; /* 防止记忆面板溢出 */
        }

        .chat-page.active {
            transform: translateX(0);
        }

        .chat-header {
            background-color: #ededed;
            padding: 44px 15px 10px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 0.5px solid #d9d9d9;
            flex-shrink: 0;
            position: relative;
            z-index: 3; /* 提高header层级 */
        }

        .back-btn {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 17px;
            color: #576b95;
            cursor: pointer;
        }

        .chat-title {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            font-size: 17px;
            font-weight: 500;
        }
        
        .chat-header-actions {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .chat-more, .memory-btn {
            width: 24px;
            height: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            font-weight: bold;
        }

        /* 聊天消息区域 */
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            -webkit-overflow-scrolling: touch;
        }

        .message {
            display: flex;
            margin-bottom: 15px;
            align-items: flex-start;
        }

        .message.sent {
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 4px;
            margin: 0 10px;
            background-color: #07c160;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 16px;
            flex-shrink: 0;
            overflow: hidden;
        }

        .message-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .message-bubble {
            max-width: 70%;
            position: relative;
        }

        .message-content {
            padding: 10px 12px;
            border-radius: 8px;
            font-size: 16px;
            line-height: 1.5;
            word-wrap: break-word;
            position: relative;
        }

        .message.received .message-content {
            background-color: #fff;
            color: #000;
        }

        .message.sent .message-content {
            background-color: #95ec69;
            color: #000;
        }

        /* 消息气泡小尾巴 */
        .message-content::before {
            content: '';
            position: absolute;
            top: 10px;
            width: 0;
            height: 0;
            border-style: solid;
        }

        .message.received .message-content::before {
            left: -5px;
            border-width: 6px 6px 6px 0;
            border-color: transparent #fff transparent transparent;
        }

        .message.sent .message-content::before {
            right: -5px;
            border-width: 6px 0 6px 6px;
            border-color: transparent transparent transparent #95ec69;
        }

        .message-emoji {
            max-width: 100px;
            max-height: 100px;
            border-radius: 8px;
            display: block;
        }
        
        /* 红包样式 */
        .message-content.red-packet {
            background-color: #fa9d3b;
            color: white;
            padding: 0;
            width: 240px;
            cursor: pointer;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .red-packet-body {
            display: flex;
            align-items: center;
            padding: 12px;
        }
        
        .red-packet-icon {
            width: 40px;
            height: 40px;
            margin-right: 10px;
        }
        
        .red-packet-text {
            flex: 1;
        }

        .red-packet-text div:first-child {
            font-size: 15px;
            font-weight: 500;
            margin-bottom: 2px;
        }
        
        .red-packet-text div:last-child {
            font-size: 14px;
        }
        
        .red-packet-footer {
            background-color: white;
            color: #999;
            font-size: 12px;
            padding: 4px 12px;
            border-top: 0.5px solid rgba(0,0,0,0.05);
        }

        .message.sent .message-content.red-packet::before {
            border-color: transparent transparent transparent #fa9d3b;
        }
        
        /* 输入区域 */
        .chat-input-area {
            background-color: #f7f7f7;
            border-top: 0.5px solid #d9d9d9;
            padding: 8px 10px;
            display: flex;
            align-items: flex-end;
            gap: 8px;
            flex-shrink: 0;
            position: relative;
            z-index: 2;
        }

        .input-actions {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .action-btn {
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border-radius: 50%;
            background-color: #fff;
            font-size: 20px;
        }

        .chat-input {
            flex: 1;
            min-height: 36px;
            max-height: 120px;
            padding: 8px 12px;
            border: none;
            border-radius: 4px;
            background-color: #fff;
            font-size: 16px;
            resize: none;
            outline: none;
        }

        .send-btn {
            padding: 8px 16px;
            background-color: #07c160;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
        }

        .send-btn:active {
            background-color: #06a652;
        }

        .send-btn:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        /* 记忆表格面板 */
        .memory-panel {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #f7f7f7;
            z-index: 4;
            transform: translateY(100%);
            transition: transform 0.3s ease-in-out;
            overflow-y: auto; /* Allow the whole panel to scroll */
            -webkit-overflow-scrolling: touch;
        }

        .memory-panel.active {
            transform: translateY(0);
        }

        .memory-panel-header {
            padding: 44px 15px 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #ededed;
            border-bottom: 0.5px solid #d9d9d9;
            position: sticky; /* Make header sticky */
            top: 0;
            z-index: 1;
        }
        
        .memory-panel-title {
            font-size: 17px;
            font-weight: 500;
        }

        .memory-panel-actions {
            display: flex;
            gap: 15px;
        }

        .memory-panel-btn {
            font-size: 16px;
            color: #576b95;
            cursor: pointer;
            background: none;
            border: none;
            padding: 5px;
        }

        .memory-panel-content {
            padding: 15px;
        }

        .memory-textarea {
            width: 100%;
            height: calc(100vh - 150px); /* Adjust height to fill available space */
            border: 1px solid #ddd;
            border-radius: 4px;
            outline: none;
            resize: none;
            font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, Courier, monospace;
            font-size: 14px;
            line-height: 1.6;
            background-color: #fff;
            color: #333;
            padding: 10px;
        }
        
        /* 渲染后的表格样式 */
        .memory-table-view {
            font-size: 14px;
            line-height: 1.6;
            color: #333;
            word-wrap: break-word;
        }
        .memory-table-view h1,
        .memory-table-view h2,
        .memory-table-view h3 {
            margin-top: 1.2em;
            margin-bottom: 0.6em;
            font-weight: 600;
            border-bottom: 1px solid #eee;
            padding-bottom: 0.3em;
        }
        .memory-table-view h1 { font-size: 1.6em; }
        .memory-table-view h2 { font-size: 1.4em; }
        .memory-table-view h3 { font-size: 1.2em; }
        .memory-table-view ul {
            padding-left: 20px;
            margin-bottom: 1em;
        }
        .memory-table-view table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 1em;
            border: 1px solid #ddd;
        }
        .memory-table-view th,
        .memory-table-view td {
            border: 1px solid #ddd;
            padding: 8px 12px;
            text-align: left;
        }
        .memory-table-view th {
            background-color: #f2f2f2;
            font-weight: 600;
        }
        .memory-table-view tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        .memory-table-view p {
            margin-bottom: 1em;
        }
        .memory-table-view hr {
            border: none;
            border-top: 2px solid #eee;
            margin: 1.5em 0;
        }

        /* 底部导航栏 */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 50px;
            background-color: #f7f7f7;
            border-top: 0.5px solid #d9d9d9;
            display: flex;
            justify-content: space-around;
            align-items: center;
            z-index: 200;
        }

        .nav-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 2px;
            cursor: pointer;
            position: relative;
        }

        .nav-icon {
            width: 24px;
            height: 24px;
        }

        .nav-text {
            font-size: 10px;
            color: #999;
        }

        .nav-item.active .nav-text {
            color: #07c160;
        }

        /* 朋友圈页面 */
        .moments-page {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 50px;
            background-color: #f5f5f5;
            display: flex;
            flex-direction: column;
            transform: translateX(100%);
            transition: transform 0.3s ease;
            z-index: 120;
        }

        .moments-page.active {
            transform: translateX(0);
        }

        .moments-header {
            background-color: #ededed;
            padding: 44px 15px 10px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 0.5px solid #d9d9d9;
            flex-shrink: 0;
        }

        .moments-content {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
        }

        .moments-empty {
            text-align: center;
            padding: 50px 20px;
            color: #999;
        }

        .moments-empty-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }

        .moments-empty-text {
            font-size: 16px;
            margin-bottom: 20px;
        }

        .moments-empty-btn {
            background-color: #07c160;
            color: white;
            border: none;
            border-radius: 20px;
            padding: 10px 20px;
            font-size: 14px;
            cursor: pointer;
        }

        .moments-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .moment-item {
            background-color: #fff;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .moment-header {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        .moment-avatar {
            width: 40px;
            height: 40px;
            border-radius: 4px;
            margin-right: 10px;
            background-color: #07c160;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 16px;
            overflow: hidden;
        }

        .moment-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .moment-info {
            flex: 1;
        }

        .moment-name {
            font-size: 16px;
            font-weight: 500;
            margin-bottom: 2px;
        }

        .moment-time {
            font-size: 12px;
            color: #999;
        }

        .moment-content {
            font-size: 15px;
            line-height: 1.5;
            margin-bottom: 10px;
        }

        .moment-image {
            width: 100%;
            max-width: 300px;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        /* 发布朋友圈模态框 */
        .publish-moment-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0,0,0,0.5);
            z-index: 2000;
        }

        .publish-moment-content {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: white;
            border-radius: 12px 12px 0 0;
            max-height: 80vh;
            overflow-y: auto;
            animation: slideUp 0.3s ease;
        }

        .publish-moment-header {
            padding: 15px;
            border-bottom: 0.5px solid #e5e5e5;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .publish-moment-title {
            font-size: 17px;
            font-weight: 500;
        }

        .publish-moment-close {
            font-size: 14px;
            color: #576b95;
            cursor: pointer;
        }

        .publish-moment-body {
            padding: 15px;
        }

        .generate-moment-section {
            text-align: center;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .generate-moment-btn {
            background-color: #07c160;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px 24px;
            font-size: 16px;
            cursor: pointer;
            margin-bottom: 10px;
        }

        .generate-moment-hint {
            font-size: 14px;
            color: #666;
            line-height: 1.5;
        }

        .moment-preview {
            display: none;
            border: 1px solid #e5e5e5;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            background-color: #f8f9fa;
        }

        .moment-preview-title {
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 10px;
            color: #333;
        }

        .moment-preview-content {
            font-size: 15px;
            line-height: 1.5;
            margin-bottom: 10px;
        }

        .moment-preview-image {
            width: 100%;
            max-width: 200px;
            border-radius: 8px;
        }

        .unsplash-key-section {
            margin-bottom: 20px;
        }

        .unsplash-key-label {
            font-size: 14px;
            color: #333;
            margin-bottom: 8px;
            display: block;
        }

        .unsplash-key-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #e5e5e5;
            border-radius: 4px;
            font-size: 16px;
            outline: none;
        }

        .unsplash-key-input:focus {
            border-color: #07c160;
        }

        .publish-moment-submit {
            width: 100%;
            padding: 12px;
            background-color: #07c160;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            cursor: pointer;
        }

        .publish-moment-submit:active {
            background-color: #06a652;
        }

        .publish-moment-submit:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        /* 模态框 */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0,0,0,0.5);
            z-index: 2000;
        }

        .modal-content {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: white;
            border-radius: 12px 12px 0 0;
            max-height: 80vh;
            overflow-y: auto;
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from {
                transform: translateY(100%);
            }
            to {
                transform: translateY(0);
            }
        }

        .modal-header {
            padding: 15px;
            border-bottom: 0.5px solid #e5e5e5;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 17px;
            font-weight: 500;
        }

        .modal-close {
            font-size: 14px;
            color: #576b95;
            cursor: pointer;
        }

        .modal-body {
            padding: 15px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-label {
            font-size: 14px;
            color: #000;
            margin-bottom: 8px;
            display: block;
        }

        .form-input, .form-textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #e5e5e5;
            border-radius: 4px;
            font-size: 16px;
            outline: none;
        }

        .form-input:focus, .form-textarea:focus {
            border-color: #07c160;
        }

        .form-textarea {
            min-height: 80px;
            resize: vertical;
        }

        .form-submit {
            width: 100%;
            padding: 12px;
            background-color: #07c160;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            cursor: pointer;
        }

        .form-submit:active {
            background-color: #06a652;
        }

        /* 表情面板 */
        .emoji-panel {
            display: none;
            position: absolute;
            bottom: 100%;
            left: 0;
            right: 0;
            background-color: #f7f7f7;
            border-top: 0.5px solid #e5e5e5;
            max-height: 250px;
            overflow-y: auto;
            margin-bottom: 8px;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
        }

        .emoji-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            padding: 10px;
        }

        .emoji-item {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #fff;
            border-radius: 8px;
            cursor: pointer;
            overflow: hidden;
            position: relative;
        }

        .emoji-item:active {
            background-color: #e5e5e5;
        }

        .emoji-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .emoji-delete-btn {
            position: absolute;
            top: 2px;
            right: 2px;
            width: 20px;
            height: 20px;
            background-color: rgba(255, 0, 0, 0.8);
            color: white;
            border-radius: 50%;
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            cursor: pointer;
        }

        .emoji-item:hover .emoji-delete-btn {
            display: flex;
        }

        .add-emoji-btn {
            grid-column: span 4;
            padding: 10px;
            background-color: #fff;
            border: 1px dashed #07c160;
            border-radius: 8px;
            color: #07c160;
            text-align: center;
            cursor: pointer;
        }

        /* 设置菜单 */
        .settings-menu {
            display: none;
            position: fixed;
            top: 88px;
            right: 10px;
            background-color: #4c4c4c;
            border-radius: 4px;
            padding: 8px 0;
            min-width: 120px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 1500;
        }

        .settings-menu::before {
            content: '';
            position: absolute;
            top: -6px;
            right: 20px;
            width: 0;
            height: 0;
            border-left: 6px solid transparent;
            border-right: 6px solid transparent;
            border-bottom: 6px solid #4c4c4c;
        }

        .menu-item {
            padding: 10px 20px;
            color: white;
            font-size: 14px;
            cursor: pointer;
        }

        .menu-item:active {
            background-color: #3c3c3c;
        }

        /* 加载动画 */
        .typing-indicator {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 10px;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            background-color: #999;
            border-radius: 50%;
            animation: typing 1.4s infinite;
        }

        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {
            0%, 60%, 100% {
                opacity: 0.3;
            }
            30% {
                opacity: 1;
            }
        }

        /* Toast提示 */
        .toast {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(0,0,0,0.8);
            color: white;
            padding: 12px 24px;
            border-radius: 4px;
            font-size: 14px;
            z-index: 3000;
            display: none;
        }

        .toast.show {
            display: block;
            animation: fadeInOut 2s ease;
        }

        @keyframes fadeInOut {
            0%, 100% { opacity: 0; }
            10%, 90% { opacity: 1; }
        }

        /* 顶部提示 */
        .top-notification {
            position: fixed;
            top: 60px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0,0,0,0.8);
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 14px;
            z-index: 3000;
            display: none;
        }

        .top-notification.show {
            display: block;
            animation: slideDown 1.5s ease;
        }

        @keyframes slideDown {
            0% {
                opacity: 0;
                transform: translateX(-50%) translateY(-20px);
            }
            20% {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
            80% {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
            100% {
                opacity: 0;
                transform: translateX(-50%) translateY(-20px);
            }
        }

        /* 模型列表 */
        .model-list {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #e5e5e5;
            border-radius: 4px;
            margin-top: 10px;
        }

        .model-item {
            padding: 12px;
            border-bottom: 0.5px solid #e5e5e5;
            cursor: pointer;
            font-size: 14px;
        }

        .model-item:last-child {
            border-bottom: none;
        }

        .model-item:active {
            background-color: #f5f5f5;
        }

        .model-item.selected {
            background-color: #e8f5e9;
            color: #07c160;
        }


        .loading-text {
            text-align: center;
            padding: 20px;
            color: #999;
            font-size: 14px;
        }

        /* 提示词管理 */
        .prompt-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #e5e5e5;
        }

        .prompt-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .prompt-title {
            font-size: 14px;
            font-weight: 500;
        }

        .prompt-actions {
            display: flex;
            gap: 10px;
        }

        .prompt-btn {
            padding: 5px 10px;
            background-color: #f5f5f5;
            border: 1px solid #e5e5e5;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
        }

        .prompt-btn:active {
            background-color: #e5e5e5;
        }

        .file-input {
            display: none;
        }

        /* 个人信息页面 */
        .profile-page {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 50px;
            background-color: #f5f5f5;
            transform: translateY(100%);
            transition: transform 0.3s ease;
            z-index: 150;
            overflow-y: auto;
        }

        .profile-page.active {
            transform: translateY(0);
        }

        .profile-header {
            background-color: #fff;
            padding: 44px 15px 20px;
            text-align: center;
            border-bottom: 10px solid #f5f5f5;
        }

        .profile-avatar {
            width: 80px;
            height: 80px;
            border-radius: 8px;
            margin: 0 auto 15px;
            background-color: #07c160;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 32px;
            overflow: hidden;
        }

        .profile-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .profile-name {
            font-size: 18px;
            font-weight: 500;
            margin-bottom: 5px;
        }

        .profile-id {
            font-size: 14px;
            color: #999;
        }

        .profile-section {
            background-color: #fff;
            margin-bottom: 10px;
        }

        .profile-item {
            display: flex;
            align-items: center;
            padding: 15px;
            border-bottom: 0.5px solid #e5e5e5;
            cursor: pointer;
        }

        .profile-item:last-child {
            border-bottom: none;
        }

        .profile-item:active {
            background-color: #f5f5f5;
        }

        .profile-item-label {
            flex: 1;
            font-size: 16px;
        }

        .profile-item-value {
            color: #999;
            font-size: 14px;
            margin-right: 5px;
        }

        .profile-item-arrow {
            color: #c7c7c7;
        }
        
        /* 新功能提示 */
        .feature-hint {
            position: absolute;
            bottom: 60px;
            right: 15px;
            background: #07c160;
            color: white;
            padding: 8px 12px;
            border-radius: 18px;
            font-size: 12px;
            z-index: 150;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        /* 数据迁移样式 */
        .data-migration-section {
            background-color: #fff;
            margin: 10px 0;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .migration-header {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #333;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .migration-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .migration-btn {
            flex: 1;
            padding: 12px;
            text-align: center;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
        }
        
        .export-btn {
            background-color: #e6f7ff;
            color: #1890ff;
            border: 1px solid #91d5ff;
        }
        
        .export-btn:active {
            background-color: #bae7ff;
        }
        
        .import-btn {
            background-color: #f6ffed;
            color: #52c41a;
            border: 1px solid #b7eb8f;
        }
        
        .import-btn:active {
            background-color: #d9f7be;
        }
        
        .migration-hint {
            font-size: 13px;
            color: #666;
            margin-top: 15px;
            line-height: 1.5;
        }
        
        /* 上下文控制样式 */
        .context-control {
            background-color: #fff;
            padding: 12px 15px;
            border-radius: 8px;
            margin-top: 10px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            position: relative;
        }
        
        .context-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .context-title {
            font-size: 15px;
            font-weight: 500;
            color: #333;
        }
        
        .context-value {
            font-size: 14px;
            color: #07c160;
            font-weight: bold;
            min-width: 40px;
            text-align: right;
        }
        
        .context-slider {
            width: 100%;
            height: 6px;
            -webkit-appearance: none;
            background: #e0e0e0;
            border-radius: 3px;
            outline: none;
            margin-top: 10px;
        }
        
        .context-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #07c160;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        .context-info {
            font-size: 12px;
            color: #666;
            margin-top: 10px;
            line-height: 1.4;
        }
        
        /* 上下文状态指示器 */
        .context-indicator {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(7, 193, 96, 0.1);
            color: #07c160;
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        /* 音乐弹窗样式 */
        .music-modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.4);
        }
        
        .music-modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 90%;
            max-width: 600px;
            border-radius: 10px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .close-btn {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .close-btn:hover {
            color: #000;
        }
        
        /* 歌单样式 */
        .playlist-container {
            margin: 20px 0;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 10px;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .song-item {
            padding: 10px;
            margin: 5px 0;
            background: #f0f0f0;
            border-radius: 5px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .song-item:hover {
            background: #e0e0e0;
        }
        
        .song-item.active {
            background: #07c160;
            color: white;
        }
        
        .delete-song {
            color: #ff4444;
            cursor: pointer;
            padding: 0 10px;
        }
        
        /* 播放控制样式 */
        .player-controls {
            margin: 20px 0;
            padding: 15px;
            background: #f9f9f9;
            border-radius: 5px;
        }
        
        .progress-bar {
            width: 100%;
            height: 4px;
            background: #ddd;
            border-radius: 2px;
            margin: 10px 0;
            cursor: pointer;
        }
        
        .progress-fill {
            height: 100%;
            background: #07c160;
            border-radius: 2px;
            width: 0%;
            transition: width 0.1s;
        }
        
        .time-display {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #666;
        }
        
        /* 浮动歌词样式 */
        .floating-lyrics {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 12px 24px;
            border-radius: 25px;
            font-size: 16px;
            z-index: 999;
            transition: all 0.3s ease;
            max-width: 80%;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        /* 调试信息样式 */
        .debug-info {
            position: fixed;
            top: 60px;
            right: 10px;
            background: rgba(255,255,255,0.9);
            padding: 10px;
            border-radius: 5px;
            font-size: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            max-width: 200px;
        }

        /* 群聊头像样式 */
        .group-avatar {
            width: 48px;
            height: 48px;
            border-radius: 4px;
            margin-right: 12px;
            background-color: #4a90e2; /* 默认群聊背景色 */
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 20px;
            flex-shrink: 0;
            overflow: hidden;
            position: relative;
        }
        
        .group-avatar-inner {
            position: absolute;
            width: 100%;
            height: 100%;
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            grid-template-rows: repeat(2, 1fr);
        }
        
        .group-avatar-item {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            overflow: hidden;
            border: 1px solid white; /* 成员头像之间的白色边框 */
            background-color: #07c160; /* 默认成员头像背景色 */
        }

        .group-avatar-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        /* 创建群聊模态框 */
        .create-group-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #e5e5e5;
        }
        
        .group-member-list {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #e5e5e5;
            border-radius: 4px;
            margin-top: 10px;
            padding: 10px;
        }
        
        .group-member-item {
            display: flex;
            align-items: center;
            padding: 8px;
            border-bottom: 0.5px solid #eee;
            cursor: pointer;
        }
        
        .group-member-item:last-child {
            border-bottom: none;
        }
        
        .group-member-item.selected {
            background-color: #e6f7ff;
        }
        
        .group-member-avatar {
            width: 32px;
            height: 32px;
            border-radius: 4px;
            margin-right: 10px;
            background-color: #07c160;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 14px;
            overflow: hidden;
        }

        .group-member-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .group-member-name {
            flex: 1;
            font-size: 14px;
        }
        
        .group-member-checkbox {
            width: 20px;
            height: 20px;
            border-radius: 4px;
            border: 1px solid #ddd;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .group-member-checkbox.selected {
            background-color: #07c160;
            color: white;
            border-color: #07c160;
        }
        
        /* 群聊消息样式 */
        .group-message-header {
            display: flex;
            align-items: center;
            margin-bottom: 4px;
        }
        
        .group-message-name {
            font-size: 12px;
            font-weight: bold;
            color: #576b95;
        }
        
        .group-message-time {
            font-size: 10px;
            color: #999;
            margin-left: 8px;
        }
        
        /* 群聊信息提示 */
        .group-info-hint {
            background-color: #f0f0f0;
            color: #666;
            font-size: 12px;
            text-align: center;
            padding: 8px;
            border-radius: 4px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <!-- 状态栏 -->
    <div class="status-bar">
        <div class="status-left">
            <span>12:35</span>
        </div>
        <div class="status-right">
            <span>📶</span>
            <span>📶</span>
            <span>🔋</span>
        </div>
    </div>

    <!-- 主容器 -->
    <div class="main-container">
        <!-- 联系人列表 -->
        <div class="contact-list-page" id="contactListPage">
            <div class="wechat-header">
                <div class="header-title">Whale-LLT</div>
                <div class="header-actions">
                    <span class="header-icon" onclick="showApiSettingsModal()">⚙️</span>
                    <span class="header-icon" id="musicIcon">🎵</span>
                    <span class="header-icon" onclick="showAddContactModal()">➕</span>
                    <span class="header-icon" onclick="showCreateGroupModal()">👥</span> <!-- 新增群聊按钮 -->
                </div>
            </div>
            
            <div class="search-bar">
                <input type="text" class="search-input" placeholder="搜索">
            </div>
            
            <div id="contactList"></div>
        </div>

        <!-- 聊天页面 -->
        <div class="chat-page" id="chatPage">
            <div class="chat-header">
                <div class="back-btn" onclick="closeChatPage()">
                    <span>‹</span>
                    <span>Whale-LLT</span>
                </div>
                <div class="chat-title" id="chatTitle">聊天</div>
                <div class="chat-header-actions">
                    <div class="memory-btn" onclick="toggleMemoryPanel()">
                        <svg t="1689237694389" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="4338" width="24" height="24"><path d="M896 96H128C110.4 96 96 110.4 96 128v768c0 17.6 14.4 32 32 32h768c17.6 0 32-14.4 32-32V128c0-17.6-14.4-32-32-32zM384 832H192v-64h192v64z m0-192H192v-64h192v64z m0-192H192v-64h192v64z m448 384H448v-64h384v64z m0-192H448v-64h384v64z m0-192H448v-64h384v64z" p-id="4339" fill="#515151"></path></svg>
                    </div>
                    <div class="chat-more" onclick="toggleSettingsMenu()">⋯</div>
                </div>
            </div>
            
            <div class="chat-messages" id="chatMessages"></div>
            
            <div class="chat-input-area">
                <div class="feature-hint" id="featureHint">按Enter发送消息，点"发送"按钮获取AI回复</div>
                <div class="input-actions">
                    <div class="action-btn" onclick="toggleEmojiPanel()">😊</div>
                    <div class="action-btn" onclick="showRedPacketModal()">🧧</div>
                </div>
                <textarea class="chat-input" id="chatInput" placeholder="输入消息" rows="1"></textarea>
                <button class="send-btn" id="sendBtn" onclick="sendMessage()">发送</button>
                
                <!-- 表情面板 -->
                <div class="emoji-panel" id="emojiPanel">
                    <div class="emoji-grid" id="emojiGrid">
                        <div class="add-emoji-btn" onclick="showAddEmojiModal()">+ 添加表情</div>
                    </div>
                </div>
            </div>
            
            <!-- 上下文状态指示器 -->
            <div class="context-indicator" id="contextIndicator">
                <span>上下文: 10条</span>
            </div>

            <!-- 记忆表格面板 -->
            <div class="memory-panel" id="memoryPanel">
                <div class="memory-panel-header">
                    <div class="memory-panel-title">记忆表格</div>
                    <div class="memory-panel-actions">
                         <button id="memoryEditBtn" class="memory-panel-btn" onclick="toggleMemoryEditMode()">编辑</button>
                         <button class="memory-panel-btn" onclick="toggleMemoryPanel()">关闭</button>
                    </div>
                </div>
                <div class="memory-panel-content">
                    <div id="memoryTableView" class="memory-table-view"></div>
                    <textarea id="memoryTextarea" class="memory-textarea" style="display: none;"></textarea>
                </div>
            </div>
        </div>

        <!-- 朋友圈页面 -->
        <div class="moments-page" id="momentsPage">
            <div class="moments-header">
                <div class="back-btn" onclick="closeMomentsPage()">
                    <span>‹</span>
                    <span>返回</span>
                </div>
                <div class="chat-title">朋友圈</div>
                <div class="chat-more" onclick="showPublishMomentModal()">➕</div>
            </div>
            
            <div class="moments-content" id="momentsContent">
                <div class="moments-empty" id="momentsEmpty">
                    <div class="moments-empty-icon">📝</div>
                    <div class="moments-empty-text">还没有朋友圈动态</div>
                    <button class="moments-empty-btn" onclick="showPublishMomentModal()">发布第一条动态</button>
                </div>
                
                <div class="moments-list" id="momentsList" style="display: none;">
                    <!-- 朋友圈列表将在这里渲染 -->
                </div>
            </div>
        </div>

        <!-- 个人信息页面 -->
        <div class="profile-page" id="profilePage">
            <div class="chat-header">
                <div class="back-btn" onclick="closeProfilePage()">
                    <span>‹</span>
                    <span>Whale-LLT</span>
                </div>
                <div class="chat-title">个人信息</div>
                <div style="width: 24px;"></div>
            </div>
            
            <div class="profile-header">
                <div class="profile-avatar" id="userAvatar">我</div>
                <div class="profile-name" id="userName">我的昵称</div>
                <div class="profile-id">id号：AI_User_001</div>
            </div>
            
            <div class="profile-section">
                <div class="profile-item" onclick="showEditProfileModal()">
                    <div class="profile-item-label">编辑个人信息</div>
                    <div class="profile-item-arrow">›</div>
                </div>
            </div>
            
            <!-- 数据迁移部分 -->
            <div class="data-migration-section">
                <div class="migration-header">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M19 12H5M19 12L15 8M19 12L15 16M5 12L9 8M5 12L9 16" stroke="#666" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M12 22C17.5228 22 22 17.5228 22 12C22 6.47715 17.5228 2 12 2C6.47715 2 2 6.47715 2 12C2 17.5228 6.47715 22 12 22Z" stroke="#666" stroke-width="2"/>
                    </svg>
                    数据迁移
                </div>
                
                <div class="migration-hint">
                    将聊天记录、联系人、设置等数据导出为文件，然后在其他设备上导入。
                </div>
                
                <div class="migration-buttons">
                    <div class="migration-btn export-btn" onclick="exportData()">
                        导出数据
                    </div>
                    <div class="migration-btn import-btn" onclick="document.getElementById('importFile').click()">
                        导入数据
                        <input type="file" id="importFile" class="file-input" accept=".json" onchange="importData(event)" style="display: none;">
                    </div>
                </div>
                
                <div class="migration-hint">
                    提示：导入数据会覆盖当前设备上的所有数据，请谨慎操作。
                </div>
            </div>
        </div>

        <!-- 设置菜单 -->
        <div class="settings-menu" id="settingsMenu">
            <div class="menu-item" onclick="showEditContactModal()">编辑联系人</div>
            <div class="menu-item" onclick="showBackgroundModal()">设置背景</div>
            <div class="menu-item" onclick="clearMessages()">清空聊天</div>
        </div>
    </div>

    <!-- 底部导航 -->
    <div class="bottom-nav">
        <div class="nav-item active">
            <div class="nav-icon">💬</div>
            <div class="nav-text">Whale-LLT</div>
        </div>
        <div class="nav-item">
            <div class="nav-icon">📞</div>
            <div class="nav-text">通讯录</div>
        </div>
        <div class="nav-item" onclick="openMomentsPage()">
            <div class="nav-icon">🔍</div>
            <div class="nav-text">发现</div>
        </div>
        <div class="nav-item" onclick="openProfilePage()">
            <div class="nav-icon">👤</div>
            <div class="nav-text">我</div>
        </div>
    </div>

    <!-- 发布朋友圈模态框 -->
    <div class="publish-moment-modal" id="publishMomentModal">
        <div class="publish-moment-content">
            <div class="publish-moment-header">
                <div class="publish-moment-title">生成朋友圈</div>
                <div class="publish-moment-close" onclick="closePublishMomentModal()">取消</div>
            </div>
            <div class="publish-moment-body">
                <div class="generate-moment-section">
                    <button class="generate-moment-btn" onclick="generateMomentContent()">生成朋友圈</button>
                    <div class="generate-moment-hint">
                        点击上方按钮，AI将根据当前角色的人设和聊天记录自动生成朋友圈内容
                    </div>
                </div>
                
                <div class="moment-preview" id="momentPreview">
                    <div class="moment-preview-title">预览</div>
                    <div class="moment-preview-content" id="momentPreviewContent"></div>
                    <img class="moment-preview-image" id="momentPreviewImage" style="display: none;">
                </div>
                
                <div class="unsplash-key-section">
                    <label class="unsplash-key-label">Unsplash API Key</label>
                    <input type="text" class="unsplash-key-input" id="unsplashApiKey" placeholder="请输入你的Unsplash API Key">
                </div>
                
                <button class="publish-moment-submit" id="publishMomentBtn" onclick="publishMoment()" disabled>发布</button>
            </div>
        </div>
    </div>

    <!-- 模态框们 -->
    <!-- 添加/编辑联系人 -->
    <div class="modal" id="addContactModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="contactModalTitle">添加AI助手</div>
                <div class="modal-close" onclick="closeModal('addContactModal')">取消</div>
            </div>
            <div class="modal-body">
                <form onsubmit="saveContact(event)">
                    <div class="form-group">
                        <label class="form-label">助手名称</label>
                        <input type="text" class="form-input" id="contactName" required>
                    </div>
                    <!-- 修改后的头像上传 -->
                    <div class="form-group">
                        <label class="form-label">头像（可选）</label>
                        <input type="url" class="form-input" id="contactAvatar" placeholder="可直接粘贴URL或上传本地图片">
                        <div style="display: flex; align-items: center; gap: 10px; margin-top: 8px;">
                            <input type="file" id="avatarUploadInput" accept="image/*" style="flex: 1;" onchange="handleFileUpload('avatarUploadInput', 'contactAvatar', 'avatarUploadStatus')">
                            <span id="avatarUploadStatus" style="font-size: 12px; color: #07c160;"></span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">人设描述</label>
                        <textarea class="form-textarea" id="contactPersonality" required placeholder="描述AI的性格、背景、说话风格等"></textarea>
                    </div>
                    
                    <!-- 自定义提示词部分 -->
                    <div class="prompt-section">
                        <div class="prompt-header">
                            <div class="prompt-title">自定义提示词（可选）</div>
                            <div class="prompt-actions">
                                <button type="button" class="prompt-btn" onclick="document.getElementById('promptFile').click()">导入JSON</button>
                                <input type="file" id="promptFile" class="file-input" accept=".json" onchange="importPrompts(event)">
                            </div>
                        </div>
                        <div class="form-group">
                            <textarea class="form-textarea" id="customPrompts" placeholder="输入自定义提示词，或导入JSON文件"></textarea>
                        </div>
                    </div>
                    
                    <button type="submit" class="form-submit">确定</button>
                </form>
            </div>
        </div>
    </div>

    <!-- 创建群聊模态框 -->
    <div class="modal" id="createGroupModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">创建群聊</div>
                <div class="modal-close" onclick="closeModal('createGroupModal')">取消</div>
            </div>
            <div class="modal-body">
                <form onsubmit="createGroup(event)">
                    <div class="form-group">
                        <label class="form-label">群聊名称</label>
                        <input type="text" class="form-input" id="groupName" required>
                    </div>
                    
                    <div class="create-group-section">
                        <label class="form-label">选择群成员</label>
                        <div class="group-member-list" id="groupMemberList"></div>
                    </div>
                    
                    <button type="submit" class="form-submit">创建群聊</button>
                </form>
            </div>
        </div>
    </div>

    <!-- 编辑个人信息 -->
    <div class="modal" id="editProfileModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">编辑个人信息</div>
                <div class="modal-close" onclick="closeModal('editProfileModal')">取消</div>
            </div>
            <div class="modal-body">
                <form onsubmit="saveProfile(event)">
                    <div class="form-group">
                        <label class="form-label">昵称</label>
                        <input type="text" class="form-input" id="profileName" required>
                    </div>
                    <!-- 修改后的个人头像上传 -->
                    <div class="form-group">
                        <label class="form-label">头像（可选）</label>
                        <input type="url" class="form-input" id="profileAvatar" placeholder="可直接粘贴URL或上传本地图片">
                         <div style="display: flex; align-items: center; gap: 10px; margin-top: 8px;">
                            <input type="file" id="profileUploadInput" accept="image/*" style="flex: 1;" onchange="handleFileUpload('profileUploadInput', 'profileAvatar', 'profileUploadStatus')">
                            <span id="profileUploadStatus" style="font-size: 12px; color: #07c160;"></span>
                        </div>
                    </div>
                    <button type="submit" class="form-submit">保存</button>
                </form>
            </div>
        </div>
    </div>

    <!-- API设置 -->
    <div class="modal" id="apiSettingsModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">API设置</div>
                <div class="modal-close" onclick="closeModal('apiSettingsModal')">取消</div>
            </div>
            <div class="modal-body">
                <form onsubmit="saveApiSettings(event)">
                    <div class="form-group">
                        <label class="form-label">API URL</label>
                        <!-- MODIFIED: Updated placeholder to guide users -->
                        <input type="url" class="form-input" id="apiUrl" required placeholder="例如: https://api.openai.com/v1">
                    </div>
                    <div class="form-group">
                        <label class="form-label">API Key</label>
                        <input type="password" class="form-input" id="apiKey" required>
                    </div>
                    
                    <!-- 上下文控制部分 -->
                    <div class="context-control">
                        <div class="context-header">
                            <div class="context-title">上下文长度</div>
                            <div class="context-value" id="contextValue">10条</div>
                        </div>
                        <input 
                            type="range" 
                            class="context-slider" 
                            id="contextSlider" 
                            min="1" 
                            max="50" 
                            value="10"
                            oninput="updateContextValue(this.value)"
                        >
                        <div class="context-info">
                            控制AI可见的历史消息数量，较长的上下文有助于保持对话连贯性，但可能会增加API成本。
                        </div>
                    </div>
                    
                    <button type="button" class="form-submit" onclick="testApiConnection()" style="margin-bottom: 10px;">测试连接</button>
                    <div class="form-group">
                        <label class="form-label">选择模型</label>
                        <div class="model-list" id="modelList">
                            <div class="loading-text">请先测试连接</div>
                        </div>
                    </div>
                    <button type="submit" class="form-submit">保存</button>
                </form>
            </div>
        </div>
    </div>

    <!-- 背景设置 -->
    <div class="modal" id="backgroundModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">设置聊天背景</div>
                <div class="modal-close" onclick="closeModal('backgroundModal')">取消</div>
            </div>
            <div class="modal-body">
                <form onsubmit="setBackground(event)">
                    <!-- 修改后的背景上传 -->
                    <div class="form-group">
                        <label class="form-label">背景图片</label>
                        <input type="url" class="form-input" id="backgroundUrl" placeholder="可直接粘贴URL或上传本地图片">
                        <div style="display: flex; align-items: center; gap: 10px; margin-top: 8px;">
                            <input type="file" id="bgUploadInput" accept="image/*" style="flex: 1;" onchange="handleFileUpload('bgUploadInput', 'backgroundUrl', 'bgUploadStatus')">
                            <span id="bgUploadStatus" style="font-size: 12px; color: #07c160;"></span>
                        </div>
                    </div>
                    <button type="submit" class="form-submit">确定</button>
                </form>
            </div>
        </div>
    </div>

    <!-- 添加表情 -->
    <div class="modal" id="addEmojiModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">添加表情包</div>
                <div class="modal-close" onclick="closeModal('addEmojiModal')">取消</div>
            </div>
            <div class="modal-body">
                <form onsubmit="addEmoji(event)">
                     <!-- 修改后的表情上传 -->
                    <div class="form-group">
                        <label class="form-label">表情图片</label>
                        <input type="url" class="form-input" id="emojiUrl" placeholder="可直接粘贴URL或上传本地图片" required>
                        <div style="display: flex; align-items: center; gap: 10px; margin-top: 8px;">
                            <input type="file" id="emojiUploadInput" accept="image/*" style="flex: 1;" onchange="handleFileUpload('emojiUploadInput', 'emojiUrl', 'emojiUploadStatus')">
                            <span id="emojiUploadStatus" style="font-size: 12px; color: #07c160;"></span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">表情含义（用于AI理解）</label>
                        <input type="text" class="form-input" id="emojiMeaning" required placeholder="例如：开心、大笑、哭泣等">
                    </div>
                    <button type="submit" class="form-submit">添加</button>
                </form>
            </div>
        </div>
    </div>
    
    <!-- 发红包模态框 -->
    <div class="modal" id="redPacketModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">发红包</div>
                <div class="modal-close" onclick="closeModal('redPacketModal')">取消</div>
            </div>
            <div class="modal-body">
                <form onsubmit="sendRedPacket(event)">
                    <div class="form-group">
                        <label class="form-label">金额</label>
                        <input type="number" class="form-input" id="redPacketAmount" step="0.01" required placeholder="0.00">
                    </div>
                    <div class="form-group">
                        <label class="form-label">留言（可选）</label>
                        <input type="text" class="form-input" id="redPacketMessage" placeholder="恭喜发财，大吉大利！">
                    </div>
                    <button type="submit" class="form-submit">塞钱进红包</button>
                </form>
            </div>
        </div>
    </div>


    <!-- 音乐设置弹窗 -->
    <div id="musicModal" class="music-modal">
        <div class="music-modal-content">
            <span class="close-btn" id="closeMusicModal">&times;</span>
            <h2>🎵 音乐播放器</h2>
            
            <!-- 当前播放信息 -->
            <div id="currentSongInfo" style="display: none;">
                <h3>正在播放: <span id="currentSongName"></span></h3>
                <div class="player-controls">
                    <div class="progress-bar" id="progressBar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                    <div class="time-display">
                        <span id="currentTime">0:00</span>
                        <span id="totalTime">0:00</span>
                    </div>
                    <div style="text-align: center; margin-top: 10px;">
                        <button class="form-submit" onclick="togglePlay()">
                            <span id="playPauseBtn">▶️ 播放</span>
                        </button>
                        <button class="form-submit" style="background-color: #888;" onclick="stopMusic()">⏹️ 停止</button>
                    </div>
                </div>
            </div>

            <!-- 歌单 -->
            <h3>我的歌单</h3>
            <div class="playlist-container" id="playlistContainer">
                <p style="text-align: center; color: #999;">暂无歌曲</p>
            </div>

            <!-- 添加新歌曲 -->
            <h3>添加新歌曲</h3>
            <div id="addSongForm">
                <div class="form-group">
                    <label class="form-label">歌曲名称 (可选):</label>
                    <input type="text" class="form-input" id="songName" placeholder="留空则使用文件名">
                </div>
                <div class="form-group">
                    <label class="form-label">选择音乐文件:</label>
                    <input type="file" class="form-input" id="musicFileUpload" accept="audio/*">
                </div>
                <div class="form-group">
                    <label class="form-label">LRC歌词文件 (可选):</label>
                    <input type="file" class="form-input" id="lrcFile" accept=".lrc">
                    <small style="color: #666;">请选择.lrc格式的歌词文件</small>
                </div>
                <button class="form-submit" onclick="saveSong()">保存歌曲</button>
            </div>

            <!-- 歌词显示设置 -->
            <div style="margin-top: 20px;">
                <label>
                    <input type="checkbox" id="showLyrics" onchange="toggleLyricsDisplay()">
                    显示浮动歌词
                </label>
            </div>
        </div>
    </div>

    <!-- 浮动歌词 -->
    <div id="floatingLyrics" class="floating-lyrics" style="display: none;">
        <span id="currentLyric">等待歌词...</span>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast"></div>
    
    <!-- 顶部通知 -->
    <div class="top-notification" id="topNotification"></div>

    <script>
        // --- [MODIFIED] 通用文件上传函数 (上传到服务器以获取永久链接) ---
        async function handleFileUpload(inputId, targetUrlInputId, statusElementId) {
            const fileInput = document.getElementById(inputId);
            const file = fileInput.files[0];
            const statusElement = document.getElementById(statusElementId);
            const targetUrlInput = document.getElementById(targetUrlInputId);

            if (!file) {
                showToast('请先选择一个文件');
                return;
            }

            if (!file.type.startsWith('image/')) {
                showToast('请上传图片文件');
                fileInput.value = ''; // 清空选择
                return;
            }

            if (statusElement) statusElement.textContent = '上传中...';
            
            // 创建 FormData 来包装文件数据
            const formData = new FormData();
            // 这里的 'image' 键必须与 server.js 中 multer 设置的 fieldname 'image' 一致
            formData.append('image', file); 

            try {
                // 发送请求到后端的 /upload 接口
                const response = await fetch('/upload', {
                    method: 'POST',
                    body: formData,
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ error: '上传请求失败' }));
                    throw new Error(errorData.error || `服务器错误: ${response.status}`);
                }

                const result = await response.json();

                // 服务器返回格式为 { url: '...' }
                if (result.url) {
                    targetUrlInput.value = result.url; // 将服务器返回的永久URL填入输入框
                    if (statusElement) statusElement.textContent = '上传成功！';
                    showToast('图片上传成功');
                } else {
                    throw new Error('服务器未返回有效的URL');
                }

            } catch (error) {
                console.error('文件上传失败:', error);
                if (statusElement) statusElement.textContent = '上传失败';
                showToast(`上传失败: ${error.message}`);
            }
        }

        // 全局状态
        let contacts = [];
        let currentContact = null;
        let editingContact = null;
        let apiSettings = {
            url: '',
            key: '',
            model: '',
            contextMessageCount: 10
        };
        let emojis = [];
        let backgrounds = {};
        let userProfile = {
            name: '我的昵称',
            avatar: ''
        };
        let moments = [];
        
        // --- 音乐播放器全局变量 ---
        let audio = null; // Audio element
        let db = null; // IndexedDB database connection
        let playlist = []; // In-memory playlist of metadata
        let currentSongIndex = -1;
        let isPlaying = false;
        let lyricTimer = null;
        let currentObjectUrl = null; // To keep track of the current blob URL for revocation

        // 默认记忆表格模板
        const defaultMemoryTable = `# 角色设定
- 姓名：
- 性格特点：
- 性别：
- 说话风格：
- 职业：

# 用户设定
- 姓名：
- 性别：
- 与角色的关系：
- 用户性格：

# 背景设定
- 时间地点：
- 事件：
---
## 系统指令
你需要在每次对话结束时，按以下格式生成记忆表格。每次都要：
1. 完整复制上一次的表格内容
2. 根据本次对话新增相关信息
3. 将表格放在回复的最末尾

### 表格格式要求：
## 📋 记忆表格

### 【现在】
| 项目 | 内容 |
|------|------|
| 地点 | [当前所在的具体地点] |
| 人物 | [当前在场的所有人物] |
| 时间 | [精确的年月日和时间，格式：YYYY年MM月DD日 HH:MM] |

### 【未来】
| 约定事项 | 详细内容 |
|----------|----------|
| [事项1]   | [具体的约定内容、时间、地点] |
| [事项2]   | [具体的约定内容、时间、地点] |

### 【过去】
| 人物 | 事件 | 地点 | 时间 |
|------|------|------|------|
| [相关人物] | [发生的重要事件] | [事件发生地点] | [具体年月日] |

### 【重要物品】
| 物品名称 | 物品描述 | 重要原因 |
|----------|----------|----------|
| [物品1]   | [详细的外观和特征描述] | [为什么这个物品重要] |
| [物品2]   | [详细的外观和特征描述] | [为什么这个物品重要] |
`;

        // 初始化函数
        function init() {
            loadFromStorage();
            renderContactList();
            renderEmojiGrid();
            updateUserProfile();
            updateContextIndicator();
            renderMomentsList();
            initMusicPlayer();
            
            const chatInput = document.getElementById('chatInput');
            chatInput.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = this.scrollHeight + 'px';
            });
            
            setTimeout(() => {
                const hint = document.getElementById('featureHint');
                if (hint) {
                    hint.style.display = 'block';
                    setTimeout(() => {
                        hint.style.display = 'none';
                    }, 5000);
                }
            }, 1000);
        }

        // 朋友圈相关函数
        function openMomentsPage() {
            document.getElementById('momentsPage').classList.add('active');
            renderMomentsList();
        }

        function closeMomentsPage() {
            document.getElementById('momentsPage').classList.remove('active');
        }

        function showPublishMomentModal() {
            document.getElementById('publishMomentModal').style.display = 'block';
            document.getElementById('momentPreview').style.display = 'none';
            document.getElementById('publishMomentBtn').disabled = true;
        }

        function closePublishMomentModal() {
            document.getElementById('publishMomentModal').style.display = 'none';
        }

        async function generateMomentContent() {
            if (!currentContact) {
                showToast('请先选择一个联系人');
                return;
            }

            if (!apiSettings.url || !apiSettings.key || !apiSettings.model) {
                showToast('请先设置API');
                return;
            }

            const generateBtn = document.querySelector('.generate-moment-btn');
            generateBtn.disabled = true;
            generateBtn.textContent = '生成中...';

            try {
                let systemPrompt = `你是${currentContact.name}，${currentContact.personality}
现在需要你以${currentContact.name}的身份发一条朋友圈。

要求：
1. 根据你的人设和最近的聊天记录，生成一条符合你性格的朋友圈文案
2. 文案要自然、真实，体现你的个性特点
3. 直接输出文案内容，不要任何解释或说明
4. 文案长度控制在50字以内
5. 可以包含适当的表情符号
6. 文案应该适合配图，描述具体的场景、情感或活动`;

                if (currentContact.messages && currentContact.messages.length > 0) {
                    const recentMessages = currentContact.messages.slice(-apiSettings.contextMessageCount);
                    const chatContext = recentMessages.map(msg => {
                        if (msg.role === 'user') {
                            return `用户: ${msg.content}`;
                        } else {
                            const sender = contacts.find(c => c.id === msg.senderId);
                            const senderName = sender ? sender.name : currentContact.name;
                            return `${senderName}: ${msg.content}`;
                        }
                    }).join('\n');
                    
                    systemPrompt += `\n\n最近的聊天记录：\n${chatContext}`;
                }

                const requestBody = {
                    model: apiSettings.model,
                    messages: [
                        { role: 'system', content: systemPrompt }
                    ],
                    temperature: 0.8,
                    max_tokens: 200
                };

                const response = await fetch(`/proxy/v1/chat/completions`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiSettings.key}`,
                        'X-Target-URL': apiSettings.url
                    },
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) {
                    throw new Error(`API请求失败: ${response.status}`);
                }

                const data = await response.json();
                const momentContent = data.choices[0].message.content.trim();

                let imageUrl = null;
                const unsplashKey = document.getElementById('unsplashApiKey').value.trim();
                if (unsplashKey) {
                    imageUrl = await fetchMatchingImageForPublish(momentContent, unsplashKey);
                }

                const comments = await generateAIComments(momentContent);

                const moment = {
                    id: Date.now().toString(),
                    authorName: currentContact.name,
                    authorAvatar: currentContact.avatar,
                    content: momentContent,
                    image: imageUrl,
                    time: new Date(),
                    likes: 0,
                    comments: comments
                };

                moments.unshift(moment);
                saveToStorage();
                renderMomentsList();
                closePublishMomentModal();
                showToast('朋友圈发布成功');

            } catch (error) {
                console.error('生成朋友圈失败:', error);
                showToast('生成失败: ' + error.message);
            } finally {
                generateBtn.disabled = false;
                generateBtn.textContent = '生成朋友圈';
            }
        }

        async function fetchMatchingImageForPublish(content, apiKey) {
            try {
                let searchQuery = await generateImageSearchQuery(content);
                if (!searchQuery) {
                    searchQuery = extractImageKeywords(content);
                }
                const response = await fetch(`https://api.unsplash.com/search/photos?query=${encodeURIComponent(searchQuery)}&per_page=3&orientation=landscape`, {
                    headers: {
                        'Authorization': `Client-ID ${apiKey}`
                    }
                });
                if (!response.ok) throw new Error('Unsplash API请求失败');
                const data = await response.json();
                return (data.results && data.results.length > 0) ? data.results[0].urls.regular : null;
            } catch (error) {
                console.error('获取配图失败:', error);
                return null;
            }
        }

        async function fetchMatchingImage(content, apiKey) {
            try {
                let searchQuery = await generateImageSearchQuery(content);
                if (!searchQuery) {
                    searchQuery = extractImageKeywords(content);
                }
                const response = await fetch(`https://api.unsplash.com/search/photos?query=${encodeURIComponent(searchQuery)}&per_page=3&orientation=landscape`, {
                    headers: {
                        'Authorization': `Client-ID ${apiKey}`
                    }
                });
                if (!response.ok) throw new Error('Unsplash API请求失败');
                const data = await response.json();
                if (data.results && data.results.length > 0) {
                    const imageUrl = data.results[0].urls.regular;
                    const previewImage = document.getElementById('momentPreviewImage');
                    previewImage.src = imageUrl;
                    previewImage.style.display = 'block';
                } else {
                    showToast('未找到合适的配图，将发布纯文字朋友圈');
                    document.getElementById('momentPreviewImage').style.display = 'none';
                }
            } catch (error) {
                console.error('获取配图失败:', error);
                showToast('配图获取失败，将发布纯文字朋友圈');
                document.getElementById('momentPreviewImage').style.display = 'none';
            }
        }

        async function generateImageSearchQuery(content) {
            if (!apiSettings.url || !apiSettings.key || !apiSettings.model) return null;
            try {
                const systemPrompt = `你是一个图片搜索关键词生成器。根据朋友圈文案内容，生成最适合的英文搜索关键词用于图片搜索。

要求：
1. 分析文案的情感、场景、活动类型
2. 生成3-5个英文关键词，用空格分隔
3. 关键词要具体、形象，适合搜索到相关图片
4. 避免人像关键词，优先选择风景、物品、场景类关键词
5. 只输出关键词，不要其他解释

文案内容：${content}`;
                const requestBody = {
                    model: apiSettings.model,
                    messages: [{ role: 'system', content: systemPrompt }],
                    temperature: 0.7,
                    max_tokens: 100
                };
                const response = await fetch(`/proxy/v1/chat/completions`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiSettings.key}`,
                        'X-Target-URL': apiSettings.url
                    },
                    body: JSON.stringify(requestBody)
                });
                if (!response.ok) throw new Error(`API请求失败: ${response.status}`);
                const data = await response.json();
                return data.choices[0].message.content.trim();
            } catch (error) {
                console.error('AI关键词生成失败:', error);
                return null;
            }
        }

        function extractImageKeywords(content) {
            const emotionMap = { '开心': 'happy sunshine joy', '难过': 'sad rain melancholy', '兴奋': 'excited celebration party', '平静': 'peaceful calm nature', '浪漫': 'romantic sunset flowers', '怀念': 'nostalgic vintage memories' };
            const sceneMap = { '咖啡': 'coffee cafe cozy', '旅行': 'travel landscape adventure', '美食': 'food delicious cooking', '工作': 'office workspace productivity', '运动': 'sports fitness outdoor', '读书': 'books reading library', '音乐': 'music instruments concert', '电影': 'cinema movie theater', '购物': 'shopping fashion style', '聚会': 'party friends celebration' };
            let keywords = [];
            for (const [chinese, english] of Object.entries(emotionMap)) { if (content.includes(chinese)) { keywords.push(english); break; } }
            for (const [chinese, english] of Object.entries(sceneMap)) { if (content.includes(chinese)) { keywords.push(english); break; } }
            if (keywords.length === 0) keywords.push('lifestyle daily life aesthetic');
            return keywords.join(' ');
        }

        async function fetchUnsplashImage(content, apiKey, options = {}) {
            try {
                const keywords = extractKeywords(content);
                let query = keywords.join(' ') || 'daily life';
                if (options.noPortraits) query += ' -portrait -face -person -people';
                if (options.dailyLife) query += ' daily life everyday routine candid street photography';
                const response = await fetch(`https://api.unsplash.com/search/photos?query=${encodeURIComponent(query)}&per_page=1&orientation=landscape`, {
                    headers: { 'Authorization': `Client-ID ${apiKey}` }
                });
                if (!response.ok) throw new Error('Unsplash API请求失败');
                const data = await response.json();
                if (data.results && data.results.length > 0) {
                    const imageUrl = data.results[0].urls.regular;
                    const previewImage = document.getElementById('momentPreviewImage');
                    previewImage.src = imageUrl;
                    previewImage.style.display = 'block';
                } else {
                    showToast('未找到符合条件的图片');
                    document.getElementById('momentPreviewImage').style.display = 'none';
                }
            } catch (error) {
                console.error('获取配图失败:', error);
                showToast('配图获取失败');
                document.getElementById('momentPreviewImage').style.display = 'none';
            }
        }

        function extractKeywords(text) {
            const commonWords = ['的', '了', '在', '是', '我', '你', '他', '她', '它', '们', '这', '那', '有', '和', '与', '或', '但', '而', '就', '都', '也', '还', '又', '再', '很', '最', '更', '非常', '特别', '真的', '确实'];
            const words = text.replace(/[^\u4e00-\u9fa5a-zA-Z0-9]/g, ' ').split(/\s+/).filter(word => word.length > 1 && !commonWords.includes(word));
            return words.slice(0, 3);
        }

        async function generateAIComments(momentContent) {
            if (!apiSettings.url || !apiSettings.key || !apiSettings.model) {
                return generateRandomComments(momentContent);
            }
            try {
                const systemPrompt = `你是一个朋友圈评论生成器，需要根据朋友圈文案生成3-5条路人评论。

要求：
1. 根据文案内容生成3-5条相关评论
2. 路人角色类型包括：CP头子、乐子人、搅混水的、理性分析党、颜狗等
3. 使用当代网络流行语：YYDS、绝绝子、谐音梗、林黛玉文学等
4. 评论要有不同观点和立场
5. 每条评论至少20字
6. 评论者名称使用：路人甲、小明、小红、隔壁老王、神秘网友、热心市民、吃瓜群众等

输出格式：
评论者名称|评论内容
评论者名称|评论内容
...

朋友圈文案：${momentContent}`;
                const requestBody = {
                    model: apiSettings.model,
                    messages: [{ role: 'system', content: systemPrompt }],
                    temperature: 0.9,
                    max_tokens: 800
                };
                const response = await fetch(`/proxy/v1/chat/completions`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiSettings.key}`,
                        'X-Target-URL': apiSettings.url
                    },
                    body: JSON.stringify(requestBody)
                });
                if (!response.ok) throw new Error(`API请求失败: ${response.status}`);
                const data = await response.json();
                const aiResponse = data.choices[0].message.content.trim();
                const comments = [];
                const lines = aiResponse.split('\n').filter(line => line.trim() && line.includes('|'));
                for (const line of lines) {
                    const [author, content] = line.split('|').map(s => s.trim());
                    if (author && content && content.length >= 15) {
                        comments.push({ author, content, time: new Date(Date.now() - Math.floor(Math.random() * 600000)) });
                    }
                }
                if (comments.length < 3) {
                    const fallbackComments = generateRandomComments(momentContent);
                    return [...comments, ...fallbackComments.slice(0, 3 - comments.length)];
                }
                return comments.slice(0, 5);
            } catch (error) {
                console.error('AI评论生成失败:', error);
                return generateRandomComments(momentContent);
            }
        }

        async function publishMoment() {
            const content = document.getElementById('momentPreviewContent').textContent;
            const imageElement = document.getElementById('momentPreviewImage');
            const imageUrl = imageElement.style.display === 'block' ? imageElement.src : null;
            if (!content) {
                showToast('请先生成朋友圈内容');
                return;
            }
            const publishBtn = document.getElementById('publishMomentBtn');
            publishBtn.disabled = true;
            publishBtn.textContent = '发布中...';
            try {
                const comments = await generateAIComments(content);
                const moment = { id: Date.now().toString(), authorName: currentContact.name, authorAvatar: currentContact.avatar, content, image: imageUrl, time: new Date(), likes: 0, comments };
                moments.unshift(moment);
                saveToStorage();
                renderMomentsList();
                closePublishMomentModal();
                showToast('朋友圈发布成功');
            } catch (error) {
                console.error('发布朋友圈失败:', error);
                showToast('发布失败: ' + error.message);
            } finally {
                publishBtn.disabled = false;
                publishBtn.textContent = '发布';
            }
        }

        function renderMomentsList() {
            const momentsEmpty = document.getElementById('momentsEmpty');
            const momentsList = document.getElementById('momentsList');
            if (moments.length === 0) {
                momentsEmpty.style.display = 'block';
                momentsList.style.display = 'none';
            } else {
                momentsEmpty.style.display = 'none';
                momentsList.style.display = 'block';
                momentsList.innerHTML = '';
                moments.forEach(moment => {
                    const momentDiv = document.createElement('div');
                    momentDiv.className = 'moment-item';
                    let avatarContent = moment.authorAvatar ? `<img src="${moment.authorAvatar}">` : moment.authorName[0];
                    let imageContent = moment.image ? `<img src="${moment.image}" class="moment-image">` : '';
                    let commentsContent = '';
                    if (moment.comments && moment.comments.length > 0) {
                        commentsContent = `<div style="margin-top: 10px; padding-top: 10px; border-top: 0.5px solid #eee;">${moment.comments.map(comment => `<div style="font-size: 13px; color: #576b95; margin-bottom: 4px;"><span>${comment.author}: </span><span style="color: #333;">${comment.content}</span></div>`).join('')}</div>`;
                    }
                    momentDiv.innerHTML = `<div class="moment-header"><div class="moment-avatar">${avatarContent}</div><div class="moment-info"><div class="moment-name">${moment.authorName}</div><div class="moment-time">${formatTime(moment.time)}</div></div></div><div class="moment-content">${moment.content}</div>${imageContent}${commentsContent}`;
                    momentsList.appendChild(momentDiv);
                });
            }
        }
        
        // --- IndexedDB Functions ---
        function openDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open('MusicPlayerDB', 1);

                request.onupgradeneeded = event => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains('songs')) {
                        db.createObjectStore('songs', { keyPath: 'id', autoIncrement: true });
                    }
                };

                request.onsuccess = event => {
                    db = event.target.result;
                    resolve(db);
                };

                request.onerror = event => {
                    console.error('IndexedDB error:', event.target.errorCode);
                    reject('IndexedDB error');
                };
            });
        }

        async function initMusicPlayer() {
            try {
                await openDB();
                await loadPlaylistFromDB();
            } catch (error) {
                console.error("Failed to initialize music player:", error);
                showToast("无法加载音乐库");
            }

            document.getElementById('musicIcon').addEventListener('click', showMusicModal);
            document.getElementById('closeMusicModal').addEventListener('click', closeMusicModal);
            document.getElementById('progressBar').addEventListener('click', seekMusic);
            window.addEventListener('click', (event) => { if (event.target === document.getElementById('musicModal')) closeMusicModal(); });
            
            audio = new Audio();
            audio.addEventListener('timeupdate', updateProgress);
            audio.addEventListener('ended', onSongEnded);
            audio.addEventListener('loadedmetadata', onMetadataLoaded);
        }

        async function loadPlaylistFromDB() {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['songs'], 'readonly');
                const store = transaction.objectStore('songs');
                const request = store.getAll();

                request.onsuccess = () => {
                    playlist = request.result.map(song => ({
                        id: song.id,
                        name: song.name,
                        lyrics: song.lyrics,
                    }));
                    renderPlaylist();
                    resolve();
                };

                request.onerror = (event) => {
                    console.error('Failed to load playlist from DB:', event.target.error);
                    reject('Failed to load playlist');
                };
            });
        }
        
        async function saveSong() {
            const nameInput = document.getElementById('songName');
            const musicFileInput = document.getElementById('musicFileUpload');
            const lrcFileInput = document.getElementById('lrcFile');

            const musicFile = musicFileInput.files[0];
            const lrcFile = lrcFileInput.files[0];

            if (!musicFile) {
                showToast('请选择一个音乐文件');
                return;
            }

            const songName = nameInput.value.trim() || musicFile.name.replace(/\.[^/.]+$/, "");

            let lyrics = [];
            if (lrcFile) {
                try {
                    const lrcText = await lrcFile.text();
                    lyrics = parseLRC(lrcText);
                } catch (e) {
                    showToast('歌词文件读取失败，将不带歌词保存。');
                }
            }
            
            const songRecord = {
                name: songName,
                music: musicFile, // Store the actual file blob
                lyrics: lyrics
            };

            const transaction = db.transaction(['songs'], 'readwrite');
            const store = transaction.objectStore('songs');
            const request = store.add(songRecord);

            request.onsuccess = async () => {
                showToast(`歌曲 "${songName}" 已成功保存到本地`);
                clearAddForm();
                await loadPlaylistFromDB(); // Refresh the playlist from DB
            };

            request.onerror = (event) => {
                console.error('Failed to save song to DB:', event.target.error);
                showToast('保存歌曲失败');
            };
        }
        
        async function playSong(index) {
            if (index < 0 || index >= playlist.length) return;
            
            const songInfo = playlist[index];
            currentSongIndex = index;

            // Revoke the previous object URL if it exists
            if (currentObjectUrl) {
                URL.revokeObjectURL(currentObjectUrl);
                currentObjectUrl = null;
            }

            const transaction = db.transaction(['songs'], 'readonly');
            const store = transaction.objectStore('songs');
            const request = store.get(songInfo.id);

            request.onsuccess = (event) => {
                const songRecord = event.target.result;
                if (songRecord && songRecord.music) {
                    currentObjectUrl = URL.createObjectURL(songRecord.music);
                    audio.src = currentObjectUrl;
                    audio.play().then(() => {
                        isPlaying = true;
                        updatePlayButton();
                        document.getElementById('currentSongInfo').style.display = 'block';
                        document.getElementById('currentSongName').textContent = songRecord.name;
                        currentLyrics = songRecord.lyrics || [];
                        currentLyricIndex = -1;
                        if (currentLyrics.length > 0) startLyricSync();
                        else document.getElementById('currentLyric').textContent = '暂无歌词';
                        renderPlaylist();
                    }).catch(error => showToast('播放失败: ' + error.message));
                } else {
                    showToast('无法从数据库中找到歌曲文件');
                }
            };

            request.onerror = (event) => {
                console.error("Error fetching song from DB:", event.target.error);
                showToast('播放歌曲时出错');
            };
        }
        
        async function deleteSong(index) {
            if (confirm('确定要永久删除这首歌吗？')) {
                const songInfo = playlist[index];
                
                const transaction = db.transaction(['songs'], 'readwrite');
                const store = transaction.objectStore('songs');
                const request = store.delete(songInfo.id);

                request.onsuccess = async () => {
                    showToast(`歌曲 "${songInfo.name}" 已删除`);
                    if (index === currentSongIndex) {
                        stopMusic();
                        currentSongIndex = -1;
                        document.getElementById('currentSongInfo').style.display = 'none';
                    }
                    await loadPlaylistFromDB(); // Refresh playlist from DB
                };

                request.onerror = (event) => {
                    console.error('Failed to delete song from DB:', event.target.error);
                    showToast('删除歌曲失败');
                };
            }
        }
        // --- [END] IndexedDB Functions ---

        function showMusicModal() {
            document.getElementById('musicModal').style.display = 'block';
            renderPlaylist();
        }

        function closeMusicModal() {
            document.getElementById('musicModal').style.display = 'none';
        }

        function renderPlaylist() {
            const container = document.getElementById('playlistContainer');
            if (playlist.length === 0) { container.innerHTML = '<p style="text-align: center; color: #999;">暂无歌曲，请从下方上传</p>'; return; }
            container.innerHTML = '';
            playlist.forEach((song, index) => {
                const songDiv = document.createElement('div');
                songDiv.className = 'song-item';
                if (index === currentSongIndex) songDiv.classList.add('active');
                songDiv.innerHTML = `<span onclick="playSong(${index})" style="flex: 1;">${song.name}</span><span class="delete-song" onclick="deleteSong(${index})">×</span>`;
                container.appendChild(songDiv);
            });
        }

        function parseLRC(lrcContent) {
            const lines = lrcContent.split(/\r?\n/);
            const lyrics = [];
            const timeRegex = /\[(\d{1,2}):(\d{1,2})(?:\.(\d{1,3}))?\]/g;
            lines.forEach(line => {
                if (!line.trim()) return;
                let match;
                let lastIndex = 0;
                const times = [];
                while ((match = timeRegex.exec(line)) !== null) {
                    const totalSeconds = parseInt(match[1]) * 60 + parseInt(match[2]) + (match[3] ? parseInt(match[3].padEnd(3, '0')) / 1000 : 0);
                    times.push(totalSeconds);
                    lastIndex = match.index + match[0].length;
                }
                if (times.length > 0) {
                    const text = line.substring(lastIndex).trim();
                    if (text) times.forEach(time => lyrics.push({ time, text }));
                }
            });
            lyrics.sort((a, b) => a.time - b.time);
            return lyrics;
        }

        function startLyricSync() {
            stopLyricSync();
            lyricTimer = setInterval(() => { if (!audio.paused && currentLyrics.length > 0) updateLyrics(); }, 100);
        }

        function stopLyricSync() {
            if (lyricTimer) clearInterval(lyricTimer);
            lyricTimer = null;
        }

        function updateLyrics() {
            const currentTime = audio.currentTime;
            let newIndex = -1;
            for (let i = currentLyrics.length - 1; i >= 0; i--) {
                if (currentTime >= currentLyrics[i].time) { newIndex = i; break; }
            }
            if (newIndex !== currentLyricIndex && newIndex >= 0) {
                currentLyricIndex = newIndex;
                const lyricText = currentLyrics[newIndex].text;
                document.getElementById('currentLyric').textContent = lyricText;
                sendLyricToAI(lyricText);
            }
        }

        function sendLyricToAI(lyricText) {
            if (currentSongIndex > -1) {
                 window.currentMusicInfo = { songName: playlist[currentSongIndex]?.name || '', lyric: lyricText, isPlaying };
            }
        }

        function togglePlay() {
            if (audio.src) {
                if (audio.paused) { audio.play(); isPlaying = true; startLyricSync(); }
                else { audio.pause(); isPlaying = false; stopLyricSync(); }
                updatePlayButton();
            }
        }

        function stopMusic() {
            audio.pause();
            audio.currentTime = 0;
            isPlaying = false;
            currentLyricIndex = -1;
            stopLyricSync();
            updatePlayButton();
            document.getElementById('currentLyric').textContent = '等待歌词...';
            window.currentMusicInfo = null;
            if (currentObjectUrl) {
                URL.revokeObjectURL(currentObjectUrl);
                currentObjectUrl = null;
            }
        }

        function updatePlayButton() {
            document.getElementById('playPauseBtn').textContent = isPlaying ? '⏸️ 暂停' : '▶️ 播放';
        }

        function updateProgress() {
            if (audio.duration) {
                document.getElementById('progressFill').style.width = (audio.currentTime / audio.duration) * 100 + '%';
                document.getElementById('currentTime').textContent = formatMusicTime(audio.currentTime);
            }
        }

        function onMetadataLoaded() {
            document.getElementById('totalTime').textContent = formatMusicTime(audio.duration);
        }

        function onSongEnded() {
            isPlaying = false;
            updatePlayButton();
            stopLyricSync();
            window.currentMusicInfo = null;
        }

        function seekMusic(event) {
            if (audio.duration) {
                const rect = event.currentTarget.getBoundingClientRect();
                audio.currentTime = ((event.clientX - rect.left) / rect.width) * audio.duration;
            }
        }

        function toggleLyricsDisplay() {
            document.getElementById('floatingLyrics').style.display = document.getElementById('showLyrics').checked ? 'block' : 'none';
        }

        function clearAddForm() {
            document.getElementById('songName').value = '';
            document.getElementById('musicFileUpload').value = '';
            document.getElementById('lrcFile').value = '';
        }

        function formatMusicTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        function loadFromStorage() {
            try {
                const savedContacts = localStorage.getItem('ai_contacts');
                if (savedContacts) {
                    contacts = JSON.parse(savedContacts);
                    contacts.forEach(contact => {
                        if (contact.type === undefined) contact.type = 'private';
                        if (contact.memoryTableContent === undefined) contact.memoryTableContent = defaultMemoryTable;
                        if (contact.messages) {
                            contact.messages.forEach(msg => {
                                if (msg.role === 'user' && msg.senderId === undefined) msg.senderId = 'user';
                                else if (msg.role === 'assistant' && msg.senderId === undefined) msg.senderId = contact.id;
                            });
                        }
                    });
                }
                const savedApiSettings = localStorage.getItem('ai_apiSettings');
                if (savedApiSettings) {
                    apiSettings = JSON.parse(savedApiSettings);
                    if (apiSettings.contextMessageCount === undefined) apiSettings.contextMessageCount = 10;
                }
                const savedEmojis = localStorage.getItem('ai_emojis');
                if (savedEmojis) emojis = JSON.parse(savedEmojis);
                const savedBackgrounds = localStorage.getItem('ai_backgrounds');
                if (savedBackgrounds) backgrounds = JSON.parse(savedBackgrounds);
                const savedUserProfile = localStorage.getItem('ai_userProfile');
                if (savedUserProfile) userProfile = JSON.parse(savedUserProfile);
                const savedMoments = localStorage.getItem('ai_moments');
                if (savedMoments) moments = JSON.parse(savedMoments);
            } catch (error) {
                console.error('加载数据失败:', error);
            }
        }

        let saveTimeout;
        function debounceSaveToStorage() {
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(saveToStorage, 500);
        }
        function saveToStorage() {
            try {
                localStorage.setItem('ai_contacts', JSON.stringify(contacts));
                localStorage.setItem('ai_apiSettings', JSON.stringify(apiSettings));
                localStorage.setItem('ai_emojis', JSON.stringify(emojis));
                localStorage.setItem('ai_backgrounds', JSON.stringify(backgrounds));
                localStorage.setItem('ai_userProfile', JSON.stringify(userProfile));
                localStorage.setItem('ai_moments', JSON.stringify(moments));
            } catch (error) {
                console.error('保存数据失败:', error);
            }
        }

        function updateContextIndicator() {
            const indicator = document.getElementById('contextIndicator');
            if (indicator) indicator.innerHTML = `上下文: ${apiSettings.contextMessageCount}条`;
        }

        function updateContextValue(value) {
            document.getElementById('contextValue').textContent = value + '条';
        }

        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 2000);
        }

        function showTopNotification(message) {
            const notification = document.getElementById('topNotification');
            notification.textContent = message;
            notification.classList.add('show');
            setTimeout(() => notification.classList.remove('show'), 1500);
        }

        function showModal(modalId) {
            document.getElementById(modalId).style.display = 'block';
            if (modalId === 'apiSettingsModal') {
                document.getElementById('contextSlider').value = apiSettings.contextMessageCount;
                document.getElementById('contextValue').textContent = apiSettings.contextMessageCount + '条';
            }
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
            if (modalId === 'addContactModal') {
                editingContact = null;
                document.getElementById('contactModalTitle').textContent = '添加AI助手';
                document.getElementById('contactName').value = '';
                document.getElementById('contactAvatar').value = '';
                document.getElementById('contactPersonality').value = '';
                document.getElementById('customPrompts').value = '';
            }
        }

        function showAddContactModal() {
            editingContact = null;
            document.getElementById('contactModalTitle').textContent = '添加AI助手';
            showModal('addContactModal');
        }

        function showEditContactModal() {
            if (!currentContact) { showToast('请先选择联系人'); return; }
            editingContact = currentContact;
            document.getElementById('contactModalTitle').textContent = '编辑AI助手';
            document.getElementById('contactName').value = currentContact.name;
            document.getElementById('contactAvatar').value = currentContact.avatar || '';
            document.getElementById('contactPersonality').value = currentContact.personality;
            document.getElementById('customPrompts').value = currentContact.customPrompts || '';
            showModal('addContactModal');
            toggleSettingsMenu();
        }

        function showApiSettingsModal() {
            document.getElementById('apiUrl').value = apiSettings.url;
            document.getElementById('apiKey').value = apiSettings.key;
            showModal('apiSettingsModal');
        }

        function showBackgroundModal() {
            if (!currentContact) { showToast('请先选择联系人'); return; }
            document.getElementById('backgroundUrl').value = backgrounds[currentContact.id] || '';
            showModal('backgroundModal');
            toggleSettingsMenu();
        }

        function showAddEmojiModal() {
            showModal('addEmojiModal');
            toggleEmojiPanel(true);
        }
        
        function showRedPacketModal() {
            showModal('redPacketModal');
        }

        function showEditProfileModal() {
            document.getElementById('profileName').value = userProfile.name;
            document.getElementById('profileAvatar').value = userProfile.avatar || '';
            showModal('editProfileModal');
        }

        function showCreateGroupModal() {
            const memberList = document.getElementById('groupMemberList');
            memberList.innerHTML = '';
            contacts.forEach(contact => {
                if (contact.type !== 'group') {
                    const item = document.createElement('div');
                    item.className = 'group-member-item';
                    item.innerHTML = `<div class="group-member-avatar">${contact.avatar ? `<img src="${contact.avatar}">` : contact.name[0]}</div><div class="group-member-name">${contact.name}</div><div class="group-member-checkbox">✓</div>`;
                    item.onclick = () => {
                        item.classList.toggle('selected');
                        item.querySelector('.group-member-checkbox').classList.toggle('selected');
                    };
                    memberList.appendChild(item);
                }
            });
            showModal('createGroupModal');
        }

        function saveContact(event) {
            event.preventDefault();
            const contactData = {
                name: document.getElementById('contactName').value,
                avatar: document.getElementById('contactAvatar').value,
                personality: document.getElementById('contactPersonality').value,
                customPrompts: document.getElementById('customPrompts').value
            };
            if (editingContact) {
                Object.assign(editingContact, contactData);
                showToast('修改成功');
            } else {
                const contact = { id: Date.now().toString(), ...contactData, messages: [], lastMessage: '点击开始聊天', lastTime: formatTime(new Date()), type: 'private', memoryTableContent: defaultMemoryTable };
                contacts.unshift(contact);
                showToast('添加成功');
            }
            saveToStorage();
            renderContactList();
            closeModal('addContactModal');
            event.target.reset();
        }

        function createGroup(event) {
            event.preventDefault();
            const groupName = document.getElementById('groupName').value;
            if (!groupName) { showToast('请输入群聊名称'); return; }
            const selectedItems = document.querySelectorAll('.group-member-item.selected');
            if (selectedItems.length < 2) { showToast('请至少选择两个成员'); return; }
            const memberIds = [];
            selectedItems.forEach(item => {
                const name = item.querySelector('.group-member-name').textContent;
                const contact = contacts.find(c => c.name === name && c.type === 'private');
                if (contact) memberIds.push(contact.id);
            });
            const group = { id: 'group_' + Date.now().toString(), name: groupName, members: memberIds, messages: [], lastMessage: '群聊已创建', lastTime: formatTime(new Date()), type: 'group', memoryTableContent: defaultMemoryTable };
            contacts.unshift(group);
            saveToStorage();
            renderContactList();
            closeModal('createGroupModal');
            showToast('群聊创建成功');
        }

        function importPrompts(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    document.getElementById('customPrompts').value = JSON.stringify(JSON.parse(e.target.result), null, 2);
                    showToast('导入成功');
                } catch (error) {
                    showToast('导入失败：文件格式错误');
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        function saveProfile(event) {
            event.preventDefault();
            userProfile.name = document.getElementById('profileName').value;
            userProfile.avatar = document.getElementById('profileAvatar').value;
            saveToStorage();
            updateUserProfile();
            closeModal('editProfileModal');
            showToast('保存成功');
        }

        function updateUserProfile() {
            const userAvatar = document.getElementById('userAvatar');
            const userName = document.getElementById('userName');
            userName.textContent = userProfile.name;
            userAvatar.innerHTML = userProfile.avatar ? `<img src="${userProfile.avatar}">` : (userProfile.name[0] || '我');
        }

        function openProfilePage() {
            document.getElementById('profilePage').classList.add('active');
        }

        function closeProfilePage() {
            document.getElementById('profilePage').classList.remove('active');
        }

        function renderContactList() {
            const contactList = document.getElementById('contactList');
            contactList.innerHTML = '';
            contacts.forEach(contact => {
                const item = document.createElement('div');
                item.className = 'contact-item';
                if (contact.type === 'group') {
                    item.innerHTML = `<div class="group-avatar"><div class="group-avatar-inner">${getGroupAvatarContent(contact)}</div></div><div class="contact-info"><div class="contact-name">${contact.name}</div><div class="contact-message">${contact.lastMessage}</div></div><div class="contact-time">${contact.lastTime}</div>`;
                } else {
                    item.innerHTML = `<div class="contact-avatar">${contact.avatar ? `<img src="${contact.avatar}">` : contact.name[0]}</div><div class="contact-info"><div class="contact-name">${contact.name}</div><div class="contact-message">${contact.lastMessage}</div></div><div class="contact-time">${contact.lastTime}</div>`;
                }
                item.onclick = () => openChat(contact);
                contactList.appendChild(item);
            });
        }

        function getGroupAvatarContent(group) {
            const memberAvatars = group.members.slice(0, 4).map(id => contacts.find(c => c.id === id)).filter(Boolean);
            let avatarContent = '';
            for (let i = 0; i < 4; i++) {
                if (i < memberAvatars.length) {
                    const member = memberAvatars[i];
                    avatarContent += `<div class="group-avatar-item">${member.avatar ? `<img src="${member.avatar}">` : member.name[0]}</div>`;
                } else {
                    avatarContent += `<div class="group-avatar-item"></div>`;
                }
            }
            return avatarContent;
        }

        function openChat(contact) {
            currentContact = contact;
            document.getElementById('chatTitle').textContent = contact.name;
            document.getElementById('chatPage').classList.add('active');
            renderMessages();
            updateContextIndicator();
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.style.backgroundImage = backgrounds[contact.id] ? `url(${backgrounds[contact.id]})` : 'none';
            toggleMemoryPanel(true);
        }

        function closeChatPage() {
            document.getElementById('chatPage').classList.remove('active');
            currentContact = null;
            toggleEmojiPanel(true);
            toggleSettingsMenu(true);
            toggleMemoryPanel(true);
        }

        function renderMessages() {
            if (!currentContact) return;
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.innerHTML = '';
            if (currentContact.type === 'group') {
                const hint = document.createElement('div');
                hint.className = 'group-info-hint';
                hint.textContent = `群聊成员: ${getGroupMembersText()}`;
                chatMessages.appendChild(hint);
            }
            currentContact.messages.forEach(msg => {
                const msgDiv = document.createElement('div');
                if (msg.role === 'system') {
                    msgDiv.className = 'message received';
                    msgDiv.innerHTML = `<div class="message-bubble"><div class="message-content" style="background-color: #f0f0f0; color: #666; text-align: center;">${msg.content}</div></div>`;
                } else {
                    msgDiv.className = `message ${msg.role === 'user' ? 'sent' : 'received'}`;
                    let contentHtml = '';
                    if (msg.type === 'emoji') {
                        contentHtml = `<img src="${msg.content}" class="message-emoji">`;
                    } else if (msg.type === 'red_packet') {
                        const packet = JSON.parse(msg.content);
                        contentHtml = `<div class="message-content red-packet" onclick="showToast('红包金额: ${packet.amount}')"><div class="red-packet-body"><svg class="red-packet-icon" viewBox="0 0 1024 1024"><path d="M840.4 304H183.6c-17.7 0-32 14.3-32 32v552c0 17.7 14.3 32 32 32h656.8c17.7 0 32-14.3 32-32V336c0-17.7-14.3-32-32-32zM731.2 565.2H603.9c-4.4 0-8 3.6-8 8v128.3c0 4.4 3.6 8 8 8h127.3c4.4 0 8-3.6 8-8V573.2c0-4.4-3.6-8-8-8zM419.8 565.2H292.5c-4.4 0-8 3.6-8 8v128.3c0 4.4 3.6 8 8 8h127.3c4.4 0 8-3.6 8-8V573.2c0-4.4-3.6-8-8-8z" fill="#FEFEFE"></path><path d="M872.4 240H151.6c-17.7 0-32 14.3-32 32v64h784v-64c0-17.7-14.3-32-32-32z" fill="#FCD4B3"></path><path d="M512 432c-48.6 0-88 39.4-88 88s39.4 88 88 88 88-39.4 88-88-39.4-88-88-88z m0 152c-35.3 0-64-28.7-64-64s28.7-64 64-64 64 28.7 64 64-28.7 64-64 64z" fill="#FCD4B3"></path><path d="M840.4 304H183.6c-17.7 0-32 14.3-32 32v552c0 17.7 14.3 32 32 32h656.8c17.7 0 32-14.3 32-32V336c0-17.7-14.3-32-32-32z m-32 552H215.6V368h624.8v488z" fill="#F37666"></path><path d="M512 128c-112.5 0-204 91.5-204 204s91.5 204 204 204 204-91.5 204-204-91.5-204-204-204z m0 384c-99.4 0-180-80.6-180-180s80.6-180 180-180 180 80.6 180 180-80.6 180-180 180z" fill="#F37666"></path><path d="M512 456c-35.3 0-64 28.7-64 64s28.7 64 64 64 64 28.7 64 64-28.7-64-64-64z m16.4 76.4c-2.3 2.3-5.4 3.6-8.5 3.6h-15.8c-3.1 0-6.2-1.3-8.5-3.6s-3.6-5.4-3.6-8.5v-27.8c0-6.6 5.4-12 12-12h16c6.6 0 12 5.4 12 12v27.8c0.1 3.1-1.2 6.2-3.5 8.5z" fill="#F37666"></path></svg><div class="red-packet-text"><div>${packet.message || '恭喜发财，大吉大利！'}</div><div>领取红包</div></div></div><div class="red-packet-footer">AI红包</div></div>`;
                    } else {
                        contentHtml = `<div class="message-content">${msg.content.replace(/\n/g, '<br>')}</div>`;
                    }
                    let avatarContent = '';
                    if (msg.role === 'user') {
                        avatarContent = userProfile.avatar ? `<img src="${userProfile.avatar}">` : (userProfile.name[0] || '我');
                    } else {
                        const sender = contacts.find(c => c.id === msg.senderId);
                        avatarContent = sender ? (sender.avatar ? `<img src="${sender.avatar}">` : sender.name[0]) : '?';
                    }
                    if (currentContact.type === 'group' && msg.role !== 'user') {
                        const sender = contacts.find(c => c.id === msg.senderId);
                        const senderName = sender ? sender.name : '未知';
                        msgDiv.innerHTML = `<div class="message-avatar">${avatarContent}</div><div class="message-bubble"><div class="group-message-header"><div class="group-message-name">${senderName}</div><div class="group-message-time">${formatTime(msg.time)}</div></div>${contentHtml}</div>`;
                    } else {
                        msgDiv.innerHTML = `<div class="message-avatar">${avatarContent}</div><div class="message-bubble">${contentHtml}</div>`;
                    }
                }
                chatMessages.appendChild(msgDiv);
            });
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function getGroupMembersText() {
            if (!currentContact || currentContact.type !== 'group') return '';
            return currentContact.members.map(id => contacts.find(c => c.id === id)?.name || '未知').join('、');
        }

        function sendUserMessage() {
            if (!currentContact) return;
            const input = document.getElementById('chatInput');
            const content = input.value.trim();
            if (!content) return;
            const userMessage = { role: 'user', content, type: 'text', time: new Date(), senderId: 'user' };
            currentContact.messages.push(userMessage);
            currentContact.lastMessage = content;
            currentContact.lastTime = formatTime(new Date());
            input.value = '';
            input.style.height = 'auto';
            renderMessages();
            renderContactList();
            saveToStorage();
            input.focus();
        }

        async function sendMessage() {
            if (!currentContact) return;
            const input = document.getElementById('chatInput');
            const content = input.value.trim();
            if (content) sendUserMessage();
            if (!apiSettings.url || !apiSettings.key || !apiSettings.model) { showToast('请先设置API'); return; }
            if (currentContact.messages.length === 0) return;
            const sendBtn = document.getElementById('sendBtn');
            sendBtn.disabled = true;
            try {
                if (currentContact.type === 'group') {
                    await sendGroupMessage();
                } else {
                    showTypingIndicator();
                    const { replies, newMemoryTable } = await callAPI(currentContact);
                    hideTypingIndicator();
                    if (newMemoryTable) {
                        currentContact.memoryTableContent = newMemoryTable;
                        saveToStorage();
                    }
                    if (!replies || replies.length === 0) { showTopNotification('AI没有返回有效回复'); return; }
                    for (const response of replies) {
                        await new Promise(resolve => setTimeout(resolve, 300 + Math.random() * 800));
                        const aiMessage = { role: 'assistant', content: response.content, type: response.type, time: new Date(), senderId: currentContact.id };
                        currentContact.messages.push(aiMessage);
                        currentContact.lastMessage = response.type === 'text' ? response.content.substring(0, 20) + '...' : (response.type === 'emoji' ? '[表情]' : '[红包]');
                        currentContact.lastTime = formatTime(new Date());
                        renderMessages();
                        renderContactList();
                        saveToStorage();
                    }
                }
            } catch (error) {
                console.error('发送消息错误:', error);
                showToast('发送失败：' + error.message);
                hideTypingIndicator();
            } finally {
                sendBtn.disabled = false;
            }
        }

        async function sendGroupMessage() {
            if (!currentContact || currentContact.type !== 'group') return;
            let turnContext = []; 
            for (const memberId of currentContact.members) {
                const member = contacts.find(c => c.id === memberId);
                if (!member || member.type === 'group') continue;
                showTypingIndicator(member);
                try {
                    const { replies, newMemoryTable } = await callAPI(member, turnContext);
                    hideTypingIndicator();
                    if (newMemoryTable) {
                        currentContact.memoryTableContent = newMemoryTable;
                        saveToStorage();
                    }
                    if (!replies || replies.length === 0) continue;
                    for (const response of replies) {
                        await new Promise(resolve => setTimeout(resolve, 300 + Math.random() * 800));
                        const aiMessage = { role: 'assistant', content: response.content, type: response.type, time: new Date(), senderId: member.id };
                        currentContact.messages.push(aiMessage);
                        turnContext.push(aiMessage);
                        currentContact.lastMessage = `${member.name}: ${response.type === 'text' ? response.content.substring(0, 15) + '...' : '[表情]'}`;
                        currentContact.lastTime = formatTime(new Date());
                        renderMessages();
                        renderContactList();
                        saveToStorage();
                    }
                } catch (error) {
                    console.error(`Error getting response from ${member.name}:`, error);
                    hideTypingIndicator();
                }
            }
        }

        function showTypingIndicator(contact = null) {
            const chatMessages = document.getElementById('chatMessages');
            let indicator = document.getElementById('typingIndicator');
            if (indicator) indicator.remove();
            indicator = document.createElement('div');
            indicator.className = 'message received';
            indicator.id = 'typingIndicator';
            chatMessages.appendChild(indicator);
            const displayContact = contact || currentContact;
            let avatarContent = displayContact ? (displayContact.avatar ? `<img src="${displayContact.avatar}">` : displayContact.name[0]) : '';
            indicator.innerHTML = `<div class="message-avatar">${avatarContent}</div><div class="message-bubble"><div class="typing-indicator"><div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div></div></div>`;
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function hideTypingIndicator() {
            const indicator = document.getElementById('typingIndicator');
            if (indicator) indicator.remove();
        }

        async function callAPI(contact, turnContext = []) {
            try {
                const memoryInfo = (currentContact.memoryTableContent || '').trim();
                let systemPrompt = `你必须严格遵守以下设定和记忆，这是最高优先级指令，在任何情况下都不能违背：\n\n--- 记忆表格 ---\n${memoryInfo}\n--- 结束 ---\n\n`;

                if (currentContact.type === 'group') {
                    const memberNames = currentContact.members.map(id => contacts.find(c => c.id === id)?.name || '未知成员');
                    systemPrompt += `你是群成员之一：${contact.name}，你的人设是：${contact.personality}。\n用户的名字是${userProfile.name}。\n` +
                        `你现在在一个名为“${currentContact.name}”的群聊中。群成员有：${userProfile.name} (用户), ${memberNames.join(', ')}。\n` +
                        `你的任务是根据自己的人设和记忆表格，对**本回合**中在你之前其他人的**完整发言**进行回应，然后发表你自己的**完整观点**，以推动群聊进行。可以赞同、反驳、开玩笑、或者提出新的话题。\n` +
                        `你的发言需要自然地融入对话，就像一个真正在参与群聊的人。`;
                } else {
                    systemPrompt += `你是${contact.name}，你的人设是：${contact.personality}。\n用户的名字是${userProfile.name}。\n` +
                        `你必须根据你的人设、记忆表格、用户的性格和当前对话内容来回复。`;
                }

                if (contact.customPrompts) systemPrompt += '\n\n' + contact.customPrompts;
                if (window.currentMusicInfo && window.currentMusicInfo.isPlaying) systemPrompt += `\n\n[系统提示：用户正在听歌，当前歌曲是《${window.currentMusicInfo.songName}》，正在播放的歌词是："${window.currentMusicInfo.lyric}"]`;
                systemPrompt += `\n\n--- 红包功能 ---\n当用户给你发红包时，你会看到这样的提示: "[用户发送了一个金额为XX的红包，留言是：XXX]"。\n你必须根据你的人设对此作出回应。例如，如果你是财迷，就表现得非常兴奋；如果你很高冷，就简单道谢。你的回应要自然，符合对话情景。`;
                
                const availableEmojisString = emojis.map(e => `- [emoji:${e.url}] (含义: ${e.meaning})`).join('\n');
                systemPrompt += `\n\n--- 至关重要的输出格式规则 ---\n你的回复必须严格遵守以下顺序和格式，由两部分组成：\n1.  **聊天内容**: 你的对话回复。为了模拟真实聊天，你必须将完整的回复拆分成多个（3到8条）独立的短消息（气泡）。每条消息应尽量简短（例如30字以内）。你必须使用“|||”作为每条短消息之间的唯一分隔符。\n2.  **更新后的记忆表格**: 在所有聊天内容和分隔符之后，你必须提供完整、更新后的记忆表格。整个表格的Markdown内容必须被 <memory_table>...</memory_table> 标签包裹。这不是可选项，而是必须执行的指令。你必须根据本轮最新对话更新表格。如果没有任何信息需要新增或修改，则原样返回上一次的表格。未能按此格式返回表格将导致系统错误。`;
                
                systemPrompt += `\n\n--- 表情包使用规则 ---\n`
                             + `你可以从下面的列表中选择表情包来丰富你的表达。\n`
                             + `要发送表情包，你必须严格使用以下格式，并将其作为一条独立的消息（即前后都有 ||| 分隔符，或者在回复的开头/结尾）：\n`
                             + `[emoji:图片URL]\n`
                             + `例如: 你好呀|||[emoji:https://example.com/happy.gif]|||今天天气真不错\n`
                             + `**重要提醒：** 你可能会在用户的消息历史中看到 "[发送了表情：...]" 这样的文字，这是系统为了让你理解对话而生成的提示，你绝对不能在你的回复中模仿或使用这种格式。你只能使用 [emoji:图片URL] 格式来发送表情。\n\n`
                             + `可用表情列表:\n${availableEmojisString || '无可用表情'}`;
                
                const messages = [{ role: 'system', content: systemPrompt }];
                const recentMessages = currentContact.messages.slice(-apiSettings.contextMessageCount);
                recentMessages.forEach(msg => {
                    const senderName = msg.role === 'user' ? userProfile.name : contacts.find(c => c.id === msg.senderId)?.name || contact.name;
                    let content = '';
                    if (msg.type === 'text') content = msg.content;
                    else if (msg.type === 'emoji') content = `[发送了表情：${emojis.find(e => e.url === msg.content)?.meaning || '未知'}]`;
                    else if (msg.type === 'red_packet') { try { const p = JSON.parse(msg.content); messages.push({ role: 'system', content: `[${senderName}发送了一个金额为${p.amount}的红包，留言是：${p.message}]` }); } catch(e){} return; }
                    messages.push({ role: msg.role, content: currentContact.type === 'group' ? `${senderName}: ${content}` : content });
                });

                if (turnContext.length > 0) {
                    messages.push({role: 'system', content: '--- 以下是本回合刚刚发生的对话 ---'});
                    turnContext.forEach(msg => {
                         const senderName = contacts.find(c => c.id === msg.senderId)?.name || '未知成员';
                         let content = msg.type === 'text' ? msg.content : `[发送了表情：${emojis.find(e => e.url === msg.content)?.meaning || '未知'}]`;
                         messages.push({ role: msg.role, content: `${senderName}: ${content}` });
                    });
                     messages.push({role: 'system', content: '--- 请针对以上最新对话进行回应 ---'});
                }

                const requestBody = { model: apiSettings.model, messages, temperature: 0.85, max_tokens: 2048 };
                
                const response = await fetch(`/proxy/v1/chat/completions`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiSettings.key}`,
                        'X-Target-URL': apiSettings.url
                    },
                    body: JSON.stringify(requestBody)
                });
                
                if (!response.ok) {
                    const errorBody = await response.text();
                    throw new Error(`API错误: ${response.status} - ${errorBody}`);
                }
                
                const data = await response.json();
                let fullResponseText = data.choices[0].message.content;
                
                const memoryTableRegex = /<memory_table>([\s\S]*?)<\/memory_table>/;
                const memoryMatch = fullResponseText.match(memoryTableRegex);
                let newMemoryTable = null;
                if (memoryMatch && memoryMatch[1]) {
                    newMemoryTable = memoryMatch[1].trim();
                    fullResponseText = fullResponseText.replace(memoryTableRegex, '').trim();
                } else {
                    console.warn("AI回复中未找到<memory_table>。");
                }
                
                let chatRepliesText = fullResponseText;

                if (currentContact.type === 'private' && !chatRepliesText.includes('|||')) {
                    const sentences = chatRepliesText.split(/[。！？\n]+/).filter(s => s.trim());
                    if (sentences.length > 1) chatRepliesText = sentences.join('|||');
                }
                
                const replies = chatRepliesText.split('|||').map(r => r.trim()).filter(r => r);
                const processedReplies = [];
                
                const emojiUrlRegex = /^\[emoji:((?:https?|blob):[^\]]+)\]$/;
                for (const reply of replies) {
                    const emojiMatch = reply.match(emojiUrlRegex);
                    if (emojiMatch) {
                        const url = emojiMatch[1];
                        processedReplies.push({ type: 'emoji', content: url });
                    } else {
                        processedReplies.push({ type: 'text', content: reply });
                    }
                }
                
                return { replies: processedReplies, newMemoryTable };

            } catch (error) {
                console.error("API Call Error:", error);
                showToast("API 调用失败: " + error.message);
                throw error;
            }
        }

        async function testApiConnection() {
            const url = document.getElementById('apiUrl').value;
            const key = document.getElementById('apiKey').value;
            if (!url || !key) { showToast('请填写完整信息'); return; }
            
            const modelList = document.getElementById('modelList');
            modelList.innerHTML = '<div class="loading-text">连接中...</div>';
            
            try {
                const response = await fetch(`/proxy/v1/models`, {
                    headers: {
                        'Authorization': `Bearer ${key}`,
                        'X-Target-URL': url
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`连接失败: ${response.status}`);
                }
                
                const data = await response.json();
                const models = data.data || [];
                
                if (models.length === 0) {
                    modelList.innerHTML = '<div class="loading-text">连接成功，但未找到可用模型。</div>';
                    showToast('连接成功，但未找到模型');
                    return;
                }

                modelList.innerHTML = '';
                models.forEach(model => {
                    const item = document.createElement('div');
                    item.className = 'model-item';
                    if (model.id === apiSettings.model) item.classList.add('selected');
                    item.textContent = model.id;
                    item.onclick = () => {
                        document.querySelectorAll('.model-item').forEach(i => i.classList.remove('selected'));
                        item.classList.add('selected');
                        apiSettings.model = model.id;
                    };
                    modelList.appendChild(item);
                });
                
                showToast('连接成功');
            } catch (error) {
                modelList.innerHTML = '<div class="loading-text">连接失败，请检查URL和Key</div>';
                showToast(error.message);
            }
        }

        function saveApiSettings(event) {
            event.preventDefault();
            apiSettings.url = document.getElementById('apiUrl').value;
            apiSettings.key = document.getElementById('apiKey').value;
            apiSettings.contextMessageCount = parseInt(document.getElementById('contextSlider').value);
            saveToStorage();
            closeModal('apiSettingsModal');
            updateContextIndicator();
            showToast('设置已保存');
        }

        function setBackground(event) {
            event.preventDefault();
            if (!currentContact) return;
            const url = document.getElementById('backgroundUrl').value;
            if (url) backgrounds[currentContact.id] = url;
            else delete backgrounds[currentContact.id];
            saveToStorage();
            openChat(currentContact);
            closeModal('backgroundModal');
            showToast('背景设置成功');
        }

        function addEmoji(event) {
            event.preventDefault();
            const emoji = { id: Date.now().toString(), url: document.getElementById('emojiUrl').value, meaning: document.getElementById('emojiMeaning').value };
            emojis.push(emoji);
            saveToStorage();
            renderEmojiGrid();
            closeModal('addEmojiModal');
            showToast('表情添加成功');
            event.target.reset();
        }

        function deleteEmoji(emojiId) {
            if (confirm('确定要删除这个表情吗？')) {
                emojis = emojis.filter(e => e.id !== emojiId);
                saveToStorage();
                renderEmojiGrid();
                showToast('表情已删除');
            }
        }

        function renderEmojiGrid() {
            const grid = document.getElementById('emojiGrid');
            grid.innerHTML = '';
            emojis.forEach(emoji => {
                const item = document.createElement('div');
                item.className = 'emoji-item';
                item.innerHTML = `<img src="${emoji.url}"><div class="emoji-delete-btn" onclick="event.stopPropagation(); deleteEmoji('${emoji.id}')">×</div>`;
                item.onclick = () => sendEmoji(emoji);
                grid.appendChild(item);
            });
            const addBtn = document.createElement('div');
            addBtn.className = 'add-emoji-btn';
            addBtn.textContent = '+ 添加表情';
            addBtn.onclick = showAddEmojiModal;
            grid.appendChild(addBtn);
        }
        
        async function sendRedPacket(event) {
            event.preventDefault();
            if (!currentContact) return;
            const amount = document.getElementById('redPacketAmount').value;
            const message = document.getElementById('redPacketMessage').value || '恭喜发财，大吉大利！';
            if (amount <= 0) { showToast('红包金额必须大于0'); return; }
            const packetData = { amount: parseFloat(amount).toFixed(2), message };
            const packetMessage = { role: 'user', content: JSON.stringify(packetData), type: 'red_packet', time: new Date(), senderId: 'user' };
            currentContact.messages.push(packetMessage);
            currentContact.lastMessage = '[红包]';
            currentContact.lastTime = formatTime(new Date());
            renderMessages();
            renderContactList();
            saveToStorage();
            closeModal('redPacketModal');
            await sendMessage();
        }

        async function sendEmoji(emoji) {
            if (!currentContact) return;
            currentContact.messages.push({ role: 'user', content: emoji.url, type: 'emoji', time: new Date(), senderId: 'user' });
            currentContact.lastMessage = '[表情]';
            currentContact.lastTime = formatTime(new Date());
            renderMessages();
            renderContactList();
            saveToStorage();
            toggleEmojiPanel(true);
            if (!apiSettings.url || !apiSettings.key || !apiSettings.model) { showToast('请先设置API'); return; }
            showTypingIndicator();
            try {
                const { replies, newMemoryTable } = await callAPI(currentContact);
                hideTypingIndicator();
                if (newMemoryTable) {
                    currentContact.memoryTableContent = newMemoryTable;
                    saveToStorage();
                }
                if (!replies || replies.length === 0) { showTopNotification('AI没有返回有效回复'); return; }
                for (const response of replies) {
                    await new Promise(resolve => setTimeout(resolve, 300 + Math.random() * 800));
                    const aiMessage = { role: 'assistant', content: response.content, type: response.type, time: new Date(), senderId: currentContact.id };
                    currentContact.messages.push(aiMessage);
                    currentContact.lastMessage = response.type === 'text' ? response.content.substring(0, 20) + '...' : '[表情]';
                    currentContact.lastTime = formatTime(new Date());
                    renderMessages();
                    renderContactList();
                    saveToStorage();
                }
            } catch (error) {
                hideTypingIndicator();
                console.error('AI回复错误:', error);
                showToast('AI回复失败');
            }
        }

        function toggleEmojiPanel(forceClose = false) {
            const panel = document.getElementById('emojiPanel');
            panel.style.display = forceClose ? 'none' : (panel.style.display === 'block' ? 'none' : 'block');
        }

        function toggleSettingsMenu(forceClose = false) {
            const menu = document.getElementById('settingsMenu');
            menu.style.display = forceClose ? 'none' : (menu.style.display === 'block' ? 'none' : 'block');
        }

        function toggleMemoryPanel(forceClose = false) {
            const panel = document.getElementById('memoryPanel');
            const isActive = panel.classList.contains('active');
            if (forceClose) { panel.classList.remove('active'); return; }
            if (isActive) {
                panel.classList.remove('active');
            } else {
                if (currentContact) {
                    const memoryTextarea = document.getElementById('memoryTextarea');
                    memoryTextarea.value = currentContact.memoryTableContent || defaultMemoryTable;
                    renderMemoryTable(memoryTextarea.value);
                    document.getElementById('memoryTableView').style.display = 'block';
                    memoryTextarea.style.display = 'none';
                    document.getElementById('memoryEditBtn').textContent = '编辑';
                    panel.classList.add('active');
                } else {
                    showToast('请先选择一个聊天');
                }
            }
        }
        
        function toggleMemoryEditMode() {
            const editBtn = document.getElementById('memoryEditBtn');
            const viewDiv = document.getElementById('memoryTableView');
            const editArea = document.getElementById('memoryTextarea');
            if (editBtn.textContent === '编辑') {
                viewDiv.style.display = 'none';
                editArea.style.display = 'block';
                editArea.value = currentContact.memoryTableContent || defaultMemoryTable;
                editArea.focus();
                editBtn.textContent = '保存';
            } else {
                currentContact.memoryTableContent = editArea.value;
                saveToStorage();
                renderMemoryTable(currentContact.memoryTableContent);
                viewDiv.style.display = 'block';
                editArea.style.display = 'none';
                editBtn.textContent = '编辑';
                showToast('记忆已保存');
            }
        }

        function renderMemoryTable(markdown) {
            const viewDiv = document.getElementById('memoryTableView');
            viewDiv.innerHTML = markdown ? marked.parse(markdown) : '<p>暂无内容。点击“编辑”添加记忆。</p>';
        }

        function clearMessages() {
            if (!currentContact) return;
            if (confirm('确定要清空聊天记录吗？')) {
                currentContact.messages = [];
                currentContact.lastMessage = '暂无消息';
                currentContact.lastTime = formatTime(new Date());
                renderMessages();
                renderContactList();
                saveToStorage();
                showToast('已清空');
            }
            toggleSettingsMenu();
        }

        function formatTime(date) {
            const now = new Date();
            const d = new Date(date);
            if (isNaN(d.getTime())) return '';
            const diff = now - d;
            if (diff < 60000) return '刚刚';
            if (diff < 3600000) return Math.floor(diff / 60000) + '分钟前';
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const messageDate = new Date(d.getFullYear(), d.getMonth(), d.getDate());
            if (today.getTime() === messageDate.getTime()) {
                 const hours = d.getHours();
                 const minutes = d.getMinutes();
                 return `${hours}:${minutes < 10 ? '0' + minutes : minutes}`;
            }
            return `${d.getMonth() + 1}月${d.getDate()}日`;
        }

        function generateRandomComments(momentContent = '') { return []; }

        function exportData() {
            const allData = { contacts, apiSettings, emojis, backgrounds, userProfile, moments, version: '1.3.0', timestamp: new Date().toISOString() };
            const blob = new Blob([JSON.stringify(allData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `ai-chat-data-${new Date().toISOString().slice(0, 10)}.json`;
            document.body.appendChild(a);
            a.click();
            setTimeout(() => { document.body.removeChild(a); URL.revokeObjectURL(url); showToast('数据导出成功'); }, 100);
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    if (!data.contacts || !data.apiSettings || !data.userProfile) throw new Error('无效的数据格式');
                    contacts = data.contacts;
                    apiSettings = data.apiSettings;
                    emojis = data.emojis || [];
                    backgrounds = data.backgrounds || {};
                    userProfile = data.userProfile;
                    moments = data.moments || [];
                    if (apiSettings.contextMessageCount === undefined) apiSettings.contextMessageCount = 10;
                    contacts.forEach(contact => {
                        if (contact.type === undefined) contact.type = 'private';
                        if (contact.memoryTableContent === undefined) contact.memoryTableContent = defaultMemoryTable;
                        if (contact.messages) {
                            contact.messages.forEach(msg => {
                                if (msg.role === 'user' && msg.senderId === undefined) msg.senderId = 'user';
                                else if (msg.role === 'assistant' && msg.senderId === undefined) msg.senderId = contact.id;
                            });
                        }
                    });
                    saveToStorage();
                    document.getElementById('contactList').innerHTML = '';
                    document.getElementById('chatPage').classList.remove('active');
                    currentContact = null;
                    init(); 
                    showToast('数据导入成功，应用已刷新');
                } catch (error) {
                    console.error('导入数据失败:', error);
                    showToast('导入失败：数据格式错误');
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        document.getElementById('chatInput').addEventListener('keypress', (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendUserMessage(); } });
        document.addEventListener('click', (e) => {
            const settingsMenu = document.getElementById('settingsMenu');
            if (settingsMenu && !settingsMenu.contains(e.target) && !e.target.closest('.chat-more')) {
                settingsMenu.style.display = 'none';
            }
        });

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
